---
import Layout from "../../layouts/Layout.astro";
import { supabase } from "../../lib/supabase";

// === 1. AUTENTICACI√ìN SERVIDOR (El Puente) ===
// Recuperamos las cookies que guard√≥ el Login
const accessToken = Astro.cookies.get("sb-access-token")?.value;
const refreshToken = Astro.cookies.get("sb-refresh-token")?.value;

// Si existen, se las damos a Supabase para que sepa que somos nosotros
if (accessToken && refreshToken) {
  await supabase.auth.setSession({
    access_token: accessToken,
    refresh_token: refreshToken,
  });
}
// ============================================

// Obtener todas las citas ordenadas por fecha
// (Ahora Supabase S√ç devolver√° datos porque ya tiene la sesi√≥n)
const { data: appointments } = await supabase
  .from("appointments")
  .select(
    `
    *,
    services (name, duration, price),
    businesses (name)
  `
  )
  .order("appointment_date", { ascending: true })
  .order("appointment_time", { ascending: true });

// Contar por estado
const pending = appointments?.filter((a) => a.status === "pending").length || 0;
const confirmed = appointments?.filter((a) => a.status === "confirmed").length || 0;
const cancelled = appointments?.filter((a) => a.status === "cancelled").length || 0;
const completed = appointments?.filter((a) => a.status === 'completed').length || 0;
---

<Layout title="Admin Panel - Gesti√≥n de Citas">
  <!-- Ocultamos el cuerpo inicialmente -->
  <div id="main-content" class="min-h-screen bg-gray-100 py-8 hidden">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      
      <!-- Header -->
      <div class="bg-white rounded-lg shadow p-6 mb-6">
        <!-- flex-col en m√≥vil (columna), md:flex-row en escritorio (fila) -->
        <div class="flex flex-col md:flex-row justify-between items-center gap-4">
          
          <!-- T√≠tulo y Texto -->
          <div class="text-center md:text-left w-full md:w-auto">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-900">
              Panel de Administraci√≥n
            </h1>
            <p class="text-gray-600 mt-1">Gesti√≥n de citas y clientes</p>
          </div>
          
          <!-- Botones -->
          <!--Ancho completo en m√≥vil, botones apilados o flexibles -->
          <div class="flex flex-col sm:flex-row gap-3 w-full md:w-auto">
            <a
                href="/"
                class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 flex items-center justify-center text-center transition-colors"
            >
                ‚Üê Volver al sitio
            </a>
            
            <button
                id="logout-btn"
                class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 flex items-center justify-center gap-2 text-center transition-colors"
            >
                üö™ Cerrar Sesi√≥n
            </button>
          </div>
        </div>
      </div>

      <!-- Stats Cards -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
        <div class="bg-white rounded-lg shadow p-6">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-600 text-sm">Total Citas</p>
              <p class="text-3xl font-bold text-gray-900">{appointments?.length || 0}</p>
            </div>
            <div class="bg-blue-100 p-3 rounded-full"><span class="text-2xl text-blue-600">üìÖ</span></div>
          </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-600 text-sm">Pendientes</p>
              <p class="text-3xl font-bold text-yellow-600">{pending}</p>
            </div>
            <div class="bg-yellow-100 p-3 rounded-full"><span class="text-2xl text-yellow-600">‚è≥</span></div>
          </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-600 text-sm">Confirmadas</p>
              <p class="text-3xl font-bold text-green-600">{confirmed}</p>
            </div>
            <div class="bg-green-100 p-3 rounded-full"><span class="text-2xl text-green-600">‚úì</span></div>
          </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-600 text-sm">Canceladas</p>
              <p class="text-3xl font-bold text-red-600">{cancelled}</p>
            </div>
            <div class="bg-red-100 p-3 rounded-full"><span class="text-2xl text-red-600">‚úó</span></div>
          </div>
        </div>
        
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-600 text-sm">Completadas</p>
                <p class="text-3xl font-bold text-blue-600">{completed}</p>
            </div>
            <div class="bg-blue-100 p-3 rounded-full"><span class="text-2xl text-blue-600">‚úÖ</span></div>
            </div>
        </div>
      </div>

      <!-- Tabla de Citas -->
      <div class="bg-white rounded-lg shadow overflow-hidden">
        <div class="p-6 border-b border-gray-200">
          <h2 class="text-xl font-bold text-gray-900">Todas las Citas</h2>
        </div>

        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha/Hora</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contacto</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Servicio</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              {
                appointments &&
                  appointments.map((apt) => (
                    <tr class="hover:bg-gray-50">
                      <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">
                          {new Date(apt.appointment_date).toLocaleDateString("es-CO")}
                        </div>
                        <div class="text-sm text-gray-500">{apt.appointment_time}</div>
                      </td>
                      <td class="px-6 py-4">
                        <div class="text-sm font-medium text-gray-900">{apt.customer_name}</div>
                      </td>
                      <td class="px-6 py-4">
                        <div class="text-sm text-gray-900">üìû {apt.customer_phone}</div>
                        {apt.customer_email && <div class="text-sm text-gray-500">üìß {apt.customer_email}</div>}
                      </td>
                      <td class="px-6 py-4">
                        <div class="text-sm text-gray-900">{apt.services?.name || "N/A"}</div>
                        <div class="text-sm text-gray-500">{apt.services?.duration || 0} min</div>
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap">
                        <span class={`px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${
                          apt.status === "pending" ? "bg-yellow-100 text-yellow-800" : 
                          apt.status === "confirmed" ? "bg-green-100 text-green-800" : 
                          apt.status === "completed" ? "bg-blue-100 text-blue-800" : 
                          "bg-red-100 text-red-800"
                        }`}>
                          {apt.status === "pending" ? "Pendiente" : 
                           apt.status === "confirmed" ? "Confirmada" : 
                           apt.status === "completed" ? "Completada" : "Cancelada"}
                        </span>
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm">
                        {apt.status === "pending" && (
                          <>
                            <button data-id={apt.id} data-action="confirm" class="text-green-600 hover:text-green-900 mr-3 font-medium">‚úì Confirmar</button>
                            <button data-id={apt.id} data-action="cancel" class="text-red-600 hover:text-red-900 font-medium">‚úó Cancelar</button>
                          </>
                        )}
                        {apt.status === "confirmed" && (
                          <>
                            <button data-id={apt.id} data-action="complete" class="text-blue-600 hover:text-blue-900 mr-3 font-medium">‚úÖ Completar</button>
                            <button data-id={apt.id} data-action="cancel" class="text-red-600 hover:text-red-900 font-medium">‚úó Cancelar</button>
                          </>
                        )}
                        {apt.status === "completed" && <span class="text-gray-500 italic">Completada ‚úì</span>}
                        {apt.status === "cancelled" && <span class="text-gray-500 italic">Cancelada ‚úó</span>}
                      </td>
                    </tr>
                  ))
              }
            </tbody>
          </table>
          {!appointments || (appointments.length === 0 && (
            <div class="text-center py-12"><p class="text-gray-500">No hay citas registradas a√∫n</p></div>
          ))}
        </div>
      </div>
    </div>
  </div>
</Layout>

<script>
  import { supabase } from "../../lib/supabase";

  // === PROTECCI√ìN DE CLIENTE ===
  async function checkAuth() {
    const { data: { session } } = await supabase.auth.getSession();
    
    if (!session) {
        window.location.href = '/admin/login';
    } else {
        const content = document.getElementById('main-content');
        if (content) content.classList.remove('hidden');
    }
  }
  checkAuth();

  // === GESTI√ìN DE CITAS ===
  document.addEventListener("click", async (e) => {
    const target = e.target as HTMLElement;

    if (target.dataset.action) {
      const id = target.dataset.id;
      const action = target.dataset.action;

      const messages = {
        confirm: "¬øConfirmar esta cita?",
        cancel: "¬øCancelar esta cita?",
        complete: "¬øMarcar como completada?",
      };

      // @ts-ignore
      if (!confirm(messages[action])) return;

      const statusMap = {
        confirm: "confirmed",
        cancel: "cancelled",
        complete: "completed",
      };

      // @ts-ignore
      const newStatus = statusMap[action];

      const { error } = await supabase
        .from("appointments")
        .update({ status: newStatus }) 
        .eq("id", id); 

      if (error) alert("Error: " + error.message);
      else window.location.reload();
    }
  });

  // === CERRAR SESI√ìN ===
  const logoutBtn = document.getElementById('logout-btn');
  if (logoutBtn) {
    logoutBtn.addEventListener('click', async () => {
        if(confirm('¬øSeguro que quieres cerrar sesi√≥n?')) {
            await supabase.auth.signOut();
            // Borramos cookies para que el servidor tambi√©n sepa que salimos
            document.cookie = "sb-access-token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT";
            document.cookie = "sb-refresh-token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT";
            window.location.href = '/admin/login';
        }
    });
  }
</script>