---
import Layout from "../../layouts/Layout.astro";
import { supabase } from "../../lib/supabase";

// === 1. AUTENTICACI√ìN SERVIDOR (El Puente) ===
// Recuperamos las cookies que guard√≥ el Login
const accessToken = Astro.cookies.get("sb-access-token")?.value;
const refreshToken = Astro.cookies.get("sb-refresh-token")?.value;

// Si existen, se las damos a Supabase para que sepa que somos nosotros
if (accessToken && refreshToken) {
  await supabase.auth.setSession({
    access_token: accessToken,
    refresh_token: refreshToken,
  });
}
// ============================================

// Obtener todas las citas ordenadas por fecha
// (Ahora Supabase S√ç devolver√° datos porque ya tiene la sesi√≥n)
const { data: appointments } = await supabase
  .from("appointments")
  .select(
    `
    *,
    services (name, duration, price),
    businesses (name)
  `
  )
  .order("appointment_date", { ascending: true })
  .order("appointment_time", { ascending: true });

// Contar por estado
const pending = appointments?.filter((a) => a.status === "pending").length || 0;
const confirmed =
  appointments?.filter((a) => a.status === "confirmed").length || 0;
const cancelled =
  appointments?.filter((a) => a.status === "cancelled").length || 0;
const completed =
  appointments?.filter((a) => a.status === "completed").length || 0;
---

<Layout title="Admin Panel - Gesti√≥n de Citas">
  <!-- Ocultamos el cuerpo inicialmente -->
  <div id="main-content" class="min-h-screen bg-gray-100 py-8 hidden">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <!-- Header -->
      <div class="bg-white rounded-lg shadow p-6 mb-6">
        <!-- flex-col en m√≥vil (columna), md:flex-row en escritorio (fila) -->
        <div
          class="flex flex-col md:flex-row justify-between items-center gap-4"
        >
          <!-- T√≠tulo y Texto -->
          <div class="text-center md:text-left w-full md:w-auto">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-900">
              Panel de Administraci√≥n
            </h1>
            <p class="text-gray-600 mt-1">Gesti√≥n de citas y clientes</p>
          </div>

          <!-- Botones -->
          <!--Ancho completo en m√≥vil, botones apilados o flexibles -->
          <div class="flex flex-col sm:flex-row gap-3 w-full md:w-auto">
            <a
              href="/"
              class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 flex items-center justify-center text-center transition-colors"
            >
              ‚Üê Volver al sitio
            </a>

            <button
              id="logout-btn"
              class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 flex items-center justify-center gap-2 text-center transition-colors"
            >
              üö™ Cerrar Sesi√≥n
            </button>
          </div>
        </div>
      </div>

      <!-- Stats Cards -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
        <div class="bg-white rounded-lg shadow p-6">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-600 text-sm">Total Citas</p>
              <p class="text-3xl font-bold text-gray-900">
                {appointments?.length || 0}
              </p>
            </div>
            <div class="bg-blue-100 p-3 rounded-full">
              <span class="text-2xl text-blue-600">üìÖ</span>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-600 text-sm">Pendientes</p>
              <p class="text-3xl font-bold text-yellow-600">{pending}</p>
            </div>
            <div class="bg-yellow-100 p-3 rounded-full">
              <span class="text-2xl text-yellow-600">‚è≥</span>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-600 text-sm">Confirmadas</p>
              <p class="text-3xl font-bold text-green-600">{confirmed}</p>
            </div>
            <div class="bg-green-100 p-3 rounded-full">
              <span class="text-2xl text-green-600">‚úì</span>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-600 text-sm">Canceladas</p>
              <p class="text-3xl font-bold text-red-600">{cancelled}</p>
            </div>
            <div class="bg-red-100 p-3 rounded-full">
              <span class="text-2xl text-red-600">‚úó</span>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-600 text-sm">Completadas</p>
              <p class="text-3xl font-bold text-blue-600">{completed}</p>
            </div>
            <div class="bg-blue-100 p-3 rounded-full">
              <span class="text-2xl text-blue-600">‚úÖ</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Filtros y B√∫squeda -->
      <div class="bg-white rounded-lg shadow p-6 mb-6">
        <h2 class="text-lg font-bold text-gray-900 mb-4">Filtros</h2>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <!-- Filtro por fecha -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Fecha</label
            >
            <select id="filter-date" class="w-full px-4 py-2 border rounded-lg">
              <option value="all">Todas</option>
              <option value="today">Hoy</option>
              <option value="week">Esta semana</option>
              <option value="month">Este mes</option>
            </select>
          </div>

          <!-- Filtro por estado -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Estado</label
            >
            <select
              id="filter-status"
              class="w-full px-4 py-2 border rounded-lg"
            >
              <option value="all">Todos</option>
              <option value="pending">Pendientes</option>
              <option value="confirmed">Confirmadas</option>
              <option value="completed">Completadas</option>
              <option value="cancelled">Canceladas</option>
            </select>
          </div>

          <!-- B√∫squeda -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Buscar</label
            >
            <input
              type="text"
              id="search-input"
              placeholder="Nombre o tel√©fono..."
              class="w-full px-4 py-2 border rounded-lg"
            />
          </div>

          <!-- Botones de acci√≥n -->
          <div class="flex items-end gap-2">
            <button
              id="clear-filters"
              class="px-4 py-2 text-blue-600 hover:underline"
            >
              Limpiar
            </button>
            <button
              id="export-excel"
              class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
            >
              üìä Excel
            </button>
          </div>
        </div>
      </div>

      <!-- Tabla de Citas -->
      <div class="bg-white rounded-lg shadow overflow-hidden">
        <div class="p-6 border-b border-gray-200">
          <h2 class="text-xl font-bold text-gray-900">Todas las Citas</h2>
        </div>

        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gray-50">
              <tr>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >Fecha/Hora</th
                >
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >Cliente</th
                >
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >Contacto</th
                >
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >Servicio</th
                >
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >Estado</th
                >
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >Acciones</th
                >
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              {
                appointments &&
                  appointments.map((apt) => (
                    <tr class="hover:bg-gray-50">
                      <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">
                          {new Date(apt.appointment_date).toLocaleDateString(
                            "es-CO"
                          )}
                        </div>
                        <div class="text-sm text-gray-500">
                          {apt.appointment_time}
                        </div>
                      </td>
                      <td class="px-6 py-4">
                        <div class="text-sm font-medium text-gray-900">
                          {apt.customer_name}
                        </div>
                      </td>
                      <td class="px-6 py-4">
                        <div class="text-sm text-gray-900">
                          üìû {apt.customer_phone}
                        </div>
                        {apt.customer_email && (
                          <div class="text-sm text-gray-500">
                            üìß {apt.customer_email}
                          </div>
                        )}
                      </td>
                      <td class="px-6 py-4">
                        <div class="text-sm text-gray-900">
                          {apt.services?.name || "N/A"}
                        </div>
                        <div class="text-sm text-gray-500">
                          {apt.services?.duration || 0} min
                        </div>
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap">
                        <span
                          class={`px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${
                            apt.status === "pending"
                              ? "bg-yellow-100 text-yellow-800"
                              : apt.status === "confirmed"
                                ? "bg-green-100 text-green-800"
                                : apt.status === "completed"
                                  ? "bg-blue-100 text-blue-800"
                                  : "bg-red-100 text-red-800"
                          }`}
                        >
                          {apt.status === "pending"
                            ? "Pendiente"
                            : apt.status === "confirmed"
                              ? "Confirmada"
                              : apt.status === "completed"
                                ? "Completada"
                                : "Cancelada"}
                        </span>
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm">
                        {apt.status === "pending" && (
                          <>
                            <button
                              data-id={apt.id}
                              data-action="confirm"
                              class="text-green-600 hover:text-green-900 mr-3 font-medium"
                            >
                              ‚úì Confirmar
                            </button>
                            <button
                              data-id={apt.id}
                              data-action="cancel"
                              class="text-red-600 hover:text-red-900 font-medium"
                            >
                              ‚úó Cancelar
                            </button>
                          </>
                        )}
                        {apt.status === "confirmed" && (
                          <>
                            <button
                              data-id={apt.id}
                              data-action="complete"
                              class="text-blue-600 hover:text-blue-900 mr-3 font-medium"
                            >
                              ‚úÖ Completar
                            </button>
                            <button
                              data-id={apt.id}
                              data-action="cancel"
                              class="text-red-600 hover:text-red-900 font-medium"
                            >
                              ‚úó Cancelar
                            </button>
                          </>
                        )}
                        {apt.status === "completed" && (
                          <span class="text-gray-500 italic">Completada ‚úì</span>
                        )}
                        {apt.status === "cancelled" && (
                          <span class="text-gray-500 italic">Cancelada ‚úó</span>
                        )}
                      </td>
                    </tr>
                  ))
              }
            </tbody>
          </table>
          {
            !appointments ||
              (appointments.length === 0 && (
                <div class="text-center py-12">
                  <p class="text-gray-500">No hay citas registradas a√∫n</p>
                </div>
              ))
          }
        </div>
      </div>
    </div>
  </div>
</Layout>

<script>
  import { supabase } from "../../lib/supabase";

  // ==========================================
  // 1. PROTECCI√ìN DE RUTA (Cliente)
  // ==========================================
  // Esta funci√≥n verifica si hay una sesi√≥n activa
  async function checkAuth() {
    // Preguntamos a Supabase: "¬øHay alguien logueado?"
    const {
      data: { session },
    } = await supabase.auth.getSession();

    // Si NO hay sesi√≥n (nadie logueado)
    if (!session) {
      // Redirigir al login
      window.location.href = "/admin/login";
    } else {
      // Si HAY sesi√≥n, mostrar el contenido
      // (que estaba oculto con class="hidden")
      const content = document.getElementById("main-content");
      if (content) content.classList.remove("hidden");
    }
  }

  // Ejecutar la verificaci√≥n al cargar la p√°gina
  checkAuth();

  // ==========================================
  // 2. SISTEMA DE FILTROS
  // ==========================================

  // Obtenemos referencias a los elementos del DOM
  const filterDate = document.getElementById(
    "filter-date"
  ) as HTMLSelectElement;
  const filterStatus = document.getElementById(
    "filter-status"
  ) as HTMLSelectElement;
  const searchInput = document.getElementById(
    "search-input"
  ) as HTMLInputElement;
  const clearBtn = document.getElementById(
    "clear-filters"
  ) as HTMLButtonElement;
  const exportBtn = document.getElementById(
    "export-excel"
  ) as HTMLButtonElement;

  // Obtenemos TODAS las filas de la tabla
  const tableRows = document.querySelectorAll("tbody tr");

  // FUNCI√ìN: Aplicar filtros
  function applyFilters() {
    const dateValue = filterDate?.value || "all";
    const statusValue = filterStatus?.value || "all";
    const searchValue = searchInput?.value.toLowerCase().trim() || "";

    const today = new Date();
    today.setHours(0, 0, 0, 0);

    tableRows.forEach((row) => {
      let show = true;

      // ===== FILTRO POR FECHA (COMPLETAMENTE CORREGIDO) =====
      if (dateValue !== "all") {
        const dateCell =
          row.querySelector("td:first-child div:first-child")?.textContent ||
          "";
        const dateParts = dateCell.split("/");

        if (dateParts.length === 3) {
          const rowDate = new Date(
            parseInt(dateParts[2]), // a√±o
            parseInt(dateParts[1]) - 1, // mes (0-indexed)
            parseInt(dateParts[0]) // d√≠a
          );
          rowDate.setHours(0, 0, 0, 0);

          // ===== FILTRO: HOY =====
          if (dateValue === "today") {
            if (rowDate.getTime() !== today.getTime()) {
              show = false;
            }
          }

          // ===== FILTRO: ESTA SEMANA (Lunes a Domingo) =====
          if (dateValue === "week") {
            // Calcular inicio de semana (Lunes)
            const startOfWeek = new Date(today);
            const dayOfWeek = startOfWeek.getDay();
            // Si es domingo (0), retroceder 6 d√≠as; si no, ir al lunes anterior
            const daysToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
            startOfWeek.setDate(startOfWeek.getDate() + daysToMonday);
            startOfWeek.setHours(0, 0, 0, 0);

            // Calcular fin de semana (Domingo)
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(endOfWeek.getDate() + 6);
            endOfWeek.setHours(23, 59, 59, 999);

            // Mostrar solo si est√° entre lunes y domingo
            if (rowDate < startOfWeek || rowDate > endOfWeek) {
              show = false;
            }
          }

          // ===== FILTRO: ESTE MES (Todo el mes actual) =====
          if (dateValue === "month") {
            // Obtener a√±o y mes actual
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth();

            // Obtener a√±o y mes de la cita
            const rowYear = rowDate.getFullYear();
            const rowMonth = rowDate.getMonth();

            // Mostrar solo si es del mismo a√±o y mes
            if (rowYear !== currentYear || rowMonth !== currentMonth) {
              show = false;
            }
          }
        }
      }

      // ===== FILTRO POR ESTADO =====
      if (statusValue !== "all") {
        const statusBadge =
          row
            .querySelector("td:nth-child(5) span")
            ?.textContent?.toLowerCase() || "";
        const statusMap: { [key: string]: string } = {
          pending: "pendiente",
          confirmed: "confirmada",
          completed: "completada",
          cancelled: "cancelada",
        };

        if (!statusBadge.includes(statusMap[statusValue])) {
          show = false;
        }
      }

      // ===== B√öSQUEDA POR TEXTO =====
      if (searchValue) {
        const rowText = row.textContent?.toLowerCase() || "";
        if (!rowText.includes(searchValue)) {
          show = false;
        }
      }

      // Aplicar visibilidad
      (row as HTMLElement).style.display = show ? "" : "none";
    });
  }

  // Event Listeners para los filtros
  // Cuando cambia el select de fecha ‚Üí aplicar filtros
  filterDate?.addEventListener("change", applyFilters);

  // Cuando cambia el select de estado ‚Üí aplicar filtros
  filterStatus?.addEventListener("change", applyFilters);

  // Cuando escribe en el input de b√∫squeda ‚Üí aplicar filtros
  // 'input' se dispara MIENTRAS escribe (cada tecla)
  searchInput?.addEventListener("input", applyFilters);

  // Bot√≥n LIMPIAR FILTROS
  clearBtn?.addEventListener("click", () => {
    // Resetear valores de los filtros
    if (filterDate) filterDate.value = "all";
    if (filterStatus) filterStatus.value = "all";
    if (searchInput) searchInput.value = "";

    // Mostrar TODAS las filas de nuevo
    tableRows.forEach((row) => {
      (row as HTMLElement).style.display = "";
    });
  });

  // ==========================================
  // 3. EXPORTAR A EXCEL
  // ==========================================
  exportBtn?.addEventListener("click", () => {
    // Obtener solo las filas VISIBLES (no ocultas por filtros)
    const visibleRows = Array.from(
      document.querySelectorAll("tbody tr")
    ).filter((row) => (row as HTMLElement).style.display !== "none");

    // Convertir cada fila a formato CSV
    const csvRows = visibleRows.map((row) => {
      const cells = Array.from(row.querySelectorAll("td"));

      // Extraer datos de las primeras 5 columnas
      return [
        cells[0]?.textContent?.trim().replace(/\n/g, " ") || "", // Fecha/Hora
        cells[1]?.textContent?.trim() || "", // Cliente
        cells[2]?.textContent?.trim().replace(/\n/g, " ") || "", // Contacto
        cells[3]?.textContent?.trim().replace(/\n/g, " ") || "", // Servicio
        cells[4]?.textContent?.trim() || "", // Estado
      ].join(","); // Unir con comas
    });

    // Crear encabezados
    const headers = "Fecha/Hora,Cliente,Contacto,Servicio,Estado";

    // Unir todo (headers + datos)
    const csv = [headers, ...csvRows].join("\n");

    // Crear archivo Blob (binario)
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });

    // Crear URL temporal del archivo
    const url = window.URL.createObjectURL(blob);

    // Crear elemento <a> invisible para descargar
    const a = document.createElement("a");
    a.href = url;
    a.download = `citas-${new Date().toISOString().split("T")[0]}.csv`; // citas-2025-12-10.csv

    // Simular click para descargar
    a.click();

    // Liberar memoria
    window.URL.revokeObjectURL(url);
  });

  // ==========================================
  // 4. GESTI√ìN DE CITAS (Confirmar/Cancelar/Completar)
  // ==========================================
  document.addEventListener("click", async (e) => {
    const target = e.target as HTMLElement;

    // Solo procesar clicks en botones con data-action
    if (target.dataset.action) {
      const id = target.dataset.id; // UUID de la cita
      const action = target.dataset.action; // "confirm", "cancel", "complete"

      // Mensajes de confirmaci√≥n
      const messages = {
        confirm: "¬øConfirmar esta cita?",
        cancel: "¬øCancelar esta cita?",
        complete: "¬øMarcar como completada?",
      };

      // Mostrar di√°logo de confirmaci√≥n
      // @ts-ignore
      if (!confirm(messages[action])) return; // Si cancela, salir

      // Mapear acci√≥n ‚Üí estado en base de datos
      const statusMap = {
        confirm: "confirmed",
        cancel: "cancelled",
        complete: "completed",
      };

      // @ts-ignore
      const newStatus = statusMap[action];

      // Actualizar en Supabase
      const { error } = await supabase
        .from("appointments")
        .update({ status: newStatus }) // SET status = newStatus
        .eq("id", id); // WHERE id = id

      // Manejar resultado
      if (error) {
        alert("Error: " + error.message);
      } else {
        // √âxito: recargar p√°gina para ver cambios
        window.location.reload();
      }
    }
  });

  // ==========================================
  // 5. CERRAR SESI√ìN
  // ==========================================
  const logoutBtn = document.getElementById("logout-btn");

  if (logoutBtn) {
    logoutBtn.addEventListener("click", async () => {
      // Confirmar que quiere salir
      if (confirm("¬øSeguro que quieres cerrar sesi√≥n?")) {
        // Cerrar sesi√≥n en Supabase
        await supabase.auth.signOut();

        // Borrar cookies (para que el servidor tambi√©n sepa)
        document.cookie =
          "sb-access-token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT";
        document.cookie =
          "sb-refresh-token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT";

        // Redirigir al login
        window.location.href = "/admin/login";
      }
    });
  }
</script>
