---
import Layout from "../../layouts/Layout.astro";
import { supabase } from "../../lib/supabase";

// === 1. AUTENTICACI√ìN SERVIDOR ===
const accessToken = Astro.cookies.get("sb-access-token")?.value;
const refreshToken = Astro.cookies.get("sb-refresh-token")?.value;

if (accessToken && refreshToken) {
  await supabase.auth.setSession({
    access_token: accessToken,
    refresh_token: refreshToken,
  });
}

// === 2. OBTENER DATOS ===
const { data: appointments } = await supabase
  .from("appointments")
  .select(`*, services (name, duration, price)`)
  .order("appointment_date", { ascending: true })
  .order("appointment_time", { ascending: true });

// Contadores
const pending = appointments?.filter((a) => a.status === "pending").length || 0;
const confirmed = appointments?.filter((a) => a.status === "confirmed").length || 0;
const cancelled = appointments?.filter((a) => a.status === "cancelled").length || 0;
const completed = appointments?.filter((a) => a.status === "completed").length || 0;

// Helper para iniciales (UI)
const getInitials = (name: string) => {
  return name.split(" ").map((n) => n[0]).join("").substring(0, 2).toUpperCase();
};
---

<Layout title="Admin Panel - Gesti√≥n de Citas">
  <div id="main-content" class="min-h-screen bg-gray-50/50 py-8 hidden">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      
      <!-- HEADER PREMIUM -->
      <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 mb-8 flex flex-col md:flex-row justify-between items-center gap-6">
        <div class="flex items-center gap-4 w-full md:w-auto">
            <div class="bg-blue-600 p-3 rounded-xl text-white shadow-blue-200 shadow-lg">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" />
                </svg>
            </div>
            <div>
                <h1 class="text-2xl font-bold text-gray-900 tracking-tight">Agenda M√©dica</h1>
                <p class="text-sm text-gray-500">Administraci√≥n de pacientes</p>
            </div>
        </div>
        
        <div class="flex gap-3 w-full md:w-auto">
          <a href="/" class="flex-1 md:flex-none px-5 py-2.5 text-sm font-medium text-gray-700 bg-white border border-gray-200 rounded-xl hover:bg-gray-50 hover:border-gray-300 transition-all text-center">
            Ver Sitio Web
          </a>
          <button id="logout-btn" class="flex-1 md:flex-none px-5 py-2.5 text-sm font-medium text-white bg-gray-900 rounded-xl hover:bg-gray-800 transition-all shadow-lg shadow-gray-200 flex items-center justify-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 text-gray-300"><path fill-rule="evenodd" d="M3 4.25A2.25 2.25 0 015.25 2h5.5A2.25 2.25 0 0113 4.25v2a.75.75 0 01-1.5 0v-2a.75.75 0 00-.75-.75h-5.5a.75.75 0 00-.75.75v11.5c0 .414.336.75.75.75h5.5a.75.75 0 00.75-.75v-2a.75.75 0 011.5 0v2A2.25 2.25 0 0110.75 18h-5.5A2.25 2.25 0 013 15.75V4.25z" clip-rule="evenodd" /><path fill-rule="evenodd" d="M19 10a.75.75 0 00-.75-.75H8.704l1.048-.943a.75.75 0 10-1.004-1.114l-2.5 2.25a.75.75 0 000 1.114l2.5 2.25a.75.75 0 101.004-1.114l-1.048-.943h9.546A.75.75 0 0019 10z" clip-rule="evenodd" /></svg>
            Salir
          </button>
        </div>
      </div>

      <!-- KPI CARDS -->
      <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
        <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex flex-col justify-between h-32 hover:border-blue-200 transition-colors">
            <div class="flex justify-between">
                <span class="text-sm font-semibold text-gray-400 uppercase">Total</span>
                <span class="p-1.5 bg-gray-50 rounded-lg text-gray-600">üìä</span>
            </div>
            <span class="text-3xl font-bold text-gray-900">{appointments?.length || 0}</span>
        </div>
        <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex flex-col justify-between h-32 hover:border-yellow-200 transition-colors">
            <div class="flex justify-between">
                <span class="text-sm font-semibold text-yellow-600/80 uppercase">Pendientes</span>
                <span class="p-1.5 bg-yellow-50 rounded-lg text-yellow-600">‚è≥</span>
            </div>
            <span class="text-3xl font-bold text-gray-900">{pending}</span>
        </div>
        <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex flex-col justify-between h-32 hover:border-emerald-200 transition-colors">
            <div class="flex justify-between">
                <span class="text-sm font-semibold text-emerald-600/80 uppercase">Confirmadas</span>
                <span class="p-1.5 bg-emerald-50 rounded-lg text-emerald-600">üëç</span>
            </div>
            <span class="text-3xl font-bold text-gray-900">{confirmed}</span>
        </div>
        <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex flex-col justify-between h-32 hover:border-blue-200 transition-colors">
            <div class="flex justify-between">
                <span class="text-sm font-semibold text-blue-600/80 uppercase">Completadas</span>
                <span class="p-1.5 bg-blue-50 rounded-lg text-blue-600">‚úÖ</span>
            </div>
            <span class="text-3xl font-bold text-gray-900">{completed}</span>
        </div>
      </div>

      <!-- BARRA DE HERRAMIENTAS (FILTROS + EXCEL) -->
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
            <!-- Filtro Fecha -->
            <div class="md:col-span-3">
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Fecha</label>
                <select id="filter-date" class="w-full text-sm border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 bg-gray-50">
                    <option value="all">üìÖ Todo el historial</option>
                    <option value="today">üìÜ Hoy</option>
                    <option value="week">üìÖ Esta semana</option>
                    <option value="month">üìÖ Este mes</option>
                </select>
            </div>
            <!-- Filtro Estado -->
            <div class="md:col-span-3">
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Estado</label>
                <select id="filter-status" class="w-full text-sm border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 bg-gray-50">
                    <option value="all">üîÑ Todos</option>
                    <option value="pending">‚è≥ Pendientes</option>
                    <option value="confirmed">üëç Confirmadas</option>
                    <option value="completed">‚úÖ Completadas</option>
                    <option value="cancelled">üö´ Canceladas</option>
                </select>
            </div>
            <!-- Buscador -->
            <div class="md:col-span-4">
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Buscar</label>
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg class="h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </div>
                    <input type="text" id="search-input" class="pl-10 w-full text-sm border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 bg-gray-50" placeholder="Nombre, tel√©fono o email...">
                </div>
            </div>
            <!-- Botones Acci√≥n -->
            <div class="md:col-span-2 flex gap-2 justify-end">
                <button id="clear-filters" class="text-sm text-gray-500 hover:text-blue-600 px-3 py-2 transition-colors">Limpiar</button>
                <button id="export-excel" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-green-700 shadow-sm flex items-center gap-1.5 transition-all hover:scale-105">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4"><path fill-rule="evenodd" d="M4.5 2A1.5 1.5 0 003 3.5v13A1.5 1.5 0 004.5 18h11a1.5 1.5 0 001.5-1.5V7.621a1.5 1.5 0 00-.44-1.06l-4.12-4.122A1.5 1.5 0 0011.378 2H4.5zm2.25 8.5a.75.75 0 000 1.5h6.5a.75.75 0 000-1.5h-6.5zm0 3a.75.75 0 000 1.5h6.5a.75.75 0 000-1.5h-6.5z" clip-rule="evenodd" /></svg>
                    Excel
                </button>
            </div>
        </div>
      </div>

      <!-- TABLA PRINCIPAL -->
      <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead>
              <tr class="bg-gray-50/50 border-b border-gray-100">
                <th class="px-6 py-4 text-left text-xs font-bold text-gray-400 uppercase tracking-wider">Fecha & Hora</th>
                <th class="px-6 py-4 text-left text-xs font-bold text-gray-400 uppercase tracking-wider">Paciente</th>
                <th class="px-6 py-4 text-left text-xs font-bold text-gray-400 uppercase tracking-wider">Contacto</th>
                <th class="px-6 py-4 text-left text-xs font-bold text-gray-400 uppercase tracking-wider">Servicio</th>
                <th class="px-6 py-4 text-left text-xs font-bold text-gray-400 uppercase tracking-wider">Estado</th>
                <th class="px-6 py-4 text-right text-xs font-bold text-gray-400 uppercase tracking-wider">Acciones</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-50">
              {
                appointments && appointments.map((apt) => {
                    const dateObj = new Date(apt.appointment_date + 'T00:00:00');
                    const dayName = dateObj.toLocaleDateString('es-CO', { weekday: 'short' });
                    const dayNum = dateObj.toLocaleDateString('es-CO', { day: 'numeric' });
                    const monthName = dateObj.toLocaleDateString('es-CO', { month: 'short' });
                    
                    return (
                    <tr 
                        class="hover:bg-blue-50/30 transition-colors group"
                        style="display: table-row;"
                        data-date={apt.appointment_date}
                        data-time={apt.appointment_time}
                        data-name={apt.customer_name}
                        data-phone={apt.customer_phone}
                        data-email={apt.customer_email || ''}
                        data-service={apt.services?.name || 'N/A'}
                        data-status={apt.status}
                        data-search={`${apt.customer_name} ${apt.customer_phone} ${apt.customer_email}`}
                    >
                      
                      <!-- FECHA -->
                      <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center gap-3">
                            <div class="flex flex-col items-center justify-center w-12 h-12 bg-gray-100 rounded-lg border border-gray-200">
                                <span class="text-[10px] uppercase font-bold text-gray-500 leading-none">{monthName}</span>
                                <span class="text-lg font-bold text-gray-900 leading-none mt-0.5">{dayNum}</span>
                            </div>
                            <div class="flex flex-col">
                                <span class="text-sm font-medium text-gray-900 capitalize">{dayName}</span>
                                <span class="text-sm text-gray-500 font-mono bg-gray-100 px-1.5 rounded text-center">{apt.appointment_time.slice(0, 5)}</span>
                            </div>
                        </div>
                      </td>
                      
                      <!-- PACIENTE -->
                      <td class="px-6 py-4">
                        <div class="flex items-center gap-3">
                            <div class="w-9 h-9 rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 text-white flex items-center justify-center text-xs font-bold shadow-sm">
                                {getInitials(apt.customer_name)}
                            </div>
                            <div class="text-sm font-semibold text-gray-900">{apt.customer_name}</div>
                        </div>
                      </td>
                      
                      <!-- CONTACTO (WhatsApp) -->
                      <td class="px-6 py-4">
                        <div class="flex flex-col items-start gap-1.5">
                            <a 
                                href={`https://wa.me/57${apt.customer_phone.replace(/\D/g,'')}`} 
                                target="_blank"
                                class="inline-flex items-center gap-1.5 px-2 py-1 bg-green-50 text-green-700 text-xs font-medium rounded-md hover:bg-green-100 transition-colors border border-green-100"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" viewBox="0 0 16 16"><path d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.933 7.933 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.898 7.898 0 0 0 13.6 2.326zM7.994 14.521a6.573 6.573 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.557 6.557 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592z"/></svg>
                                {apt.customer_phone}
                            </a>
                            {apt.customer_email && (
                                <span class="text-xs text-gray-400 flex items-center gap-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-3 h-3"><path d="M3 4a2 2 0 00-2 2v1.161l8.441 4.221a1.25 1.25 0 001.118 0L19 7.162V6a2 2 0 00-2-2H3z" /><path d="M19 8.839l-7.77 3.885a2.75 2.75 0 01-2.46 0L1 8.839V14a2 2 0 002 2h14a2 2 0 002-2V8.839z" /></svg>
                                    {apt.customer_email}
                                </span>
                            )}
                        </div>
                      </td>
                      
                      <!-- SERVICIO -->
                      <td class="px-6 py-4">
                        <div class="text-sm text-gray-900 font-medium">{apt.services?.name || "General"}</div>
                        <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded text-[10px] font-medium bg-gray-100 text-gray-600">
                            ‚è± {apt.services?.duration || 30} min
                        </span>
                      </td>
                      
                      <!-- ESTADO -->
                      <td class="px-6 py-4 whitespace-nowrap">
                        {apt.status === "pending" && <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 border border-yellow-200">‚è≥ Pendiente</span>}
                        {apt.status === "confirmed" && <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 border border-blue-200">üëç Confirmada</span>}
                        {apt.status === "completed" && <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 border border-green-200">‚úÖ Completada</span>}
                        {apt.status === "cancelled" && <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-600 border border-gray-200">üö´ Cancelada</span>}
                      </td>
                      
                      <!-- ACCIONES (ICONOS PREMIUM) -->
                      <td class="px-6 py-4 whitespace-nowrap text-right">
                        <div class="flex justify-end items-center gap-2">
                            
                            {/* PENDIENTE */}
                            {apt.status === "pending" && (
                                <>
                                    <button title="Confirmar" data-id={apt.id} data-action="confirm" class="h-8 px-3 bg-white text-emerald-600 border border-emerald-200 rounded-lg hover:bg-emerald-50 hover:border-emerald-300 transition-all shadow-sm flex items-center gap-1.5 text-xs font-bold uppercase tracking-wide">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-3.5 h-3.5"><path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 01.143 1.052l-8 10.5a.75.75 0 01-1.127.075l-4.5-4.5a.75.75 0 011.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 011.05-.143z" clip-rule="evenodd" /></svg>
                                        Confirmar
                                    </button>
                                    <button title="Cancelar" data-id={apt.id} data-action="cancel" class="h-8 w-8 flex items-center justify-center bg-white text-gray-400 border border-gray-200 rounded-lg hover:bg-red-50 hover:text-red-600 hover:border-red-200 transition-all shadow-sm">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4"><path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" /></svg>
                                    </button>
                                </>
                            )}

                            {/* CONFIRMADA */}
                            {apt.status === "confirmed" && (
                                <>
                                    <button title="Completar" data-id={apt.id} data-action="complete" class="h-8 px-3 bg-blue-600 text-white border border-blue-700 rounded-lg hover:bg-blue-700 transition-all shadow-md flex items-center gap-1.5 text-xs font-bold uppercase tracking-wide">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-3.5 h-3.5"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd" /></svg>
                                        Completar
                                    </button>
                                    <button title="Cancelar" data-id={apt.id} data-action="cancel" class="h-8 w-8 flex items-center justify-center text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.28 7.22a.75.75 0 00-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 101.06 1.06L10 11.06l1.72 1.72a.75.75 0 101.06-1.06L11.06 10l1.72-1.72a.75.75 0 00-1.06-1.06L10 8.94 8.28 7.22z" clip-rule="evenodd" /></svg>
                                    </button>
                                </>
                            )}

                            {/* COMPLETADA */}
                            {apt.status === "completed" && (
                                <>
                                    <div class="h-8 px-3 bg-emerald-100 text-emerald-800 border border-emerald-200 rounded-lg flex items-center gap-1.5 text-xs font-bold uppercase tracking-wide cursor-default opacity-80">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-3.5 h-3.5"><path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 01.143 1.052l-8 10.5a.75.75 0 01-1.127.075l-4.5-4.5a.75.75 0 011.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 011.05-.143z" clip-rule="evenodd" /></svg>
                                        Finalizada
                                    </div>
                                    <button title="Deshacer" data-id={apt.id} data-action="undo_complete" class="h-8 w-8 flex items-center justify-center bg-white text-gray-400 border border-gray-200 rounded-lg hover:bg-orange-50 hover:text-orange-500 hover:border-orange-200 transition-all shadow-sm">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4"><path fill-rule="evenodd" d="M7.793 2.232a.75.75 0 01-.025 1.06L3.622 7.25h10.003a5.375 5.375 0 010 10.75H10.75a.75.75 0 010-1.5h2.875a3.875 3.875 0 000-7.75H3.622l4.146 3.957a.75.75 0 01-1.036 1.085l-5.5-5.25a.75.75 0 010-1.085l5.5-5.25a.75.75 0 011.06.025z" clip-rule="evenodd" /></svg>
                                    </button>
                                </>
                            )}

                            {/* CANCELADA */}
                            {apt.status === "cancelled" && (
                                <button title="Restaurar" data-id={apt.id} data-action="restore" class="h-8 px-3 bg-white text-gray-500 border border-gray-200 rounded-lg hover:bg-blue-50 hover:text-blue-600 hover:border-blue-200 transition-all shadow-sm flex items-center gap-1.5 text-xs font-bold uppercase tracking-wide group/restore">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-3.5 h-3.5 group-hover/restore:-rotate-180 transition-transform duration-500"><path fill-rule="evenodd" d="M7.793 2.232a.75.75 0 01-.025 1.06L3.622 7.25h10.003a5.375 5.375 0 010 10.75H10.75a.75.75 0 010-1.5h2.875a3.875 3.875 0 000-7.75H3.622l4.146 3.957a.75.75 0 01-1.036 1.085l-5.5-5.25a.75.75 0 010-1.085l5.5-5.25a.75.75 0 011.06.025z" clip-rule="evenodd" /></svg>
                                    Restaurar
                                </button>
                            )}

                        </div>
                      </td>
                    </tr>
                )})
              }
            </tbody>
          </table>

          {/* EMPTY STATE */}
          {(!appointments || appointments.length === 0) && (
            <div class="text-center py-20 bg-gray-50">
                <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-white border border-gray-100 shadow-sm mb-4">
                    <span class="text-2xl">üìÖ</span>
                </div>
                <h3 class="text-lg font-bold text-gray-900">Agenda Vac√≠a</h3>
                <p class="text-gray-500 max-w-sm mx-auto mt-1">No hay citas programadas con estos filtros.</p>
            </div>
          )}
        </div>
      </div>
    </div>
  </div>
</Layout>

<script>
  import { supabase } from "../../lib/supabase";

  // 1. AUTH CHECK
  async function checkAuth() {
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) {
      window.location.href = "/admin/login";
    } else {
      const content = document.getElementById("main-content");
      if (content) content.classList.remove("hidden");
    }
  }
  checkAuth();

  // 2. FILTROS Y B√öSQUEDA (Optimizados con Data Attributes)
  const filterDate = document.getElementById("filter-date") as HTMLSelectElement;
  const filterStatus = document.getElementById("filter-status") as HTMLSelectElement;
  const searchInput = document.getElementById("search-input") as HTMLInputElement;
  const clearBtn = document.getElementById("clear-filters");
  const exportBtn = document.getElementById("export-excel");
  const tableRows = document.querySelectorAll("tbody tr");

  function applyFilters() {
    const dateVal = filterDate?.value || "all";
    const statusVal = filterStatus?.value || "all";
    const searchVal = searchInput?.value.toLowerCase().trim() || "";
    const today = new Date();
    today.setHours(0,0,0,0);

    tableRows.forEach((row) => {
      const rowEl = row as HTMLElement;
      let show = true;

      // Filtro Estado (usando data attribute para precisi√≥n)
      if (statusVal !== "all") {
        const rowStatus = rowEl.dataset.status || "";
        if (rowStatus !== statusVal) show = false;
      }

      // Filtro Fecha (usando data attribute)
      if (dateVal !== "all") {
        const rowDateStr = rowEl.dataset.date || "";
        // Truco para arreglar timezone offset
        const rowDate = new Date(rowDateStr + 'T00:00:00'); 
        
        if (dateVal === "today") {
            if (rowDate.getTime() !== today.getTime()) show = false;
        } else if (dateVal === "week") {
            const first = today.getDate() - today.getDay() + 1; // Lunes
            const last = first + 6; // Domingo
            const monday = new Date(today); monday.setDate(first);
            const sunday = new Date(today); sunday.setDate(last);
            if (rowDate < monday || rowDate > sunday) show = false;
        } else if (dateVal === "month") {
            if (rowDate.getMonth() !== today.getMonth()) show = false;
        }
      }

      // Filtro B√∫squeda (usando data-search con todos los textos juntos)
      if (searchVal) {
        const searchText = rowEl.dataset.search?.toLowerCase() || "";
        if (!searchText.includes(searchVal)) show = false;
      }

      rowEl.style.display = show ? "" : "none";
    });
  }

  filterDate?.addEventListener("change", applyFilters);
  filterStatus?.addEventListener("change", applyFilters);
  searchInput?.addEventListener("input", applyFilters);
  
  clearBtn?.addEventListener("click", () => {
    filterDate.value = "all";
    filterStatus.value = "all";
    searchInput.value = "";
    applyFilters();
  });

  // 3. EXPORTAR EXCEL (OPTIMIZADO PARA LATAM/ESPA√ëOL)
  exportBtn?.addEventListener("click", () => {
    // Solo exportar filas visibles
    const visibleRows = Array.from(document.querySelectorAll('tbody tr'))
        .filter(row => (row as HTMLElement).style.display !== 'none');
    
    // Diccionario de estados
    const statusTranslate: {[key: string]: string} = {
        'pending': 'Pendiente',
        'confirmed': 'Confirmada',
        'completed': 'Completada',
        'cancelled': 'Cancelada'
    };

    // 1. CAMBIO CLAVE: Usamos punto y coma (;) en los encabezados
    let csv = "Fecha;Hora;Paciente;Telefono;Email;Servicio;Estado\n";
    
    visibleRows.forEach(row => {
        const el = row as HTMLElement;
        
        const date = el.dataset.date || "";
        const time = el.dataset.time || "";
        // Limpiamos comillas dobles si las hubiera en el nombre para evitar errores
        const name = (el.dataset.name || "").replace(/"/g, '""'); 
        const phone = el.dataset.phone || "";
        const email = el.dataset.email || "No registrado";
        const service = el.dataset.service || "";
        const statusRaw = el.dataset.status || "";
        const status = statusTranslate[statusRaw] || statusRaw;

        // 2. CAMBIO CLAVE: Construimos la fila usando punto y coma (;)
        // Ponemos comillas alrededor de los textos por seguridad, pero el separador es ;
        csv += `${date};${time};"${name}";${phone};${email};"${service}";${status}\n`;
    });

    // Agregamos el BOM (\uFEFF) para las tildes
    const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
    
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `reporte_citas_${new Date().toISOString().slice(0,10)}.csv`;
    a.click();
    window.URL.revokeObjectURL(url);
  });

  // 4. ACCIONES (Reversibles y mejoradas)
  document.addEventListener("click", async (e) => {
    // @ts-ignore
    const btn = e.target.closest('button');
    if (!btn || !btn.dataset.action) return;

    const { id, action } = btn.dataset;
    const confirmMap: any = {
        confirm: "¬øConfirmar asistencia del paciente?",
        cancel: "¬øCancelar esta cita?",
        complete: "¬øMarcar servicio como finalizado?",
        restore: "¬øRestaurar esta cita a Pendiente?",
        undo_complete: "¬øVolver esta cita a estado Confirmada?"
    };

    if (!confirm(confirmMap[action])) return;

    const statusMap: any = {
        confirm: "confirmed",
        cancel: "cancelled",
        complete: "completed",
        restore: "pending",
        undo_complete: "confirmed"
    };

    btn.style.opacity = "0.5";
    btn.style.cursor = "wait";

    const { error } = await supabase.from("appointments").update({ status: statusMap[action] }).eq("id", id);

    if (error) {
        alert("Error: " + error.message);
        btn.style.opacity = "1";
    } else {
        window.location.reload();
    }
  });

  // 5. LOGOUT
  document.getElementById("logout-btn")?.addEventListener("click", async () => {
    if (confirm("¬øCerrar sesi√≥n de administrador?")) {
      await supabase.auth.signOut();
      document.cookie = "sb-access-token=; path=/; max-age=0";
      document.cookie = "sb-refresh-token=; path=/; max-age=0";
      window.location.href = "/admin/login";
    }
  });
</script>