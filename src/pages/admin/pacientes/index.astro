---
import AdminLayout from "../../../layouts/AdminLayout.astro";
import { supabase } from "../../../lib/supabase";

// 1. AUTH
const accessToken = Astro.cookies.get("sb-access-token")?.value;
const refreshToken = Astro.cookies.get("sb-refresh-token")?.value;

if (accessToken && refreshToken) {
  await supabase.auth.setSession({ access_token: accessToken, refresh_token: refreshToken });
} else {
  return Astro.redirect("/admin/login");
}

// 2. DATOS
// Traemos alergias también para el reporte
const { data: patients } = await supabase.from("patients").select("*").order("created_at", { ascending: false });
const { data: business } = await supabase.from("businesses").select("id").single();
const businessId = business?.id;

// Helpers
const getInitials = (name: string) => name ? name.split(" ").map((n) => n[0]).join("").substring(0, 2).toUpperCase() : "??";
const calculateAge = (birthDateString: string) => {
  if (!birthDateString) return "N/A";
  const today = new Date();
  const birthDate = new Date(birthDateString);
  let age = today.getFullYear() - birthDate.getFullYear();
  const m = today.getMonth() - birthDate.getMonth();
  if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) age--;
  return age + " años";
};
---

<AdminLayout title="Directorio de Pacientes">
  <div class="max-w-7xl mx-auto">
    
    <!-- HEADER -->
    <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-8">
      <div>
        <h1 class="text-2xl font-bold text-gray-900 tracking-tight">Pacientes</h1>
        <p class="text-sm text-gray-500">Base de datos clínica unificada</p>
      </div>
      <div class="flex gap-2">
          <!-- BOTÓN EXPORTAR EXCEL -->
          <button id="export-btn" class="bg-green-600 text-white px-4 py-2.5 rounded-xl font-bold shadow-md hover:bg-green-700 transition-all flex items-center gap-2 text-sm">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg>
            Excel
          </button>
          
          <button id="create-patient-btn" class="bg-brand-600 text-white px-5 py-2.5 rounded-xl font-bold shadow-lg shadow-brand-200 hover:bg-brand-700 transition-all flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
            Nuevo Paciente
          </button>
      </div>
    </div>

    <!-- BUSCADOR -->
    <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 mb-6">
      <div class="relative">
        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
          <svg class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
        </div>
        <input type="text" id="search-input" class="block w-full pl-10 pr-3 py-3 border border-gray-200 rounded-xl leading-5 bg-gray-50 placeholder-gray-400 focus:outline-none focus:bg-white focus:ring-2 focus:ring-brand-500 transition-all" placeholder="Buscar por nombre, documento, teléfono..." autocomplete="off" />
      </div>
    </div>

    <!-- LISTA -->
    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden min-h-[400px] flex flex-col justify-between">
      <div class="overflow-x-auto">
        <table class="w-full text-left">
          <thead>
            <tr class="bg-gray-50/50 border-b border-gray-100 text-xs uppercase text-gray-400 font-bold tracking-wider">
              <th class="px-6 py-4">Paciente</th>
              <th class="px-6 py-4">Documento</th>
              <th class="px-6 py-4">Contacto</th>
              <th class="px-6 py-4">Edad</th>
              <th class="px-6 py-4 text-right">Acción</th>
            </tr>
          </thead>
          <tbody id="patients-tbody" class="divide-y divide-gray-50">
            {patients && patients.length > 0 ? (
              patients.map((p) => (
                <tr class="patient-row hover:bg-gray-50 transition-colors group" 
                    data-search={`${p.full_name} ${p.document_id} ${p.email} ${p.phone}`.toLowerCase()}
                    data-json={JSON.stringify(p)} 
                >
                  <td class="px-6 py-4">
                    <div class="flex items-center gap-3">
                      <div class="w-10 h-10 rounded-full bg-brand-100 text-brand-700 flex items-center justify-center text-sm font-bold border border-brand-200">{getInitials(p.full_name)}</div>
                      <div><div class="font-bold text-gray-900">{p.full_name}</div><div class="text-xs text-gray-400">Registrado: {new Date(p.created_at).toLocaleDateString()}</div></div>
                    </div>
                  </td>
                  <td class="px-6 py-4"><span class="font-mono text-sm text-gray-600 bg-gray-100 px-2 py-1 rounded">{p.document_id || "Sin Doc"}</span></td>
                  <td class="px-6 py-4">
                    <div class="flex flex-col gap-1">
                       {p.phone && <div class="flex items-center gap-1.5 text-sm text-gray-600"><svg class="w-3.5 h-3.5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>{p.phone}</div>}
                       {p.email && <div class="flex items-center gap-1.5 text-xs text-gray-500"><svg class="w-3.5 h-3.5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>{p.email}</div>}
                    </div>
                  </td>
                  <td class="px-6 py-4 text-sm text-gray-600">{calculateAge(p.birth_date)}</td>
                  <td class="px-6 py-4 text-right">
                    <a href={`/admin/pacientes/${p.id}`} class="inline-flex items-center justify-center px-4 py-2 border border-brand-200 shadow-sm text-sm font-medium rounded-lg text-brand-700 bg-white hover:bg-brand-50 transition-all">Ver Ficha</a>
                  </td>
                </tr>
              ))
            ) : (
              <tr><td colspan="5" class="px-6 py-12 text-center text-gray-500">No hay pacientes registrados.</td></tr>
            )}
          </tbody>
        </table>
      </div>
      
      <!-- PAGINACIÓN -->
      <div id="pagination-controls" class="bg-gray-50 px-6 py-3 border-t border-gray-100 flex justify-between items-center">
         <span class="text-xs text-gray-500" id="page-info">Mostrando 0 de 0</span>
         <div class="flex gap-2">
             <button id="prev-page" class="px-3 py-1 bg-white border rounded text-xs font-bold text-gray-600 disabled:opacity-50">Anterior</button>
             <div id="page-numbers" class="flex gap-1"></div>
             <button id="next-page" class="px-3 py-1 bg-white border rounded text-xs font-bold text-gray-600 disabled:opacity-50">Siguiente</button>
         </div>
      </div>
    </div>
  </div>
  <div id="app-data" data-business-id={businessId}></div>
</AdminLayout>

<script>
  import Swal from "sweetalert2";
  import { supabase } from "../../../lib/supabase";

  // PAGINACIÓN Y BÚSQUEDA
  const searchInput = document.getElementById('search-input') as HTMLInputElement;
  const allRows = Array.from(document.querySelectorAll('.patient-row')) as HTMLElement[];
  const ITEMS_PER_PAGE = 10;
  let currentPage = 1;
  let filteredRows = [...allRows];

  function renderTable() {
      const start = (currentPage - 1) * ITEMS_PER_PAGE;
      const end = start + ITEMS_PER_PAGE;
      allRows.forEach(r => r.style.display = 'none');
      filteredRows.slice(start, end).forEach(r => r.style.display = 'table-row');
      
      const pageInfo = document.getElementById('page-info');
      if (pageInfo) pageInfo.textContent = `Mostrando ${Math.min(end, filteredRows.length)} de ${filteredRows.length}`;
      
      const prevBtn = document.getElementById('prev-page') as HTMLButtonElement;
      const nextBtn = document.getElementById('next-page') as HTMLButtonElement;
      if (prevBtn) prevBtn.disabled = currentPage === 1;
      if (nextBtn) nextBtn.disabled = end >= filteredRows.length;
  }

  searchInput?.addEventListener('keyup', (e) => {
      const term = (e.target as HTMLInputElement).value.toLowerCase();
      filteredRows = allRows.filter(row => row.dataset.search?.includes(term));
      currentPage = 1;
      renderTable();
  });

  document.getElementById('prev-page')?.addEventListener('click', () => { if(currentPage > 1) { currentPage--; renderTable(); }});
  document.getElementById('next-page')?.addEventListener('click', () => { if((currentPage * ITEMS_PER_PAGE) < filteredRows.length) { currentPage++; renderTable(); }});

  // URL Query Check
  const urlParams = new URLSearchParams(window.location.search);
  if(urlParams.get('q')) { searchInput.value = urlParams.get('q') || ''; searchInput.dispatchEvent(new Event('keyup')); }
  else { renderTable(); }

  // LOGICA EXPORTAR EXCEL (CSV UTF-8 BOM)
  document.getElementById('export-btn')?.addEventListener('click', () => {
      // Usamos 'filteredRows' para exportar solo lo que se ve (o si no hay filtro, todo)
      const dataToExport = filteredRows.map(row => JSON.parse(row.dataset.json || '{}'));
      
      let csv = "Nombre Completo;Documento;Email;Telefono;Fecha Nacimiento;Genero;Direccion;Alergias;Fecha Registro\n";
      
      dataToExport.forEach(p => {
          const clean = (str: any) => (str || "").toString().replace(/"/g, '""').replace(/;/g, ',');
          const line = [
              clean(p.full_name),
              clean(p.document_id),
              clean(p.email),
              clean(p.phone),
              clean(p.birth_date),
              clean(p.gender),
              clean(p.address),
              clean(p.allergies), // Nuevo campo
              clean(new Date(p.created_at).toLocaleDateString())
          ];
          csv += line.join(';') + "\n";
      });

      const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `pacientes_${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
      window.URL.revokeObjectURL(url);
  });

  // CREAR PACIENTE
  document.getElementById('create-patient-btn')?.addEventListener('click', async () => {
      const appData = document.getElementById('app-data');
      const businessId = appData?.dataset.businessId;

      const { value: formValues } = await Swal.fire({
          title: 'Nuevo Paciente',
          html: `<div class="grid gap-3 text-left"><div><label class="text-xs font-bold text-gray-500">Nombre Completo *</label><input id="new-name" class="swal2-input m-0 w-full"></div><div><label class="text-xs font-bold text-gray-500">Documento</label><input id="new-doc" class="swal2-input m-0 w-full"></div><div class="grid grid-cols-2 gap-3"><div><label class="text-xs font-bold text-gray-500">Teléfono</label><input id="new-phone" class="swal2-input m-0 w-full"></div><div><label class="text-xs font-bold text-gray-500">Email</label><input id="new-email" class="swal2-input m-0 w-full"></div></div></div>`,
          showCancelButton: true, confirmButtonText: 'Crear', confirmButtonColor: 'rgb(var(--color-brand))',
          preConfirm: () => {
              const name = (document.getElementById('new-name') as HTMLInputElement).value;
              if(!name) Swal.showValidationMessage('El nombre es obligatorio');
              return { full_name: name, document_id: (document.getElementById('new-doc') as HTMLInputElement).value, phone: (document.getElementById('new-phone') as HTMLInputElement).value, email: (document.getElementById('new-email') as HTMLInputElement).value, business_id: businessId }
          }
      });

      if(formValues) {
          Swal.fire({ title: 'Creando...', didOpen: () => Swal.showLoading() });
          const { error } = await supabase.from('patients').insert(formValues);
          if(error) Swal.fire('Error', error.message, 'error');
          else { await Swal.fire({ icon: 'success', title: 'Paciente creado', timer: 1000, showConfirmButton: false }); window.location.reload(); }
      }
  });
</script>