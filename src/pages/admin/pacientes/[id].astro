---
import AdminLayout from "../../../layouts/AdminLayout.astro";
import { supabase } from "../../../lib/supabase";

const { id } = Astro.params;

// 1. AUTH
const accessToken = Astro.cookies.get("sb-access-token")?.value;
const refreshToken = Astro.cookies.get("sb-refresh-token")?.value;

if (accessToken && refreshToken) {
  await supabase.auth.setSession({ access_token: accessToken, refresh_token: refreshToken });
} else {
  return Astro.redirect("/admin/login");
}

if (!id) return Astro.redirect("/admin/pacientes");

// 2. DATOS
const { data: patient, error: patientError } = await supabase.from("patients").select("*").eq("id", id).single();
if (patientError || !patient) return Astro.redirect("/404");

// Datos Business (Para email y l√≥gica)
const { data: businessData } = await supabase.from("businesses").select("name, primary_color, logo_url, address").eq("id", patient.business_id).single();

const { data: records } = await supabase.from("clinical_records").select(`*, dentists (name)`).eq("patient_id", id).order("created_at", { ascending: false });
const { data: appointments } = await supabase.from("appointments").select(`*, services (name), dentists (name)`).eq("patient_id", id).order("appointment_date", { ascending: false });
const { data: attachments } = await supabase.from("patient_attachments").select("*").eq("patient_id", id).order("created_at", { ascending: false });

// üî• NUEVO: Cargar Odontograma Maestro y Planes de Tratamiento
const { data: masterOdontogram } = await supabase.from("odontogram_master").select("*").eq("patient_id", id).single();
const { data: treatmentPlans } = await supabase.from("treatment_plans").select(`*, dentists (name), services (name)`).eq("patient_id", id).order("created_at", { ascending: false });
const hasApprovedPlan = treatmentPlans?.some(t => t.status === 'approved') || false;

// Calcular Presupuestos (SSR)
const pendingTreatments = treatmentPlans?.filter(t => t.status === 'pending') || [];
const totalPendingCost = pendingTreatments.reduce((sum, t) => sum + (parseFloat(t.estimated_cost) || 0), 0);
const urgentCount = pendingTreatments.filter(t => t.priority === 'urgent').length;

const { data: servicesList } = await supabase.from("services").select("id, name, price").eq("business_id", patient.business_id).eq("is_active", true).order("name");
const { data: dentistsList } = await supabase.from("dentists").select("id, name").eq("business_id", patient.business_id).eq("is_active", true).order("name");

// Helpers
const getInitials = (name: string) => name ? name.split(" ").map((n) => n[0]).join("").substring(0, 2).toUpperCase() : "??";
const calculateAge = (birthDateString: string) => {
  if (!birthDateString) return null;
  const today = new Date();
  const birthDate = new Date(birthDateString);
  let age = today.getFullYear() - birthDate.getFullYear();
  const m = today.getMonth() - birthDate.getMonth();
  if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) age--;
  return age;
};
const age = calculateAge(patient.birth_date);

// utils/money.ts
export const formatCOP = (value: number | string) =>
  `$${Number(value || 0).toLocaleString('es-CO')}`;

---

<AdminLayout title={`Historia Cl√≠nica - ${patient.full_name}`}>
  
  <div class="max-w-7xl mx-auto pb-20">
    
    <!-- HEADER -->
    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 mb-6 flex flex-col md:flex-row items-start md:items-center justify-between gap-6 relative overflow-hidden">
        <div class="absolute top-0 right-0 w-32 h-32 bg-brand-50 rounded-bl-full -mr-10 -mt-10 opacity-50 pointer-events-none"></div>
        <div class="flex items-center gap-5 z-10">
            <div class="w-20 h-20 rounded-2xl bg-gradient-to-br from-brand-500 to-brand-700 text-white flex items-center justify-center text-2xl font-bold shadow-lg shadow-brand-200">{getInitials(patient.full_name)}</div>
            <div>
                <div class="flex items-center gap-2 mb-1">
                    <h1 class="text-2xl font-bold text-gray-900">{patient.full_name}</h1>
                    <span class="bg-gray-100 text-gray-600 text-xs px-2 py-0.5 rounded-full font-mono border border-gray-200">ID: {patient.document_id || 'N/A'}</span>
                </div>
                <div class="flex flex-wrap gap-4 text-sm text-gray-500">
                    <span class="flex items-center gap-1"><svg class="w-4 h-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>{age !== null ? `${age} a√±os` : 'Edad desconocida'}</span>
                    <span class="flex items-center gap-1"><svg class="w-4 h-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" /></svg>{patient.phone || 'Sin tel√©fono'}</span>
                </div>
                <!-- ALERGIAS -->
                {patient.allergies && (
                    <div class="mt-2 inline-flex items-center gap-1 px-2 py-1 bg-red-50 text-red-700 text-xs font-bold rounded border border-red-100 animate-pulse">
                        <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
                        ALERGIAS: {patient.allergies}
                    </div>
                )}
            </div>
        </div>
        <div class="flex flex-wrap gap-3 z-10 w-full md:w-auto">
             <a href={`https://wa.me/57${patient.phone?.replace(/\D/g, '')}`} target="_blank" class="flex-1 md:flex-none justify-center px-4 py-2 bg-green-50 text-green-700 border border-green-200 rounded-xl font-bold text-sm hover:bg-green-100 transition-colors flex items-center gap-2">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg> WhatsApp
             </a>
             <button id="edit-patient-btn" class="flex-1 md:flex-none px-4 py-2 border border-gray-200 text-gray-600 rounded-xl font-bold text-sm hover:bg-gray-50 transition-colors"
                data-full-name={patient.full_name} data-doc={patient.document_id} data-phone={patient.phone} data-email={patient.email} data-address={patient.address} data-birth={patient.birth_date} data-gender={patient.gender} data-allergies={patient.allergies || ''}>
                Editar Datos
             </button>
        </div>
    </div>

    <!-- GRID LAYOUT -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <!-- SIDEBAR -->
        <div class="space-y-6">
            <!-- TABS -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-2">
                <nav class="flex lg:flex-col gap-1 overflow-x-auto whitespace-nowrap pb-2 lg:pb-0 scrollbar-hide">
                    <button class="tab-btn active flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-bold text-gray-600 hover:bg-gray-50 transition-all text-left w-full min-w-[150px] lg:min-w-0" data-target="tab-history">
                        <div class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center shrink-0"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg></div> Historia Cl√≠nica
                    </button>
                    <button class="tab-btn flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-bold text-gray-600 hover:bg-gray-50 transition-all text-left w-full min-w-[150px] lg:min-w-0" data-target="tab-odontogram">
                        <div class="w-8 h-8 rounded-full bg-teal-100 text-teal-600 flex items-center justify-center shrink-0 relative">
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            {urgentCount > 0 && <span class="absolute -top-1 -right-1 w-4 h-4 bg-red-500 text-white text-[10px] font-bold rounded-full flex items-center justify-center">{urgentCount}</span>}
                        </div> Odontograma
                    </button>
                    <button class="tab-btn flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-bold text-gray-600 hover:bg-gray-50 transition-all text-left w-full min-w-[150px] lg:min-w-0" data-target="tab-info">
                        <div class="w-8 h-8 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center shrink-0"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg></div> Informaci√≥n
                    </button>
                    <button class="tab-btn flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-bold text-gray-600 hover:bg-gray-50 transition-all text-left w-full min-w-[150px] lg:min-w-0" data-target="tab-files">
                        <div class="w-8 h-8 rounded-full bg-orange-100 text-orange-600 flex items-center justify-center shrink-0"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" /></svg></div> Archivos
                    </button>
                </nav>
            </div>
            
            <!-- CITAS (Con Edici√≥n y Borrado) -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
                <h3 class="text-sm font-bold text-gray-900 uppercase tracking-wider mb-4 border-b border-gray-100 pb-2">Pr√≥ximas Citas</h3>
                <div class="space-y-3">
                    {appointments && appointments.filter(a => new Date(a.appointment_date) >= new Date()).length > 0 ? (
                        appointments.filter(a => new Date(a.appointment_date) >= new Date()).slice(0, 3).map(a => (
                            <div class="flex items-start gap-3 p-3 bg-gray-50 rounded-lg border border-gray-100 relative group">
                                <!-- üî• FIX: ZONA HORARIA LOCAL -->
                                <div class="bg-white border border-gray-200 rounded px-2 py-1 text-center min-w-[50px]">
                                    <span class="block text-xs font-bold text-gray-500 uppercase">{new Date(a.appointment_date + 'T00:00:00').toLocaleDateString('es-CO', {month: 'short'})}</span>
                                    <span class="block text-lg font-bold text-gray-900 leading-none">{new Date(a.appointment_date + 'T00:00:00').getDate()}</span>
                                </div>
                                <div>
                                    <p class="text-sm font-bold text-gray-900">{a.services?.name}</p>
                                    <p class="text-xs text-gray-500">üïí {a.appointment_time.slice(0,5)} - Dr. {a.dentists?.name?.split(' ')[0]}</p>
                                </div>
                                <div class="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity bg-white/90 rounded-md shadow-sm p-0.5">
                                    <button class="text-blue-500 hover:bg-blue-50 p-1 rounded edit-appt-btn" 
                                        data-id={a.id} data-date={a.appointment_date} data-time={a.appointment_time} title="Editar">
                                        <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                                    </button>
                                    <button class="text-red-500 hover:bg-red-50 p-1 rounded delete-appt-btn" 
                                        data-id={a.id} title="Eliminar">
                                        <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                    </button>
                                </div>
                            </div>
                        ))
                    ) : (
                        <div class="text-center py-4">
                            <p class="text-sm text-gray-400">No hay citas futuras</p>
                            <button id="quick-book-btn" class="text-xs text-brand-600 font-bold hover:underline cursor-pointer">Agendar ahora</button>
                        </div>
                    )}
                </div>
            </div>

            <div class="pt-4"><button id="delete-patient-btn" class="w-full flex items-center justify-center gap-2 p-3 text-red-600 bg-red-50 hover:bg-red-100 border border-red-200 rounded-xl text-sm font-bold transition-colors"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg>Eliminar Paciente</button></div>
        </div>

        <!-- CONTENIDO CENTRAL -->
        <div class="lg:col-span-2">
            
            <div id="tab-history" class="tab-content block space-y-6">
                <!-- HEADER FILTROS -->
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 space-y-3">
                    <div class="flex justify-between items-center">
                        <div>
                            <h2 class="font-bold text-gray-800">Evoluciones M√©dicas</h2>
                            <button id="export-history-btn" class="text-xs text-brand-600 hover:underline flex items-center gap-1 mt-1">
                                <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg> Excel
                            </button>
                        </div>
                        <button id="add-evolution-btn" class="bg-brand-600 text-white px-4 py-2 rounded-lg font-bold text-sm shadow-md shadow-brand-200 hover:bg-brand-700 transition-all flex items-center gap-2"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>Agregar Nota</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 pt-2 border-t border-gray-100">
                        <input id="search-notes" type="text" placeholder="Buscar palabras clave..." class="w-full text-xs border-gray-200 rounded-lg bg-gray-50 focus:bg-white focus:ring-brand-500">
                        <select id="filter-type" class="w-full text-xs border-gray-200 rounded-lg bg-gray-50 focus:bg-white focus:ring-brand-500">
                            <option value="all">Todos los Tipos</option>
                            <option value="Evoluci√≥n">Evoluci√≥n</option>
                            <option value="Anamnesis">Anamnesis</option>
                            <option value="Diagn√≥stico">Diagn√≥stico</option>
                            <option value="Procedimiento">Procedimiento</option>
                            <option value="Prescripci√≥n">Prescripci√≥n</option>
                            <option value="odontogram">Odontograma</option>
                        </select>
                        <select id="filter-doctor" class="w-full text-xs border-gray-200 rounded-lg bg-gray-50 focus:bg-white focus:ring-brand-500">
                            <option value="all">Todos los Doctores</option>
                        </select>
                    </div>
                </div>
                
                <!-- TIMELINE -->
                <div id="timeline-container" class="relative pl-8 border-l-2 border-gray-200 space-y-8 min-h-[200px]"></div>
                <div id="timeline-pagination" class="flex justify-between items-center text-xs text-gray-500 pt-4 border-t border-gray-100 hidden">
                    <span id="timeline-info">Mostrando 0-0 de 0</span>
                    <div class="flex gap-2">
                        <button id="tl-prev" class="px-3 py-1 bg-white border rounded hover:bg-gray-50 disabled:opacity-50">Anterior</button>
                        <button id="tl-next" class="px-3 py-1 bg-white border rounded hover:bg-gray-50 disabled:opacity-50">Siguiente</button>
                    </div>
                </div>
            </div>

            <!-- TAB 2: ODONTOGRAMA (MEJORADO) -->
            <div id="tab-odontogram" class="tab-content hidden">
                
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5 mb-6">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-4">
                        <div>
                            <h2 class="font-bold text-gray-800 text-lg flex items-center gap-2">ü¶∑ Odontograma Interactivo</h2>
                            <p class="text-xs text-gray-500 mt-1">Toca un diente para diagnosticar.</p>
                        </div>
                        <div class="flex gap-2">
                             <!-- Bot√≥n para guardar el estado actual (Snapshot) -->
                            <button id="save-odontogram-btn" class="px-4 py-2 bg-teal-600 text-white rounded-lg font-bold text-sm shadow-md hover:bg-teal-700 transition-all flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" /></svg> 
                                Guardar Cambios
                            </button>
                            <button
                            id="view-history-btn"
                            class="px-4 py-2 bg-slate-100 text-slate-700 rounded-lg font-bold text-sm border hover:bg-slate-200 transition-all flex items-center gap-2"
                            >
                            üìú Ver Historial
                            </button>
                            <!-- üß¨ NUEVO: Versionado legal del plan -->
                            <button id="view-legal-versions-btn"
                            class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1.5 rounded-lg text-sm font-semibold shadow">
                            üß¨ Versiones del Plan
                            </button>
                        </div>
                    </div>

                    <!-- LEYENDA -->
                    <div class="flex flex-wrap gap-3 text-xs text-gray-600 pb-4 border-b border-gray-100">
                        <div class="flex items-center gap-1.5"><span class="w-3 h-3 rounded-full bg-white border-2 border-gray-300"></span> Sano</div>
                        <div class="flex items-center gap-1.5"><span class="w-3 h-3 rounded-full bg-red-500"></span> Caries</div>
                        <div class="flex items-center gap-1.5"><span class="w-3 h-3 rounded-full bg-blue-500"></span> Resina</div>
                        <div class="flex items-center gap-1.5"><span class="w-3 h-3 rounded-full bg-yellow-400"></span> Corona</div>
                        <div class="flex items-center gap-1.5"><span class="w-3 h-3 rounded-full bg-gray-800"></span> Ausente</div>
                        <div class="flex items-center gap-1.5"><span class="w-3 h-3 rounded-full bg-purple-500"></span> Endodoncia</div>
                    </div>

                    <!-- ‚ö†Ô∏è ZONA DE ALERTAS INTELIGENTES (Se llena con JS) -->
                    <div id="clinical-alerts" class="mt-4 hidden space-y-2 animate-fade-in">
                        <!-- Aqu√≠ JS inyectar√°: "Detectamos 3 caries. Crear Plan ($240)?" -->
                    </div>
                </div>

                <!-- LIENZO -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 overflow-x-auto">
                    <div id="odontogram-canvas" class="min-w-[600px] flex flex-col gap-8 items-center select-none"></div>
                </div>

                <!-- üîç HALLAZGOS DETECTADOS AUTOM√ÅTICAMENTE -->
                <div 
                id="findings-panel"
                class="mt-6 space-y-3 hidden"
                >
                </div>

                <!-- üîÆ PLAN PROPUESTO AUTOM√ÅTICO (NO PERSISTIDO) -->
                <div 
                id="auto-treatment-plan"
                class="bg-blue-50 border border-blue-200 rounded-xl p-5 mb-6 hidden"
                >
                <!-- JS renderiza aqu√≠ -->
                </div>

                
                <!-- PLAN DE TRATAMIENTO & PRESUPUESTO -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mt-6">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h3 class="font-bold text-gray-800 text-lg">Plan de Tratamiento</h3>
                            <p class="text-xs text-gray-500">Presupuesto y procedimientos</p>
                        </div>

                        <div class="flex gap-2">
                            <button id="create-treatment-plan-btn"
                                class="px-4 py-2 bg-brand-600 text-white rounded-lg font-bold text-sm shadow-md hover:bg-brand-700 transition-all flex items-center gap-2">
                                <svg class="w-4 h-4" ...></svg>
                                Agregar Manual
                            </button>

                            <!-- üß† NUEVO BOT√ìN -->
                            <button id="approve-plan-btn"
                                class="px-4 py-2 bg-emerald-600 text-white rounded-lg font-bold text-sm shadow-md hover:bg-emerald-700 transition-all flex items-center gap-2 hidden">
                                ‚úî Aprobar Plan
                            </button>
                        </div>
                    </div>
                    
                    {pendingTreatments.length > 0 && (
                        <div class="mb-4 bg-orange-50 border border-orange-200 rounded-lg p-4 flex justify-between items-center">
                            <div class="flex items-center gap-2">
                                <span class="bg-orange-100 text-orange-700 p-2 rounded-full">üí∞</span>
                                <div>
                                    <p class="text-xs text-orange-800 font-bold uppercase">Presupuesto Pendiente</p>
                                    <p class="text-xs text-orange-600">{pendingTreatments.length} procedimientos</p>
                                </div>
                            </div>
                            <span class="text-2xl font-bold text-orange-900">{formatCOP(totalPendingCost)}</span>
                        </div>
                    )}

                    <div id="treatments-list" class="space-y-3">
                        {treatmentPlans && treatmentPlans.length > 0 ? (
                            treatmentPlans.map(t => (
                                <div class={`p-4 rounded-lg border-2 transition-all hover:shadow-md ${t.priority === 'urgent' ? 'bg-red-50 border-red-200 text-red-700' : 'bg-white border-gray-100'}`}>
                                    <div class="flex justify-between items-start mb-2">
                                        <div class="flex-1">
                                            <div class="flex items-center gap-2 mb-1">
                                                {t.priority === 'urgent' && <span class="text-[10px] bg-red-600 text-white px-2 py-0.5 rounded font-bold">URGENTE</span>}
                                                <span class="text-[10px] font-bold uppercase text-gray-500 bg-gray-100 px-2 py-0.5 rounded">{t.status}</span>
                                            </div>
                                            <h4 class="font-bold text-gray-900">ü¶∑ Diente {t.tooth_number} - {t.treatment_type}</h4>
                                            <p class="text-sm text-gray-600 mt-1"><strong>Dx:</strong> {t.diagnosis}</p>
                                        </div>
                                        <div class="text-right">
                                            <p class="text-lg font-bold text-gray-900">{formatCOP(t.estimated_cost)}</p>
                                        </div>
                                    </div>
                                    
                                    <!-- Botones de Acci√≥n R√°pida -->
                                    
                                    <!-- Botones de Acci√≥n R√°pida -->
                                    
                                    <!-- 1. ESTADO BORRADOR (CORREGIDO: Quitamos !hasApprovedPlan) -->
                                    {['draft','pending'].includes(t.status) && (
                                        <div class="flex gap-2 mt-3 pt-3 border-t border-gray-200/50">
                                            <button
                                                class="flex-1 px-3 py-1.5 bg-white border border-gray-300 text-gray-700 rounded-lg text-xs font-bold hover:bg-gray-50 transition-colors schedule-treatment-btn"
                                                data-id={t.id}
                                                data-service-id={t.services?.id || ''}
                                                data-service-name={t.services?.name || ''}
                                                data-dentist-id={t.dentist_id || ''}
                                            >
                                                üìÖ Agendar
                                            </button>

                                            <button
                                                class="px-3 py-1.5 bg-blue-50 text-blue-600 rounded-lg text-xs font-bold hover:bg-blue-100 edit-treatment-btn"
                                                data-id={t.id}
                                            >
                                                ‚úèÔ∏è
                                            </button>

                                            <button
                                                class="px-3 py-1.5 bg-red-50 text-red-600 rounded-lg text-xs font-bold hover:bg-red-100 delete-treatment-btn"
                                                data-id={t.id}
                                            >
                                                üóëÔ∏è
                                            </button>
                                        </div>
                                    )}

<!-- 2. ESTADO APROBADO ... (El resto sigue igual) -->

                                    <!-- 2. ESTADO APROBADO (Nueva funcionalidad: Ejecutar) -->
                                    {t.status === 'approved' && (
                                        <div class="mt-3 pt-3 border-t border-gray-200/50">
                                            <button 
                                                class="w-full px-3 py-2 bg-brand-600 text-white rounded-lg text-xs font-bold hover:bg-brand-700 shadow-sm flex items-center justify-center gap-2 execute-treatment-btn"
                                                data-id={t.id}
                                                data-tooth={t.tooth_number}
                                                data-treatment={t.treatment_type}
                                            >
                                                ‚ö° Realizar Procedimiento
                                            </button>
                                        </div>
                                    )}

                                    <!-- 3. ESTADO COMPLETADO (Visualizaci√≥n) -->
                                    {t.status === 'completed' && (
                                        <div class="mt-3 pt-3 border-t border-gray-200/50">
                                            <div class="w-full px-3 py-1.5 bg-green-50 text-green-700 border border-green-200 rounded-lg text-xs font-bold text-center flex items-center justify-center gap-2 cursor-default">
                                                ‚úÖ Realizado el {new Date(t.completed_at || t.created_at).toLocaleDateString()}
                                            </div>
                                        </div>
                                    )}

                                </div>
                            ))
                        ) : (
                            <div class="text-center py-8 bg-gray-50 rounded-lg border-2 border-dashed border-gray-200"><p class="text-gray-500 font-medium">No hay plan de tratamiento activo.</p></div>
                        )}
                    </div>
                </div>
            </div>

            <div id="tab-info" class="tab-content hidden bg-white rounded-xl shadow-sm border border-gray-100 p-8">
                <h3 class="text-lg font-bold text-gray-900 mb-6 border-b pb-2">Ficha del Paciente</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div><label class="block text-xs font-bold text-gray-400 uppercase">Nombre Completo</label><p class="text-gray-900 font-medium">{patient.full_name}</p></div>
                    <div><label class="block text-xs font-bold text-gray-400 uppercase">Documento</label><p class="text-gray-900 font-medium">{patient.document_id || '-'}</p></div>
                    <div><label class="block text-xs font-bold text-gray-400 uppercase">Fecha Nacimiento</label><p class="text-gray-900 font-medium">{patient.birth_date || '-'}</p></div>
                    <div><label class="block text-xs font-bold text-gray-400 uppercase">G√©nero</label><p class="text-gray-900 font-medium capitalize">{patient.gender || '-'}</p></div>
                    <div><label class="block text-xs font-bold text-gray-400 uppercase text-red-500">Alergias</label><p class="text-red-600 font-bold">{patient.allergies || 'Ninguna conocida'}</p></div>
                    <div class="md:col-span-2"><label class="block text-xs font-bold text-gray-400 uppercase">Direcci√≥n</label><p class="text-gray-900 font-medium">{patient.address || '-'}</p></div>
                </div>
            </div>

            <div id="tab-files" class="tab-content hidden">
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-8 text-center">
                    <!-- üî• ZONA DE CARGA DE ARCHIVOS -->
                    <div class="w-16 h-16 bg-gray-50 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" /></svg>
                    </div>
                    <h3 class="font-bold text-gray-900">Archivos y Radiograf√≠as</h3>
                    <div class="bg-blue-50 border border-blue-100 rounded-lg p-3 my-4 text-left max-w-md mx-auto">
                        <p class="text-xs text-blue-800 font-bold mb-1">‚ÑπÔ∏è Informaci√≥n:</p>
                        <ul class="text-xs text-blue-600 list-disc list-inside space-y-1"><li>Formatos: JPG, PNG, PDF.</li><li>Peso m√°x: 5MB.</li></ul>
                    </div>
                    
                    <!-- Input oculto y bot√≥n activador -->
                    <input type="file" id="file-upload" class="hidden" accept=".jpg,.jpeg,.png,.pdf" />
                    <button id="upload-btn" class="bg-gray-800 text-white px-5 py-2 rounded-lg font-bold text-sm hover:bg-black transition-colors flex items-center gap-2 mx-auto">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                        Subir Archivo
                    </button>

                    <!-- Lista de Archivos -->
                    <div class="mt-8 grid grid-cols-2 md:grid-cols-3 gap-4 text-left">
                        {attachments && attachments.length > 0 ? (
                            attachments.map(f => (
                                <div class="p-3 border border-gray-200 rounded-lg hover:border-brand-500 cursor-pointer transition-colors group relative file-card" data-path={f.file_url}>
                                    <div class="flex items-center gap-2 mb-2">
                                        {f.file_type === 'application/pdf' ? 
                                            <svg class="w-5 h-5 text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd" /></svg> :
                                            <svg class="w-5 h-5 text-blue-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd" /></svg>
                                        }
                                        <span class="text-xs font-bold text-gray-700 truncate">{f.file_name}</span>
                                    </div>
                                    <span class="text-[10px] text-gray-400">{new Date(f.created_at).toLocaleDateString()}</span>
                                    <!-- Bot√≥n Borrar Archivo -->
                                    <button class="absolute top-1 right-1 p-1 bg-white rounded-full text-gray-300 hover:text-red-500 hover:bg-red-50 shadow-sm delete-file-btn opacity-0 group-hover:opacity-100 transition-opacity" data-id={f.id} data-path={f.file_url}>
                                        <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                                    </button>
                                </div>
                            ))
                        ) : null}
                    </div>
                </div>
            </div>

        </div>
    </div>
  </div>

  <!-- DATOS JSON OCULTOS PARA JS -->
  <!-- DATOS JSON OCULTOS (Puente Server -> Client) -->
  <div 
    id="page-data" 
    data-patient-id={id} 
    data-business-id={patient.business_id}
    data-dentists={JSON.stringify(dentistsList)}
    data-services={JSON.stringify(servicesList)}
    data-records={JSON.stringify(records)}
    data-master-odontogram={JSON.stringify(masterOdontogram)}
    data-has-approved-plan={hasApprovedPlan}
    data-treatment-plans={JSON.stringify(treatmentPlans)}     
    data-patient-info={JSON.stringify({name: patient.full_name, doc: patient.document_id, phone: patient.phone, email: patient.email})}
    data-branding={JSON.stringify({name: businessData?.name || "Cl√≠nica Dental", color: businessData?.primary_color || "#2563EB", logo: businessData?.logo_url || "", address: businessData?.address || ""})} 
  ></div>

</AdminLayout>

<script>
  import Swal from "sweetalert2";
  import { supabase } from "../../../lib/supabase";

  // ==========================================
  // 1. VARIABLES GLOBALES (SINGLE SOURCE OF TRUTH)
  // ==========================================
  const pageData = document.getElementById('page-data');

  const treatmentPlans = JSON.parse(pageData?.dataset.treatmentPlans || '[]');

    const approveBtn = document.getElementById('approve-plan-btn');

    if (approveBtn) {
    const hasDraft = treatmentPlans.some(t => t.status === 'draft');
    if (hasDraft) approveBtn.classList.remove('hidden');
    }
    
  
  const patientId = pageData?.dataset.patientId;
  const businessId = pageData?.dataset.businessId;

  
  
  // Parseo seguro de datos
  const dentists = JSON.parse(pageData?.dataset.dentists || '[]');
  const services = JSON.parse(pageData?.dataset.services || '[]');
  const records = JSON.parse(pageData?.dataset.records || '[]');
  const patientInfo = JSON.parse(pageData?.dataset.patientInfo || '{}');
  const branding = JSON.parse(pageData?.dataset.branding || '{}');
  const masterOdontogramData = JSON.parse(pageData?.dataset.masterOdontogram || 'null');
  // Inicializamos el estado con lo que viene de la BD (Capa 1)
  let mouthState = masterOdontogramData?.teeth_state || {};
  // ==========================================
    // üß† MOTOR CL√çNICO ‚Äî FUENTE DE VERDAD
    // ==========================================
    const clinicalEngineState = {
    findings: [],
    problems: [],
    hasApprovedPlan: false
    };

    // üîç Exponer SOLO para debug
    (window as any).clinicalEngineState = clinicalEngineState;

     const hasApprovedPlanFromServer =
    pageData?.dataset.hasApprovedPlan === 'true';
    clinicalEngineState.hasApprovedPlan = hasApprovedPlanFromServer;
    console.log('üß† Plan aprobado (server):', hasApprovedPlanFromServer);

  

  // Llenar filtro de doctores en el Header de Evoluciones
  const doctorFilter = document.getElementById('filter-doctor') ;
  if(doctorFilter) {
      dentists.forEach((d: any) => {
          const opt = document.createElement('option');
          opt.value = d.name; 
          opt.textContent = d.name; 
          doctorFilter.appendChild(opt);
      });
  }

  declare global {
  interface Window {
    viewOdontogramSnapshot: (recordJson: string) => void;
  }
}

// utils/money.ts
export const formatCOP = (value: number | string) =>
  `$${Number(value || 0).toLocaleString('es-CO')}`;


  // ==========================================
  // 2. L√ìGICA DE PESTA√ëAS (TABS)
  // ==========================================
  const tabBtns = document.querySelectorAll('.tab-btn');
  const tabContents = document.querySelectorAll('.tab-content');

  function switchTab(targetId: string) {
      // 0. Guardar la pesta√±a actual en memoria para que sobreviva al reload
      localStorage.setItem('activeTab', targetId);

      // 1. Ocultar todos los contenidos
      tabContents.forEach(c => c.classList.add('hidden'));
      
      // 2. Resetear estilos de botones
      tabBtns.forEach(b => { 
          b.classList.remove('bg-brand-50', 'text-brand-700', 'border-l-4', 'border-brand-600'); 
          b.classList.add('text-gray-600'); 
      });

      // 3. Activar contenido seleccionado
      const targetContent = document.getElementById(targetId);
      if (targetContent) {
          targetContent.classList.remove('hidden');
          targetContent.classList.add('animate-fade-in');
      }

      // 4. Activar bot√≥n correspondiente
      const activeBtn = document.querySelector(`[data-target="${targetId}"]`);
      if (activeBtn) {
          activeBtn.classList.remove('text-gray-600');
          activeBtn.classList.add('bg-brand-50', 'text-brand-700', 'border-l-4', 'border-brand-600');
      }
      
      // üî• CORRECCI√ìN: Si es odontograma, solo repintar colores, NO reiniciar estructura
      if(targetId === 'tab-odontogram') {
          requestAnimationFrame(() => updateVisuals());
      }
  }

  // Listeners para tabs
  tabBtns.forEach(btn => {
      btn.addEventListener('click', (e) => {
          const target = (e.currentTarget as HTMLElement).dataset.target;
          if(target) switchTab(target);
      });
  });

  // Activar primera tab por defecto al cargar
  //switchTab('tab-history');


 // ==========================================
  // 3. MOTOR GR√ÅFICO PREMIUM (CORREGIDO - NO M√ÅS CUADROS NEGROS)
  // ==========================================
  
  const TOOTH_GEO = {
    top: "10,10 50,10 40,20 20,20",      
    bottom: "50,50 10,50 20,40 40,40",   
    left: "10,50 20,40 20,20 10,10",     
    right: "50,10 50,50 40,40 40,20",    
    center: "20,20 40,20 40,40 20,40",   
    absent1: "10,15 15,10 50,45 45,50", 
    absent2: "45,10 50,15 15,50 10,45",
    implant: "50,10 40,10 10,26 10,32 46,32 10,50 20,50 50,36 50,28 14,28" 
  };

  // üî• FIX CR√çTICO: fill="none" y opacity:0 en capas para evitar cuadros negros
  const renderTooth = (num, x, y) => `
    <g transform="translate(${x}, ${y})" class="tooth-group" id="tooth-${num}" data-tooth="${num}">
        <text x="30" y="-8" class="tooth-label">${num}</text>
        
        <!-- CAPA 1: Superficies Blancas (Base) -->
        <polygon points="${TOOTH_GEO.top}" class="tooth-surface" data-part="top" fill="white" stroke="#94a3b8" stroke-width="1"></polygon>
        <polygon points="${TOOTH_GEO.bottom}" class="tooth-surface" data-part="bottom" fill="white" stroke="#94a3b8" stroke-width="1"></polygon>
        <polygon points="${TOOTH_GEO.left}" class="tooth-surface" data-part="left" fill="white" stroke="#94a3b8" stroke-width="1"></polygon>
        <polygon points="${TOOTH_GEO.right}" class="tooth-surface" data-part="right" fill="white" stroke="#94a3b8" stroke-width="1"></polygon>
        <polygon points="${TOOTH_GEO.center}" class="tooth-surface" data-part="center" fill="white" stroke="#94a3b8" stroke-width="1"></polygon>
        
        <!-- CAPA 2: Ausente (X Gris Oscura) - Oculta por defecto -->
        <g class="layer-ausente" style="opacity: 0; pointer-events: none;">
             <polygon points="${TOOTH_GEO.absent1}" fill="#1f2937"></polygon>
             <polygon points="${TOOTH_GEO.absent2}" fill="#1f2937"></polygon>
        </g>

        <!-- CAPA 3: Corona (C√≠rculo Dorado) - Oculta por defecto -->
        <circle cx="30" cy="30" r="18" class="layer-corona" fill="none" stroke="#eab308" stroke-width="3" style="opacity: 0; pointer-events: none;"></circle>
        
        <!-- CAPA 4: Endodoncia (C√≠rculo Morado) - Oculta por defecto -->
        <circle cx="30" cy="30" r="10" class="layer-endo" fill="none" stroke="#a855f7" stroke-width="3" style="opacity: 0; pointer-events: none;"></circle>

        <!-- CAPA 5: Implante (Estructura Gris) - Oculta por defecto -->
        <polygon points="${TOOTH_GEO.implant}" class="layer-implante" fill="none" stroke="#475569" stroke-width="2" style="opacity: 0; pointer-events: none;"></polygon>
    </g>`;

  function initOdontogram() {
    const canvas = document.getElementById('odontogram-canvas');
    if (!canvas) return;

    // üî¢ Medidas reales del odontograma
    const TOOTH_REAL_WIDTH = 60;       // ancho real del diente (tu geometr√≠a)
    const SPACING = TOOTH_REAL_WIDTH + 5;

    const START_X = 40;
    const GAP_MIDDLE = 50;
    const ROW_HEIGHT = 160;

    // üìê ANCHO CALCULADO (NO fijo)
    const SVG_WIDTH =
        START_X +
        (8 * SPACING) +
        GAP_MIDDLE +
        (8 * SPACING) +
        START_X;

    let svgContent = `
<svg
  width="${SVG_WIDTH}"
  height="350"
  viewBox="0 0 ${SVG_WIDTH} 350"
  style="min-width:${SVG_WIDTH}px; display:block;"
>
`;

            [18,17,16,15,14,13,12,11].forEach((t, i) => {
        svgContent += renderTooth(t, START_X + i * SPACING, 40);
        });

        [21,22,23,24,25,26,27,28].forEach((t, i) => {
        svgContent += renderTooth(
            t,
            START_X + (8 * SPACING) + GAP_MIDDLE + i * SPACING,
            40
        );
        });

        [48,47,46,45,44,43,42,41].forEach((t, i) => {
        svgContent += renderTooth(t, START_X + i * SPACING, ROW_HEIGHT + 40);
        });

        [31,32,33,34,35,36,37,38].forEach((t, i) => {
        svgContent += renderTooth(
            t,
            START_X + (8 * SPACING) + GAP_MIDDLE + i * SPACING,
            ROW_HEIGHT + 40
        );
        });

    
    svgContent += '</svg>';
    canvas.innerHTML = `
        <div
  class="odontogram-inner"
  style="overflow-x:auto; width:100%;"
>
  <div style="width:${SVG_WIDTH}px">
    ${svgContent}
  </div>
</div>
        `;

    
    attachToothListeners();
    detectProblems();
  }

  function updateVisuals() {
      // 1. Resetear visuales (Forzar blanco y ocultar capas)
      document.querySelectorAll('.tooth-group').forEach(g => g.className.baseVal = 'tooth-group');
      document.querySelectorAll('.tooth-surface').forEach(s => {
          s.classList.remove('state-caries', 'state-resina', 'state-sellante');
          s.setAttribute('fill', 'white'); 
      });
      // Ocultar todas las capas expl√≠citamente
      document.querySelectorAll('.layer-ausente, .layer-corona, .layer-endo, .layer-implante').forEach(l => l.style.opacity = '0');

      // 2. Aplicar estado
      Object.keys(mouthState).forEach(key => {
          const status = mouthState[key];
          const [toothNum, part] = key.split('_');
          
          const group = document.getElementById(`tooth-${toothNum}`);
          if (!group) return;

          // Afecta capas (Manipulaci√≥n directa de estilo para garantizar visibilidad)
          if (status === 'ausente') {
              group.classList.add('has-ausente');
              group.querySelector('.layer-ausente').style.opacity = '1';
          } 
          else if (status === 'corona') {
              group.classList.add('has-corona');
              group.querySelector('.layer-corona').style.opacity = '1';
          }
          else if (status === 'endodoncia') {
              group.classList.add('has-endodoncia');
              group.querySelector('.layer-endo').style.opacity = '1';
          }
          else if (status === 'implante') {
              group.classList.add('has-implante');
              group.querySelector('.layer-implante').style.opacity = '1';
          }
          // Afecta superficies (Colores)
          else {
            const selectorPart = part || 'center';
            const surface = group.querySelector(
                `.tooth-surface[data-part="${selectorPart}"]`
            );

            if (!surface) return;

            if (status === 'caries') surface.setAttribute('fill', '#ef4444');
            if (status === 'resina') surface.setAttribute('fill', '#3b82f6');
            if (status === 'sellante') surface.setAttribute('fill', '#22c55e');
            }
      });
  }
  function attachToothListeners() {
    const canvas = document.getElementById('odontogram-canvas');
    // Limpiar listener previo asignando null antes (simple safety)
    canvas.onclick = null;
    
    canvas.onclick = async (e) => {
        const target = e.target;
        const group = target.closest('.tooth-group');
        if (!group) return;

        // üîí BLOQUEO CL√çNICO
        if (clinicalEngineState.hasApprovedPlan) {
        Swal.fire(
            'Plan aprobado',
            'No se pueden modificar dientes cuando existe un plan aprobado.',
            'info'
        );
        return;
        }


        const toothId = group.dataset.tooth;
        const part = target.dataset.part || 'center'; 
        
        const { value: selectedStatus } = await Swal.fire({
            title: `Diente ${toothId} - ${part.toUpperCase()}`,
            html: `
                <div class="grid grid-cols-2 gap-2 text-left">
                    <button class="swal-opt p-3 rounded border hover:bg-gray-50 flex items-center gap-2 font-bold text-gray-600" data-val="sano">‚ö™ Sano / Borrar</button>
                    <button class="swal-opt p-3 rounded border border-red-200 bg-red-50 flex items-center gap-2 text-red-700 font-bold" data-val="caries"><span class="w-3 h-3 bg-red-500 rounded-full"></span> Caries</button>
                    <button class="swal-opt p-3 rounded border border-blue-200 bg-blue-50 flex items-center gap-2 text-blue-700 font-bold" data-val="resina"><span class="w-3 h-3 bg-blue-500 rounded-full"></span> Resina</button>
                    <button class="swal-opt p-3 rounded border border-green-200 bg-green-50 flex items-center gap-2 text-green-700 font-bold" data-val="sellante"><span class="w-3 h-3 bg-green-500 rounded-full"></span> Sellante</button>
                    <div class="col-span-2 border-t my-1"></div>
                    <button class="swal-opt col-span-2 p-2 rounded border border-gray-800 bg-gray-100 flex items-center gap-2 font-bold" data-val="ausente">‚ùå Ausente</button>
                    <button class="swal-opt col-span-2 p-2 rounded border border-yellow-400 bg-yellow-50 flex items-center gap-2 font-bold text-yellow-800" data-val="corona">üëë Corona</button>
                    <button class="swal-opt col-span-2 p-2 rounded border border-purple-300 bg-purple-50 flex items-center gap-2 font-bold text-purple-800" data-val="endodoncia">üü£ Endodoncia</button>
                </div>
            `,
            showConfirmButton: false,
            showCancelButton: true,
            cancelButtonText: 'Cancelar',
            didOpen: (popup) => {
                popup.querySelectorAll('.swal-opt').forEach(btn => {
                    btn.addEventListener('click', () => {
                        Swal.close();
                        handleStatusChange(toothId, part, btn.dataset.val);
                    });
                });
            }
        });
    };
  }

  // Helper para manejar el cambio (Agregar esta funci√≥n nueva debajo de attachToothListeners)
  // Helper para manejar el cambio
  function handleStatusChange(tooth, part, status) {
      // üîí VALIDACI√ìN DE SEGURIDAD (Defensa en profundidad)
      if (clinicalEngineState.hasApprovedPlan) {
          console.warn('üö´ Modificaci√≥n bloqueada: Existe un plan aprobado.');
          return;
      }

      const key = `${tooth}_${part}`;
      
      if (status === 'sano') {
          delete mouthState[key];
          if (part === 'center') { // Si limpia centro, limpia estados globales
             const globalStates = ['ausente', 'corona', 'endodoncia', 'implante'];
             if(globalStates.includes(mouthState[`${tooth}_center`])) delete mouthState[`${tooth}_center`];
          }
      } else {
          // Si es estado global, asignar a 'center'
          if (['ausente', 'corona', 'endodoncia', 'implante'].includes(status)) {
              mouthState[`${tooth}_center`] = status;
          } else {
              mouthState[key] = status;
          }
      }
      
      updateVisuals(); 
      detectProblems();
      
      // Activar bot√≥n guardar
      const saveBtn = document.getElementById('save-odontogram-btn');
      if (saveBtn) { saveBtn.classList.add('animate-pulse', 'ring-4', 'ring-teal-200'); saveBtn.innerHTML = 'üíæ Guardar Cambios *'; }
  }


  
// üéØ NUEVA FUNCI√ìN: Indicador de cambios pendientes
function detectProblems() {
    if (clinicalEngineState.hasApprovedPlan) return;

    const findingsMap = {};
    // Reglas de negocio (igual que antes)
    const rules = {
        caries: { text: 'Caries detectada', priority: 'urgent', serviceKey: 'Resinas' },
        corona: { text: 'Reemplazo de corona', priority: 'normal', serviceKey: 'Pr√≥tesis' },
        ausente: { text: 'Diente ausente', priority: 'normal', serviceKey: 'Implantes' },
        endodoncia: { text: 'Tratamiento de conducto', priority: 'urgent', serviceKey: 'Endodoncia' },
        implante: { text: 'Implante existente', priority: 'low', serviceKey: 'Control' } // Opcional
    };

    Object.entries(mouthState).forEach(([key, value]) => {
        if (!rules[value]) return;
        // Ignoramos implantes visuales si no queremos cobrarlos de nuevo, o los filtramos despu√©s
        if (value === 'implante') return; 

        const [tooth] = key.split('_');
        if (findingsMap[tooth]) return;

        const rule = rules[value];
        findingsMap[tooth] = {
            tooth,
            type: value,
            description: rule.text,
            priority: rule.priority,
            serviceKey: rule.serviceKey
        };
    });

    // Resolvemos precios
    const rawFindings = Object.values(findingsMap);
    let enrichedFindings = resolveServices(rawFindings, services);

    // üî• L√ìGICA DELTA: Marcar qu√© hallazgos YA est√°n en el plan (DB)
    // Comparamos Diente y Tipo de tratamiento (aproximado)
    enrichedFindings = enrichedFindings.map(f => {
        const existsInPlan = treatmentPlans.some((t: any) => 
            // Coincide n√∫mero de diente
            t.tooth_number === f.tooth && 
            // Coincide el estado (borradores o pendientes)
            ['draft', 'pending'].includes(t.status) &&
            // Coincide el tipo (B√∫squeda laxa para evitar duplicados estrictos)
            (t.treatment_type.toLowerCase().includes(f.serviceKey.toLowerCase()) || 
             t.diagnosis === f.description)
        );
        
        return { ...f, isSynced: existsInPlan };
    });

    // Guardamos estado
    clinicalEngineState.findings = enrichedFindings;
    
    // UI
    renderFindings(enrichedFindings);
    // renderTreatmentPlanSummary(); // Ya no es tan necesario si la barra amarilla es inteligente
}



function resolveServices(findings, services) {
    return findings.map(f => {
        const service = services.find(s =>
            s.name.toLowerCase().includes(f.serviceKey.toLowerCase())
        );

        return {
            ...f,
            serviceId: service?.id || null,
            serviceName: service?.name || 'Servicio no configurado',
            price: service ? Number(service.price) : 0
        };
    });
}

function mapFindingsToProblems(findings) {
    return findings.map(f => ({
        tooth: f.tooth,
        issue: f.description,
        treatment: f.serviceName,
        priority: f.priority,
        cost: f.price
    }));
}

function createTreatmentPlanFromFindings(findings) {
  const problems = mapFindingsToProblems(findings);

  console.log('üß† Plan generado autom√°ticamente:', problems);
  clinicalEngineState.problems = problems;
  renderTreatmentPlanSummary(); 

  if (!problems.length) {
    Swal.fire('Sin tratamientos', 'No hay hallazgos v√°lidos para crear un plan', 'info');
    return;
  }

  createAutoPlan(problems);
}


function renderFindings(findings) {
  const container = document.getElementById('clinical-alerts');
  if (!container) return;

  container.innerHTML = '';

  // Filtramos planes activos (solo borradores para sumar en la barra amarilla)
  const drafts = treatmentPlans.filter((t: any) => ['draft', 'pending'].includes(t.status));

  // Si no hay hallazgos visuales NI borradores, ocultamos (a menos que haya aprobado, que mostramos status)
  if (!findings.length && drafts.length === 0 && !clinicalEngineState.hasApprovedPlan) {
    container.classList.add('hidden');
    return;
  }

  container.classList.remove('hidden');

  const urgentCount = findings.filter(f => f.priority === 'urgent').length;
  
  // üî• C√ÅLCULO DE TOTAL (Prioridad a los Drafts existentes)
  let displayTotal = 0;
  
  if (drafts.length > 0) {
      // Sumamos los borradores de la BD (que tienen precios editados)
      displayTotal = drafts.reduce((sum: number, t: any) => sum + (Number(t.estimated_cost) || 0), 0);
  } else {
      // Si no hay borradores, sumamos los hallazgos visuales nuevos
      // (Filtramos los que ya est√°n aprobados/completados para no duplicar visualmente)
      // Esta l√≥gica es compleja, simplificamos a sumar todo lo visual no sincronizado:
      const newFindings = findings.filter(f => !f.isSynced); 
      displayTotal = newFindings.reduce((sum, f) => sum + (f.price || 0), 0);
  }

  // üî• L√ìGICA DE BOTONES (Prioridad H√≠brida)
  let actionButton = '';
  
  // 1. Si hay borradores, SIEMPRE mostrar que hay un plan en curso (aunque haya aprobados viejos)
  if (drafts.length > 0) {
      actionButton = `<span class="text-xs text-brand-600 font-bold bg-brand-50 px-2 py-1 rounded flex items-center gap-1">
        üìù Editando (${drafts.length} √≠tems)
      </span>`;
  } 
  // 2. Si hay nuevos hallazgos visuales (no guardados), permitir agregarlos
  else if (findings.some(f => !f.isSynced)) {
      actionButton = `
        <button
          id="auto-create-treatment-btn"
          class="px-4 py-2 bg-brand-600 text-white rounded-lg font-bold text-sm hover:bg-brand-700 transition shadow-sm flex items-center gap-2"
        >
          <span>‚ûï</span> Agregar al Plan
        </button>`;
  }
  // 3. Si no hay nada nuevo y hay aprobados, mostrar estado
  else if (clinicalEngineState.hasApprovedPlan) {
       actionButton = `<span class="px-3 py-1.5 bg-gray-100 text-gray-500 rounded-lg text-xs font-bold border border-gray-200">üîí Plan Aprobado</span>`;
  }

  container.innerHTML = `
    <div class="flex justify-between items-center bg-amber-50 border border-amber-200 rounded-lg p-4 transition-all shadow-sm">
      <div>
        <p class="text-sm font-bold text-amber-800 flex items-center gap-2">
          üîç Diagn√≥stico Actual
        </p>
        <p class="text-xs text-amber-600">
          ${drafts.length > 0 ? '√çtems en borrador pendientes de aprobar' : 'Hallazgos visuales detectados'}
        </p>
      </div>

      <div class="flex items-center gap-6">
        <div class="text-right">
            <p class="text-[10px] text-amber-600 uppercase font-bold tracking-wider">
               ${drafts.length > 0 ? 'Total Borrador' : 'Estimado Visual'}
            </p>
            <span class="text-2xl font-bold text-amber-900 leading-none">
              ${formatCOP(displayTotal)}
            </span>
        </div>
        ${actionButton}
      </div>
    </div>
  `;

  // Listener para el bot√≥n de agregar
  const btn = document.getElementById('auto-create-treatment-btn');
  if (btn) {
      btn.addEventListener('click', () => {
          const newOnly = findings.filter(f => !f.isSynced);
          createTreatmentPlanFromFindings(newOnly);
      });
  }
}

function renderTreatmentPlanSummary() {
  const container = document.getElementById('treatment-plan-summary');
  if (!container) return;

  const problems = clinicalEngineState.problems;

  if (!problems.length) {
    container.innerHTML = `
      <p class="text-sm text-gray-400 italic">
        No hay tratamientos propuestos a√∫n
      </p>
    `;
    return;
  }

  const totalCost = problems.reduce((sum, p) => sum + (p.cost || 0), 0);

  container.innerHTML = `
    <div class="flex justify-between items-center">
      <p class="text-sm font-bold text-gray-700">
        ${problems.length} tratamientos propuestos
      </p>
      <p class="text-lg font-extrabold text-brand-600">
        $${totalCost.toLocaleString('es-CO')}
      </p>
    </div>
  `;
}


  // Llamar a detectProblems() dentro de initOdontogram() y en los clicks de los dientes
// ==========================================
  // 5. PLAN DE TRATAMIENTO
  // ==========================================
  
  // üî• PEGA LA FUNCI√ìN AQU√ç (ESTE ES EL LUGAR CORRECTO):
// üî• CORRECCI√ìN: Guardar estado visual junto con el plan
  async function createAutoPlan(problems) {
      // Generar opciones de dentistas
      let dentistOptions = '';
      dentists.forEach((d: any) => dentistOptions += `<option value="${d.id}">${d.name}</option>`);

      // Detectar si es una actualizaci√≥n o un plan nuevo para cambiar el texto
      const isUpdate = treatmentPlans.length > 0;
      const title = isUpdate ? '‚ûï Agregar al Plan' : '‚ú® Crear Plan de Tratamiento';
      const confirmText = isUpdate ? 'S√≠, agregar' : 'S√≠, crear plan';

      const result = await Swal.fire({
          title: title,
          html: `
              <div class="text-left">
                  <p class="text-sm text-gray-500 mb-2">Responsable del Diagn√≥stico:</p>
                  <select id="plan-author" class="swal2-input m-0 mb-4 w-full text-sm">
                      ${dentistOptions}
                  </select>

                  <p class="mb-2 text-sm text-gray-600 font-bold">Nuevos procedimientos a agregar:</p>
                  <ul class="space-y-2 text-sm max-h-40 overflow-y-auto border border-gray-100 rounded p-2 bg-gray-50">
                      ${problems.map(p => `
                          <li class="flex justify-between items-center border-b border-gray-100 pb-1 last:border-0">
                              <span>ü¶∑ ${p.tooth} - ${p.treatment}</span>
                              <span class="font-bold">${formatCOP(p.cost)}</span>
                          </li>
                      `).join('')}
                  </ul>
                  <div class="mt-4 pt-2 border-t border-gray-200 flex justify-between items-center">
                      <span class="text-sm text-gray-500">Valor a adicionar:</span>
                      <span class="text-lg font-bold text-brand-600">${formatCOP(problems.reduce((sum, p) => sum + p.cost, 0))}</span>
                  </div>
              </div>
          `,
          icon: 'info',
          showCancelButton: true,
          confirmButtonText: confirmText,
          confirmButtonColor: 'rgb(var(--color-brand))',
          preConfirm: () => document.getElementById('plan-author').value
      });

      if (result.isConfirmed) {
          const selectedDentistId = result.value;
          Swal.fire({ title: 'Actualizando...', didOpen: () => Swal.showLoading(), showConfirmButton: false });
          
          try {
              // 1. Insertar SOLO los nuevos tratamientos
              const treatments = problems.map(p => ({
                  patient_id: patientId,
                  business_id: businessId,
                  tooth_number: p.tooth,
                  diagnosis: p.issue,
                  treatment_type: p.treatment,
                  priority: p.priority,
                  estimated_cost: p.cost,
                  status: 'draft',
                  dentist_id: selectedDentistId
              }));

              const { error: planError } = await supabase.from('treatment_plans').insert(treatments);
              if (planError) throw planError;

              // 2. Actualizar el Odontograma Visual (Siempre guardamos el estado completo actual)
              const { error: odontoError } = await supabase.from('clinical_records').insert({
                  business_id: businessId,
                  patient_id: patientId,
                  record_type: 'odontogram',
                  description: isUpdate ? 'Adici√≥n de hallazgos al plan' : 'Creaci√≥n de plan inicial',
                  data: mouthState, 
                  dentist_id: selectedDentistId
              });

              if (odontoError) throw odontoError;

              await Swal.fire({ icon: 'success', title: 'Plan Actualizado', timer: 1500, showConfirmButton: false });
              window.location.reload();

          } catch (e) {
              console.error(e);
              Swal.fire('Error', 'No se pudieron guardar los cambios.', 'error');
          }
      }
  }

// ‚ö° HANDLER: APROBACI√ìN PARCIAL O TOTAL
document.getElementById('approve-plan-btn')?.addEventListener('click', async () => {

  // 1. Obtener borradores
  const drafts = treatmentPlans.filter((t: any) => t.status === 'draft');
  
  if (drafts.length === 0) {
    Swal.fire('Atenci√≥n', 'No hay tratamientos en borrador para aprobar', 'info');
    return;
  }

  // 2. Construir HTML de la lista con checkboxes
  let itemsHtml = '';
  let totalSum = 0;
  
  drafts.forEach((t: any) => {
      totalSum += Number(t.estimated_cost);
      // Checkbox pre-marcado
      itemsHtml += `
        <div class="flex items-center justify-between p-2 border-b border-gray-100 last:border-0 hover:bg-gray-50">
            <div class="flex items-center gap-3">
                <input type="checkbox" id="check-${t.id}" class="plan-checkbox w-5 h-5 text-brand-600 rounded focus:ring-brand-500" value="${t.id}" checked data-cost="${t.estimated_cost}">
                <label for="check-${t.id}" class="text-sm text-gray-700 cursor-pointer select-none">
                    <span class="font-bold text-xs bg-gray-100 px-1.5 py-0.5 rounded text-gray-500">${t.tooth_number || 'Gen'}</span>
                    ${t.treatment_type}
                </label>
            </div>
            <span class="text-sm font-bold text-gray-900">${formatCOP(t.estimated_cost)}</span>
        </div>
      `;
  });

  // 3. Modal de Selecci√≥n
  const result = await Swal.fire({
    title: 'üõ°Ô∏è Aprobar Plan de Tratamiento',
    html: `
      <p class="text-sm text-gray-500 mb-4 text-left">Selecciona los procedimientos que el paciente <b>acept√≥ realizarse</b> en esta fase:</p>
      
      <div class="border border-gray-200 rounded-lg max-h-60 overflow-y-auto mb-4 bg-white text-left">
        ${itemsHtml}
      </div>

      <div class="flex justify-between items-center bg-blue-50 p-3 rounded text-blue-900 font-bold">
        <span>Total Aprobado:</span>
        <span id="approval-total">${formatCOP(totalSum)}</span>
      </div>
      
      <div class="mt-3 text-xs text-gray-400 text-center">
        Los √≠tems no seleccionados permanecer√°n como borrador para el futuro.
      </div>
    `,
    width: '600px',
    showCancelButton: true,
    confirmButtonText: 'Aprobar Seleccionados',
    confirmButtonColor: '#059669',
    cancelButtonText: 'Cancelar',
    didOpen: () => {
        // L√≥gica para actualizar el total din√°micamente al desmarcar
        const checkboxes = document.querySelectorAll('.plan-checkbox');
        const totalLabel = document.getElementById('approval-total');
        
        checkboxes.forEach(box => {
            box.addEventListener('change', () => {
                let newTotal = 0;
                checkboxes.forEach((cb: any) => {
                    if (cb.checked) newTotal += Number(cb.dataset.cost);
                });
                if (totalLabel) totalLabel.innerText = `$${newTotal.toLocaleString('es-CO')}`;
            });
        });
    },
    preConfirm: () => {
        // Recolectar IDs seleccionados
        const selectedIds = [];
        document.querySelectorAll('.plan-checkbox:checked').forEach((cb: any) => {
            selectedIds.push(cb.value);
        });
        
        if (selectedIds.length === 0) {
            Swal.showValidationMessage('Debes seleccionar al menos un procedimiento');
            return false;
        }
        return selectedIds;
    }
  });

  if (!result.isConfirmed) return;

  const selectedIds = result.value;

  Swal.fire({ title: 'Aprobando...', text: 'Generando contrato digital...', didOpen: () => Swal.showLoading(), showConfirmButton: false });

  // 4. Llamada a la RPC Actualizada
  const { error } = await supabase.rpc('approve_plan_and_freeze', {
    p_business_id: businessId,
    p_patient_id: patientId,
    p_dentist_id: drafts[0]?.dentist_id ?? null,
    p_snapshot: structuredClone(mouthState),
    p_note: `Aprobaci√≥n parcial de plan (${selectedIds.length} procedimientos)`,
    p_treatment_ids: selectedIds // <--- Enviamos el array de IDs
  });

  if (error) {
    console.error(error);
    Swal.fire('Error', error.message, 'error');
    return;
  }

  await Swal.fire({ icon: 'success', title: 'Plan Aprobado', text: 'Los procedimientos seleccionados est√°n listos.', timer: 2000, showConfirmButton: false });
  window.location.reload();
});



document.addEventListener('click', async (e) => {
  const btn = e.target.closest('.delete-treatment-btn');
  if (!btn) return;

  if (clinicalEngineState.hasApprovedPlan) {
    Swal.fire('Plan aprobado', 'No se pueden modificar tratamientos', 'info');
    return;
  }

  const treatmentId = btn.dataset.id;

  const confirm = await Swal.fire({
    title: 'Eliminar tratamiento',
    text: 'Este cambio no se puede deshacer.',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: 'Eliminar',
    confirmButtonColor: '#dc2626'
  });

  if (!confirm.isConfirmed) return;

  const { error } = await supabase
    .from('treatment_plans')
    .delete()
    .eq('id', treatmentId);

  if (error) {
    Swal.fire('Error', error.message, 'error');
    return;
  }

  await supabase.from('clinical_audit').insert({
    business_id: businessId,
    patient_id: patientId,
    event_type: 'TREATMENT_DELETED',
    description: 'Tratamiento eliminado',
    payload: { treatmentId }
  });

  await Swal.fire({ icon: 'success', title: 'Tratamiento eliminado', timer: 1200, showConfirmButton: false });

  window.location.reload();
});

document.addEventListener('click', async (e) => {
  const btn = e.target.closest('.edit-treatment-btn');
  if (!btn) return;

  if (clinicalEngineState.hasApprovedPlan) {
    Swal.fire('Plan aprobado', 'No se pueden modificar tratamientos', 'info');
    return;
  }

  const treatmentId = btn.dataset.id;

  const { data: treatment } = await supabase
    .from('treatment_plans')
    .select('*')
    .eq('id', treatmentId)
    .single();

  if (!treatment) return;

  const { value: formValues } = await Swal.fire({
    title: '‚úèÔ∏è Editar Tratamiento',
    html: `
      <div class="grid gap-3 text-left">
        <div>
          <label class="text-xs font-bold text-gray-500">Diente</label>
          <input id="edit-tooth" value="${treatment.tooth_number}" class="swal2-input m-0 w-full">
        </div>
        <div>
          <label class="text-xs font-bold text-gray-500">Diagn√≥stico</label>
          <input id="edit-diagnosis" value="${treatment.diagnosis}" class="swal2-input m-0 w-full">
        </div>
        <div>
          <label class="text-xs font-bold text-gray-500">Tratamiento</label>
          <input id="edit-type" value="${treatment.treatment_type}" class="swal2-input m-0 w-full">
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="text-xs font-bold text-gray-500">Prioridad</label>
            <select id="edit-priority" class="swal2-input m-0 w-full">
              <option ${treatment.priority === 'normal' ? 'selected' : ''}>normal</option>
              <option ${treatment.priority === 'urgent' ? 'selected' : ''}>urgent</option>
              <option ${treatment.priority === 'cosmetic' ? 'selected' : ''}>cosmetic</option>
            </select>
          </div>
          <div>
            <label class="text-xs font-bold text-gray-500">Costo</label>
            <input id="edit-cost" type="number" value="${treatment.estimated_cost}" class="swal2-input m-0 w-full">
          </div>
        </div>
      </div>
    `,
    showCancelButton: true,
    confirmButtonText: 'Guardar cambios',
    confirmButtonColor: 'rgb(var(--color-brand))'
  });

  if (!formValues) return;

  const { error } = await supabase
    .from('treatment_plans')
    .update({
      tooth_number: document.getElementById('edit-tooth').value,
      diagnosis: document.getElementById('edit-diagnosis').value,
      treatment_type: document.getElementById('edit-type').value,
      priority: document.getElementById('edit-priority').value,
      estimated_cost: parseFloat(document.getElementById('edit-cost').value) || 0
    })
    .eq('id', treatmentId);

  if (error) {
    Swal.fire('Error', error.message, 'error');
    return;
  }

  await supabase.from('clinical_audit').insert({
    business_id: businessId,
    patient_id: patientId,
    event_type: 'TREATMENT_EDITED',
    description: 'Tratamiento editado',
    payload: { treatmentId }
  });

  await Swal.fire({ icon: 'success', title: 'Tratamiento actualizado', timer: 1200, showConfirmButton: false });
  window.location.reload();
});

// ‚ö° HANDLER: EJECUTAR TRATAMIENTO (Evoluci√≥n + Actualizaci√≥n Visual)
document.addEventListener('click', async (e) => {
    const btn = e.target.closest('.execute-treatment-btn');
    if (!btn) return;

    const { id, tooth, treatment } = btn.dataset;

    // 1. Preparamos lista de doctores para el select
    let dentistOptions = '';
    dentists.forEach(d => dentistOptions += `<option value="${d.id}">${d.name}</option>`);

    const { value: formValues } = await Swal.fire({
        title: '‚ö° Finalizar Procedimiento',
        html: `
            <div class="text-left space-y-3">
                <div class="bg-gray-50 p-2 rounded border border-gray-200 text-sm">
                    ü¶∑ Diente <b>${tooth}</b>: ${treatment}
                </div>

                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase">Profesional que realiz√≥ *</label>
                    <select id="evo-dentist" class="swal2-input m-0 w-full text-sm">
                        ${dentistOptions}
                    </select>
                </div>

                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase">Nota de Evoluci√≥n *</label>
                    <textarea id="evo-note" class="swal2-textarea m-0 w-full h-24 text-sm" 
                    placeholder="Ej: Se realiza procedimiento sin complicaciones. Anestesia..."></textarea>
                </div>

                <div class="flex items-center gap-2 mt-2">
                    <input type="checkbox" id="auto-update-map" checked class="w-4 h-4 text-brand-600 rounded">
                    <label for="auto-update-map" class="text-sm text-gray-700 font-medium">
                        Actualizar mapa dental (Caries ‚ûù Resina)
                    </label>
                </div>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'Guardar y Completar',
        confirmButtonColor: 'rgb(var(--color-brand))',
        preConfirm: () => {
            const note = document.getElementById('evo-note').value;
            const dentist = document.getElementById('evo-dentist').value;
            const autoUpdate = (document.getElementById('auto-update-map') as HTMLInputElement).checked;
            
            if (!note || !dentist) {
                Swal.showValidationMessage('Todos los campos son obligatorios');
                return false;
            }
            return { note, dentist, autoUpdate };
        }
    });

    if (formValues) {
        Swal.fire({ title: 'Procesando...', didOpen: () => Swal.showLoading() });

        try {
            // A. MARCAR PLAN COMO COMPLETADO
            const { error: planError } = await supabase.from('treatment_plans')
                .update({ 
                    status: 'completed', 
                    completed_at: new Date().toISOString() 
                })
                .eq('id', id);
            
            if (planError) throw planError;

            // B. CREAR NOTA DE EVOLUCI√ìN
            const { error: noteError } = await supabase.from('clinical_records').insert({
                business_id: businessId,
                patient_id: patientId,
                dentist_id: formValues.dentist, // El doctor seleccionado
                record_type: 'Evoluci√≥n',
                description: `REALIZADO (Diente ${tooth}): ${treatment}.\n\nüìù NOTA CL√çNICA:\n${formValues.note}`
            });

            if (noteError) throw noteError;

            // C. üî• ACTUALIZAR ODONTOGRAMA "VIVO" (L√≥gica Smart Mejorada)
            if (formValues.autoUpdate) {
                let hasChanges = false;
                const treatLower = treatment.toLowerCase();

                // 1. Caso IMPLANTE (Corrige la "X" de Ausente)
                if (treatLower.includes('implante')) {
                    // Si estaba marcado como ausente, lo quitamos
                    if (mouthState[`${tooth}_center`] === 'ausente') {
                        delete mouthState[`${tooth}_center`]; 
                    }
                    // Y aplicamos el estado de implante (Tornillo visual)
                    mouthState[`${tooth}_center`] = 'implante';
                    hasChanges = true;
                }
                // 2. Caso EXTRACCI√ìN (Poner Ausente)
                else if (treatLower.includes('extracc') || treatLower.includes('exodoncia')) {
                    ['top','bottom','left','right','center'].forEach(p => delete mouthState[`${tooth}_${p}`]);
                    mouthState[`${tooth}_center`] = 'ausente';
                    hasChanges = true;
                }
                // 3. Caso CORONA
                else if (treatLower.includes('corona')) {
                    mouthState[`${tooth}_center`] = 'corona';
                    hasChanges = true;
                }
                // 4. Caso ENDODONCIA
                else if (treatLower.includes('endodoncia') || treatLower.includes('conducto')) {
                    mouthState[`${tooth}_center`] = 'endodoncia';
                    hasChanges = true;
                }
                // 5. Caso RESINA / OBTURACI√ìN
                else if (treatLower.includes('resina') || treatLower.includes('calza') || treatLower.includes('obturaci')) {
                    ['top','bottom','left','right','center'].forEach(part => {
                        const key = `${tooth}_${part}`;
                        if (mouthState[key] === 'caries') {
                            mouthState[key] = 'resina';
                            hasChanges = true;
                        }
                    });
                    // Fallback si no hab√≠a caries marcada
                    if (!hasChanges) {
                        mouthState[`${tooth}_center`] = 'resina';
                        hasChanges = true;
                    }
                }

                // Guardar Snapshot si hubo cambios visuales
                if (hasChanges) {
                    await supabase.from('clinical_records').insert({
                        business_id: businessId,
                        patient_id: patientId,
                        dentist_id: formValues.dentist,
                        record_type: 'odontogram',
                        description: `Actualizaci√≥n visual autom√°tica (${treatment})`,
                        data: mouthState
                    });
                }
            }
            await Swal.fire('√âxito', 'Tratamiento completado y registrado', 'success');
            window.location.reload();

        } catch (error: any) {
            console.error(error);
            Swal.fire('Error', error.message || 'No se pudo guardar', 'error');
        }
    }
});



 // üéØ CREAR TRATAMIENTO MANUAL (Para procedimientos visuales y NO visuales)
document.getElementById('create-treatment-plan-btn')?.addEventListener('click', async () => {

    if (clinicalEngineState.hasApprovedPlan) {
        Swal.fire('Plan aprobado', 'No se pueden agregar tratamientos a un plan cerrado.', 'info');
        return;
    }

    let dentistOptions = '<option value="">Sin asignar</option>';
    dentists.forEach(d => dentistOptions += `<option value="${d.id}">${d.name}</option>`);
    
    let serviceOptions = '<option value="">-- Ninguno / General --</option>';
    services.forEach(s => serviceOptions += `<option value="${s.id}" data-price="${s.price}">${s.name} - ${formatCOP(s.price)}</option>`);

    const { value: formValues } = await Swal.fire({
        title: 'üìã Agregar Procedimiento Manual',
        html: `
            <div class="grid gap-3 text-left">
                <div class="bg-blue-50 p-2 rounded text-xs text-blue-700 mb-2">
                    üí° √ösalo para limpiezas, radiograf√≠as, ortodoncia o hallazgos espec√≠ficos.
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs font-bold text-gray-500">Diente (Opcional)</label>
                        <input id="treat-tooth" type="number" placeholder="Ej: 18" class="swal2-input m-0 w-full">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500">Servicio</label>
                        <select id="treat-service" class="swal2-input m-0 w-full text-sm">${serviceOptions}</select>
                    </div>
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500">Tratamiento / Descripci√≥n *</label>
                    <input id="treat-type" placeholder="Ej: Profilaxis General" class="swal2-input m-0 w-full">
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500">Diagn√≥stico</label>
                    <input id="treat-diagnosis" placeholder="Ej: Placa bacteriana" class="swal2-input m-0 w-full">
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs font-bold text-gray-500">Prioridad</label>
                        <select id="treat-priority" class="swal2-input m-0 w-full">
                            <option value="normal">üü° Normal</option>
                            <option value="urgent">üî¥ Urgente</option>
                            <option value="cosmetic">üü£ Est√©tico</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500">Costo</label>
                        <input id="treat-cost" type="number" placeholder="0" class="swal2-input m-0 w-full">
                    </div>
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500">Dentista</label>
                    <select id="treat-dentist" class="swal2-input m-0 w-full">${dentistOptions}</select>
                </div>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'Agregar al Plan',
        confirmButtonColor: 'rgb(var(--color-brand))',
        didOpen: () => {
            const serviceSelect = document.getElementById('treat-service') as HTMLSelectElement;
            const costInput = document.getElementById('treat-cost') as HTMLInputElement;
            const typeInput = document.getElementById('treat-type') as HTMLInputElement;
            
            // Auto-llenar datos al elegir servicio
            serviceSelect?.addEventListener('change', () => {
                const selectedOption = serviceSelect.options[serviceSelect.selectedIndex];
                const price = selectedOption.getAttribute('data-price');
                const text = selectedOption.text.split(' - ')[0]; // Nombre sin precio
                
                if (price) costInput.value = price;
                if (serviceSelect.value) typeInput.value = text;
            });
        },
        preConfirm: () => {
            const treatmentType = (document.getElementById('treat-type') as HTMLInputElement).value;
            const cost = (document.getElementById('treat-cost') as HTMLInputElement).value;
            
            if (!treatmentType || !cost) {
                Swal.showValidationMessage('El tratamiento y el costo son obligatorios');
                return false;
            }
            
            return {
                tooth_number: (document.getElementById('treat-tooth') as HTMLInputElement).value || null, // Puede ser null
                diagnosis: (document.getElementById('treat-diagnosis') as HTMLInputElement).value,
                treatment_type: treatmentType,
                priority: (document.getElementById('treat-priority') as HTMLSelectElement).value,
                estimated_cost: parseFloat(cost) || 0,
                dentist_id: (document.getElementById('treat-dentist') as HTMLSelectElement).value || null,
                service_id: (document.getElementById('treat-service') as HTMLSelectElement).value || null
            };
        }
    });

    if (formValues) {
        Swal.fire({ title: 'Guardando...', didOpen: () => Swal.showLoading(), showConfirmButton: false });
        
        try {
            // 1. Guardar Tratamiento (Usamos 'draft' para que se sume al plan actual)
            const { error: planError } = await supabase.from('treatment_plans').insert({
                patient_id: patientId,
                business_id: businessId,
                ...formValues,
                status: 'draft' // <--- CLAVE: Se une al borrador existente
            });

            if (planError) throw planError;

            // 2. üî• INTENTO DE SINCRONIZACI√ìN VISUAL (Si aplica)
            // Si el usuario puso un diente y el texto coincide con algo visual, lo pintamos.
            if (formValues.tooth_number) {
                let visualChanged = false;
                const tooth = formValues.tooth_number;
                const typeLower = formValues.treatment_type.toLowerCase();

                // L√≥gica simple de mapeo manual -> visual
                if (typeLower.includes('ausente') || typeLower.includes('extrac')) {
                    mouthState[`${tooth}_center`] = 'ausente';
                    visualChanged = true;
                } else if (typeLower.includes('corona')) {
                    mouthState[`${tooth}_center`] = 'corona';
                    visualChanged = true;
                } else if (typeLower.includes('endodoncia')) {
                    mouthState[`${tooth}_center`] = 'endodoncia';
                    visualChanged = true;
                } else if (typeLower.includes('implante')) {
                    if (mouthState[`${tooth}_center`] === 'ausente') delete mouthState[`${tooth}_center`];
                    mouthState[`${tooth}_center`] = 'implante';
                    visualChanged = true;
                }

                // Si hubo cambio visual, guardamos el snapshot
                if (visualChanged) {
                    await supabase.from('clinical_records').insert({
                        business_id: businessId,
                        patient_id: patientId,
                        record_type: 'odontogram',
                        description: 'Actualizaci√≥n por ingreso manual',
                        data: mouthState, 
                        dentist_id: formValues.dentist_id
                    });
                }
            }

            await Swal.fire({ icon: 'success', title: 'Agregado al Plan', timer: 1500, showConfirmButton: false });
            window.location.reload(); // Recarga para recalcular totales y mostrar en la lista

        } catch (e: any) {
            console.error(e);
            Swal.fire('Error', e.message, 'error');
        }
    }
});

  // Guardar Odontograma
  // Guardar Odontograma (Snapshot Mejorado)
  document.getElementById('save-odontogram-btn')?.addEventListener('click', async () => {
    // üî• MEJORA : Evitar guardar vac√≠o
      if (Object.keys(mouthState).length === 0) {
          Swal.fire('Nada para guardar', 'El odontograma est√° vac√≠o, marca alg√∫n diente primero.', 'info');
          return;
      }
      let dentistOptions = '';
      dentists.forEach((d: any) => dentistOptions += `<option value="${d.id}">${d.name}</option>`);
      
      const { value: formValues } = await Swal.fire({
          title: 'üíæ Guardar Estado Odontograma',
          html: `
            <div class="flex flex-col gap-3 text-left">
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase">Profesional *</label>
                    <select id="save-doc" class="swal2-input m-0 w-full text-sm">
                        <option value="">Selecciona...</option>
                        ${dentistOptions}
                    </select>
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase">Nota / Observaci√≥n</label>
                    <textarea id="save-note" class="swal2-textarea m-0 w-full h-24 text-sm" placeholder="Ej: Se actualiza estado tras procedimiento..."></textarea>
                </div>
            </div>
          `,
          showCancelButton: true,
          confirmButtonText: 'Guardar',
          confirmButtonColor: 'rgb(var(--color-brand))',
          preConfirm: () => {
              const doc = (document.getElementById('save-doc') ).value;
              const note = (document.getElementById('save-note') as HTMLTextAreaElement).value;
              if (!doc) Swal.showValidationMessage('Debes seleccionar un profesional');
              return { doctorId: doc, note: note || 'Actualizaci√≥n de Odontograma' };
          }
      });

      if (formValues) {
          Swal.fire({ title: 'Guardando...', didOpen: () => Swal.showLoading() });
          
          const { error } = await supabase.from('clinical_records').insert({
              business_id: businessId,
              patient_id: patientId,
              record_type: 'odontogram',
              description: formValues.note, // üî• Usamos la nota personalizada
              data: mouthState,
              dentist_id: formValues.doctorId
          });

          if (error) Swal.fire('Error', error.message, 'error');
          else { 
              await Swal.fire({ icon: 'success', title: 'Guardado', timer: 1000, showConfirmButton: false }); 
              window.location.reload(); 
          }
      }
  });

  document.getElementById('view-legal-versions-btn')?.addEventListener('click', async () => {

  Swal.fire({ title: 'Cargando versiones legales...', didOpen: () => Swal.showLoading() });

  const { data: versions, error } = await supabase
    .from('odontogram_versions')
    .select('*, dentists(name)')
    .eq('patient_id', patientId)
    .order('created_at', { ascending: false });

  if (error || !versions?.length) {
    Swal.fire('Sin versiones', 'No existen versiones congeladas.', 'info');
    return;
  }

  const options: any = {};
  versions.forEach((v, i) => {
    const date = new Date(v.created_at).toLocaleString('es-CO');
    options[i] = `üìÖ ${date} ‚Äî ${v.dentists?.name || 'Sistema'} ‚Äî ${v.version_type}`;
  });

  const { value: index } = await Swal.fire({
    title: 'üß¨ Versiones del Plan',
    input: 'select',
    inputOptions: options,
    inputPlaceholder: 'Selecciona una versi√≥n',
    showCancelButton: true,
    confirmButtonText: 'Ver'
  });

  if (index !== undefined) {
    const selected = versions[index];

    // üîß ADAPTADOR: convertir snapshot ‚Üí formato esperado por el visor
    const adapted = {
      ...selected,
      data: selected.snapshot
    };

    window.viewOdontogramSnapshot(
      encodeURIComponent(JSON.stringify(adapted))
    );
  }
});


  // Ver Snapshot (Ver el gr√°fico del pasado)
  // Helper para generar SVG est√°tico
  // Helper para generar SVG est√°tico (Snapshot Hist√≥rico)
  const getStaticSvg = (state) => {
      // Usamos un ancho fijo grande para el snapshot para asegurar calidad
      let svg = '<svg width="950" height="350" viewBox="0 0 950 350" style="pointer-events: none; background: #f8fafc;">';
      
      const SPACING = 55; const GAP_MIDDLE = 40; const ROW_HEIGHT = 160;

      // Funci√≥n interna para renderizar un diente est√°tico con su estado
      const renderStaticTooth = (num, x, y) => {
          // Determinar clases o estilos seg√∫n el estado guardado
          let polyClass = 'fill:white; stroke:#94a3b8; stroke-width:1;'; // Base
          let layers = ''; // Capas adicionales (Corona, Ausente, etc.)

          // Verificar estados globales (capas)
          const centerState = state[`${num}_center`]; 
          if(centerState === 'ausente') layers += `<g fill="#1f2937" opacity="0.8"><polygon points="${TOOTH_GEO.absent1}"/><polygon points="${TOOTH_GEO.absent2}"/></g>`;
          if(centerState === 'corona') layers += `<circle cx="30" cy="30" r="18" fill="none" stroke="#eab308" stroke-width="3"/>`;
          if(centerState === 'endodoncia') layers += `<circle cx="30" cy="30" r="10" fill="none" stroke="#a855f7" stroke-width="3"/>`;
          if(centerState === 'implante') layers += `<polygon points="${TOOTH_GEO.implant}" fill="none" stroke="#475569" stroke-width="2"/>`;

          // Funci√≥n para color de cara espec√≠fica
          const getFaceColor = (part) => {
              const s = state[`${num}_${part}`];
              if(s === 'caries') return '#ef4444';
              if(s === 'resina') return '#3b82f6';
              if(s === 'sellante') return '#22c55e';
              return 'white';
          };

          return `
            <g transform="translate(${x}, ${y})">
                <text x="30" y="-8" style="font-size:12px; font-weight:800; fill:#64748b; text-anchor:middle;">${num}</text>
                <polygon points="${TOOTH_GEO.top}" fill="${getFaceColor('top')}" stroke="#94a3b8" stroke-width="1"></polygon>
                <polygon points="${TOOTH_GEO.bottom}" fill="${getFaceColor('bottom')}" stroke="#94a3b8" stroke-width="1"></polygon>
                <polygon points="${TOOTH_GEO.left}" fill="${getFaceColor('left')}" stroke="#94a3b8" stroke-width="1"></polygon>
                <polygon points="${TOOTH_GEO.right}" fill="${getFaceColor('right')}" stroke="#94a3b8" stroke-width="1"></polygon>
                <polygon points="${TOOTH_GEO.center}" fill="${getFaceColor('center')}" stroke="#94a3b8" stroke-width="1"></polygon>
                ${layers}
            </g>`;
      };

      // Dibujar los mismos cuadrantes
      [18,17,16,15,14,13,12,11].forEach((t, i) => { svg += renderStaticTooth(t, i * SPACING + 10, 40); });
      [21,22,23,24,25,26,27,28].forEach((t, i) => { svg += renderStaticTooth(t, (i * SPACING) + (8 * SPACING) + GAP_MIDDLE, 40); });
      [48,47,46,45,44,43,42,41].forEach((t, i) => { svg += renderStaticTooth(t, i * SPACING + 10, ROW_HEIGHT + 40); });
      [31,32,33,34,35,36,37,38].forEach((t, i) => { svg += renderStaticTooth(t, (i * SPACING) + (8 * SPACING) + GAP_MIDDLE, ROW_HEIGHT + 40); });

      svg += '</svg>';
      return svg;
  };

  // Funci√≥n global para ser llamada desde el timeline
  (window as any).viewOdontogramSnapshot = (recordJson: string) => {
      const record = JSON.parse(decodeURIComponent(recordJson));
      Swal.fire({
          title: `Odontograma del ${new Date(record.created_at).toLocaleDateString()}`,
          html: `<p class="text-sm text-gray-500 mb-4">Dr. ${record.dentists?.name || "Sin asignar"}</p><div class="overflow-x-auto bg-gray-50 p-4 rounded-xl border border-gray-200">${getStaticSvg(record.data || {})}</div>`,
          width: '800px', showConfirmButton: true, confirmButtonText: 'Cerrar', confirmButtonColor: '#334155'
      });
  };


  // ==========================================
  // 4. TIMELINE Y FILTROS (RESTAURADO)
  // ==========================================
  const timelineContainer = document.getElementById('timeline-container');
  const searchNotes = document.getElementById('search-notes') as HTMLInputElement;
  const filterType = document.getElementById('filter-type') ;
  const doctorFilterElement = document.getElementById('filter-doctor') ;
  const tlPagination = document.getElementById('timeline-pagination');
  
  let tlCurrentPage = 1;
  const tlItemsPerPage = 5;
  let filteredRecords = [...records];

  function renderTimeline() {
      if(!timelineContainer) return;
      timelineContainer.innerHTML = '';

      if (filteredRecords.length === 0) {
          timelineContainer.innerHTML = `<div class="text-center py-10 bg-gray-50 rounded-xl border-dashed border-2 border-gray-200"><p class="text-gray-400">No se encontraron notas.</p></div>`;
          if (tlPagination) tlPagination.style.display = 'none';
          return;
      }

      const start = (tlCurrentPage - 1) * tlItemsPerPage;
      const end = start + tlItemsPerPage;
      const pageSlice = filteredRecords.slice(start, end);

      pageSlice.forEach((r: any) => {
          // Detectar si es Odontograma para mostrar bot√≥n especial
          let extraContent = '';
          let iconType = `<span class="inline-block px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wide bg-blue-50 text-blue-700 border border-blue-100 mb-1">${r.record_type}</span>`;
          let borderColor = 'bg-brand-500';

          if (r.record_type === 'odontogram') {
              iconType = `<span class="inline-block px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wide bg-teal-50 text-teal-700 border border-teal-100 mb-1">ü¶∑ Odontograma</span>`;
              borderColor = 'bg-teal-500';
              // Usamos onclick inline con encodeURIComponent para pasar el objeto complejo
              const rString = encodeURIComponent(JSON.stringify(r));
              extraContent = `<div class="mt-3 pt-3 border-t border-gray-100"><button onclick="window.viewOdontogramSnapshot('${rString}')" class="flex items-center gap-2 text-xs font-bold text-teal-600 hover:text-teal-800 bg-teal-50 hover:bg-teal-100 px-3 py-2 rounded-lg transition-colors"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>Ver Mapa Dental</button></div>`;
          }

          const div = document.createElement('div');
          div.className = 'relative group pb-8 pl-6 border-l-2 border-gray-100 last:border-0';
          div.innerHTML = `
            <div class="absolute -left-[5px] top-0 w-2.5 h-2.5 rounded-full ${borderColor} shadow-sm"></div>
            
            <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-100 relative group/card hover:shadow-md transition-shadow">
                
                <!-- Encabezado de la Tarjeta -->
                <div class="flex justify-between items-start mb-2 pr-12"> <!-- pr-12 deja espacio para los botones absolutos -->
                    <div>
                        ${iconType}
                        <h4 class="font-bold text-gray-900 text-sm mt-1">Dr. ${r.dentists?.name || 'Cl√≠nica'}</h4>
                    </div>
                    <span class="text-xs text-gray-400 font-mono whitespace-nowrap">
                        ${new Date(r.created_at).toLocaleDateString('es-CO', {day: 'numeric', month: 'short', year: 'numeric'})}
                    </span>
                </div>

                <!-- Contenido -->
                <div class="text-gray-600 text-sm leading-relaxed whitespace-pre-wrap note-content">${r.description}</div>
                ${extraContent}

                <!-- BOTONES FLOTANTES (SOLUCI√ìN UX: Absolute + Opacity) -->
                <div class="absolute top-2 right-2 flex gap-1 bg-white/90 backdrop-blur-sm p-1 rounded-lg border border-gray-100 shadow-sm transition-opacity opacity-0 group-hover/card:opacity-100">
                    <button class="text-gray-400 hover:text-blue-600 p-1.5 rounded-md hover:bg-blue-50 transition-colors edit-record-btn" title="Editar Texto">
                        <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
                    </button>
                    <button class="text-gray-400 hover:text-red-600 p-1.5 rounded-md hover:bg-red-50 transition-colors delete-record-btn" title="Eliminar Registro">
                        <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                    </button>
                </div>

            </div>
          `;
          
          // Listeners
          div.querySelector('.edit-record-btn')?.addEventListener('click', () => editRecord(r));
          div.querySelector('.delete-record-btn')?.addEventListener('click', () => deleteRecord(r.id));
          
          timelineContainer.appendChild(div);
      });

      if (tlPagination) {
          tlPagination.style.display = filteredRecords.length > tlItemsPerPage ? 'flex' : 'none';
          document.getElementById('timeline-info')!.textContent = `Mostrando ${start+1}-${Math.min(end, filteredRecords.length)} de ${filteredRecords.length}`;
          (document.getElementById('tl-prev') as HTMLButtonElement).disabled = tlCurrentPage === 1;
          (document.getElementById('tl-next') as HTMLButtonElement).disabled = end >= filteredRecords.length;
      }
  }

  function applyFilters() {
      const q = searchNotes.value.toLowerCase();
      const type = filterType.value;
      const doc = doctorFilterElement ? doctorFilterElement.value : 'all';
      
      filteredRecords = records.filter((r: any) => {
          const matchText = r.description.toLowerCase().includes(q) || r.record_type.toLowerCase().includes(q);
          const matchType = type === 'all' || r.record_type === type;
          const matchDoc = doc === 'all' || (r.dentists?.name === doc);
          return matchText && matchType && matchDoc;
      });
      tlCurrentPage = 1;
      renderTimeline();
  }

  searchNotes?.addEventListener('keyup', applyFilters);
  filterType?.addEventListener('change', applyFilters);
  doctorFilterElement?.addEventListener('change', applyFilters);
  
  document.getElementById('tl-prev')?.addEventListener('click', () => { if(tlCurrentPage > 1) { tlCurrentPage--; renderTimeline(); }});
  document.getElementById('tl-next')?.addEventListener('click', () => { if((tlCurrentPage * tlItemsPerPage) < filteredRecords.length) { tlCurrentPage++; renderTimeline(); }});
  
// ==========================================
// 6. VER HISTORIAL DE SNAPSHOTS
// ==========================================
document.getElementById('view-history-btn')?.addEventListener('click', async () => {
    const odontogramRecords = records.filter((r) => r.record_type === 'odontogram');
    
    if (odontogramRecords.length === 0) {
        Swal.fire('Sin Historial', 'No hay snapshots guardados a√∫n.', 'info');
        return;
    }

    // Crear HTML con la lista de snapshots
    const options = {};
    odontogramRecords.forEach((r, index) => {
        const date = new Date(r.created_at).toLocaleDateString('es-CO', { 
            day: 'numeric', month: 'short', year: 'numeric' 
        });
        options[index] = `üìÖ ${date} - Dr. ${r.dentists?.name || 'Sin asignar'}`;
    });

    const { value: selectedIndex } = await Swal.fire({
        title: 'üìú Historial de Odontogramas',
        input: 'select',
        inputOptions: options,
        inputPlaceholder: 'Selecciona una fecha',
        showCancelButton: true,
        confirmButtonText: 'Ver',
        confirmButtonColor: 'rgb(var(--color-brand))'
    });

    if (selectedIndex !== undefined) {
        const selected = odontogramRecords[selectedIndex];
        window.viewOdontogramSnapshot(
        encodeURIComponent(JSON.stringify(selected))
        );
    }
});

  // üéØ ACCIONES DE TRATAMIENTOS (Delegaci√≥n de eventos)
// üéØ ACCIONES DE TRATAMIENTOS (Delegaci√≥n de eventos UNIFICADA)
  document.addEventListener('click', async (e) => {
      const target = e.target as HTMLElement;
      
      // 1. Bot√≥n AGENDAR (üî• CORREGIDO: Abre el modal pre-llenado)
      const scheduleBtn = target.closest('.schedule-treatment-btn') as HTMLElement;
      if (scheduleBtn) {
          const serviceId = scheduleBtn.dataset.serviceId;
          const dentistId = scheduleBtn.dataset.dentistId;
          // Llamamos a la nueva funci√≥n de agendar pasando los datos
          openBookingModal(serviceId, dentistId);
          return;
      }
      
      // 2. Bot√≥n ELIMINAR
      const deleteBtn = target.closest('.delete-treatment-btn') as HTMLElement;
      if (deleteBtn) {
          const treatmentId = deleteBtn.dataset.id;
          const result = await Swal.fire({
              title: '¬øEliminar tratamiento?',
              text: 'Esta acci√≥n no se puede deshacer',
              icon: 'warning',
              showCancelButton: true,
              confirmButtonColor: '#d33',
              confirmButtonText: 'S√≠, eliminar'
          });
          
          if (result.isConfirmed) {
              Swal.fire({ title: 'Eliminando...', didOpen: () => Swal.showLoading(), showConfirmButton: false });
              const { error } = await supabase.from('treatment_plans').delete().eq('id', treatmentId);
              
              if (error) {
                  Swal.fire('Error', error.message, 'error');
              } else {
                  await Swal.fire({ icon: 'success', title: 'Eliminado', timer: 1000, showConfirmButton: false });
                  window.location.reload();
              }
          }
          return;
      }
      
      // 3. Bot√≥n INICIAR
      const startBtn = target.closest('.start-treatment-btn') as HTMLElement;
      if (startBtn) {
          const treatmentId = startBtn.dataset.id;
          const { error } = await supabase.from('treatment_plans').update({ status: 'in_progress', progress: 50 }).eq('id', treatmentId);
          if (!error) window.location.reload();
          return;
      }
      
      // 4. Bot√≥n COMPLETAR
      const completeBtn = target.closest('.complete-treatment-btn') as HTMLElement;
      if (completeBtn) {
          const treatmentId = completeBtn.dataset.id;
          const { error } = await supabase.from('treatment_plans').update({ 
              status: 'completed', 
              progress: 100, 
              completed_at: new Date().toISOString() 
          }).eq('id', treatmentId);
          if (!error) window.location.reload();
          return;
      }
  });


  // ==========================================
  // 5. GESTI√ìN DE CITAS (CRUD COMPLETO)
  // ==========================================
  
  // Borrar Cita
  document.querySelectorAll('.delete-appt-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
          const id = (btn as HTMLElement).dataset.id;
          const result = await Swal.fire({ title: '¬øEliminar Cita?', text: "Esta acci√≥n no se puede deshacer.", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'S√≠, eliminar' });
          if(result.isConfirmed) {
              Swal.fire({ title: 'Eliminando...', didOpen: () => Swal.showLoading() });
              const { error } = await supabase.from('appointments').delete().eq('id', id);
              if (error) Swal.fire('Error', error.message, 'error');
              else { await Swal.fire({ icon: 'success', title: 'Cita eliminada', timer: 1000, showConfirmButton: false }); window.location.reload(); }
          }
      });
  });

  // Editar Cita
  document.querySelectorAll('.edit-appt-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
          const ds = (btn as HTMLElement).dataset;
          const { value: formValues } = await Swal.fire({
              title: 'Reprogramar Cita',
              html: `<div class="flex flex-col gap-4 text-left"><div><label class="block text-sm">Nueva Fecha</label><input id="swal-date" type="date" class="w-full px-3 py-2 border rounded" value="${ds.date}"></div><div><label class="block text-sm">Nueva Hora</label><input id="swal-time" type="time" class="w-full px-3 py-2 border rounded" value="${ds.time}"></div></div>`,
              showCancelButton: true, confirmButtonText: 'Guardar', preConfirm: () => [(document.getElementById('swal-date') as HTMLInputElement).value, (document.getElementById('swal-time') as HTMLInputElement).value]
          });
          if (formValues) {
              Swal.fire({ title: 'Actualizando...', didOpen: () => Swal.showLoading() });
              const { error } = await supabase.from("appointments").update({ appointment_date: formValues[0], appointment_time: formValues[1] }).eq("id", ds.id);
              if (error) Swal.fire('Error', error.message, 'error');
              else { await Swal.fire({ icon: 'success', title: 'Actualizado', timer: 1000, showConfirmButton: false }); window.location.reload(); }
          }
      });
  });

  // Quick Book (Agendar desde Ficha)
  // FUNCI√ìN UNIFICADA DE AGENDAMIENTO
  async function openBookingModal(preServiceId = '', preDentistId = '') {
      // Generar opciones marcando como selected si coinciden
      let serviceOpts = '<option value="">Selecciona...</option>';
      services.forEach((s: any) => {
          const selected = s.id === preServiceId ? 'selected' : '';
          serviceOpts += `<option value="${s.id}" ${selected}>${s.name}</option>`;
      });
      
      let dentistOpts = '<option value="">Cualquiera</option>';
      dentists.forEach((d: any) => {
          const selected = d.id === preDentistId ? 'selected' : '';
          dentistOpts += `<option value="${d.id}" ${selected}>${d.name}</option>`;
      });

      const { value: f } = await Swal.fire({
          title: `Agendar Cita`,
          html: `
            <div class="flex flex-col gap-3 text-left">
                <label class="text-xs font-bold text-gray-500 uppercase">Servicio</label>
                <select id="s" class="swal2-input m-0 w-full text-sm">${serviceOpts}</select>
                
                <div class="grid grid-cols-2 gap-2">
                    <div><label class="text-xs font-bold text-gray-500 uppercase">Fecha</label><input id="d" type="date" class="swal2-input m-0 w-full text-sm"></div>
                    <div><label class="text-xs font-bold text-gray-500 uppercase">Hora</label><input id="t" type="time" class="swal2-input m-0 w-full text-sm"></div>
                </div>
                
                <label class="text-xs font-bold text-gray-500 uppercase">Doctor</label>
                <select id="doc" class="swal2-input m-0 w-full text-sm">${dentistOpts}</select>
            </div>`,
          showCancelButton: true,
          confirmButtonText: 'Agendar',
          confirmButtonColor: 'rgb(var(--color-brand))',
          preConfirm: () => ({ 
              service_id: (document.getElementById('s') ).value, 
              appointment_date: (document.getElementById('d') as HTMLInputElement).value, 
              appointment_time: (document.getElementById('t') as HTMLInputElement).value, 
              dentist_id: (document.getElementById('doc') ).value 
          })
      });

      if (f) {
          if(!f.service_id || !f.appointment_date || !f.appointment_time) return Swal.fire('Faltan datos', '', 'warning');
          
          Swal.fire({ title: 'Agendando...', didOpen: () => Swal.showLoading() });
          
          const serviceName = services.find((s:any) => s.id === f.service_id)?.name || "Servicio";
          const dentistName = dentists.find((d:any) => d.id === f.dentist_id)?.name || "Asignado";

          try {
              await fetch("/api/appointments/create", { 
                  method: "POST", 
                  headers: { "Content-Type": "application/json" }, 
                  body: JSON.stringify({ 
                      ...f, 
                      ...branding, 
                      business_id: businessId, 
                      customer_name: patientInfo.name, 
                      customer_email: patientInfo.email, 
                      customer_phone: patientInfo.phone, 
                      patient_doc: patientInfo.doc, 
                      status: 'confirmed',
                      service_name: serviceName, // Para el email
                      dentist_name: dentistName  // Para el email
                  }) 
              });
              await Swal.fire({ icon: 'success', title: 'Cita Agendada', timer: 1500, showConfirmButton: false });
              window.location.reload();
          } catch (e: any) {
              Swal.fire('Error', e.message, 'error');
          }
      }
  }

  // ==========================================
  // 6. FUNCIONES CRUD NOTAS (CREAR / EDITAR / BORRAR)
  // ==========================================
  
  // Agregar Nota (Avanzada con Tipo y Doctor)
  document.getElementById('add-evolution-btn')?.addEventListener('click', async () => {
    let dentistOptions = '<option value="">-- Seleccionar --</option>';
    dentists.forEach((d: any) => dentistOptions += `<option value="${d.id}">${d.name}</option>`);

    const { value: formValues } = await Swal.fire({
        title: 'Nueva Nota Cl√≠nica',
        html: `
            <div class="flex flex-col gap-3 text-left">
                <div><label class="text-xs font-bold text-gray-500 uppercase">Tipo de Registro</label>
                <select id="note-type" class="swal2-input m-0 w-full text-sm"><option value="Evoluci√≥n">Evoluci√≥n</option><option value="Anamnesis">Anamnesis</option><option value="Diagn√≥stico">Diagn√≥stico</option><option value="Procedimiento">Procedimiento</option><option value="Prescripci√≥n">Receta</option></select></div>
                <div><label class="text-xs font-bold text-gray-500 uppercase">Profesional Responsable</label>
                <select id="note-dentist" class="swal2-input m-0 w-full text-sm">${dentistOptions}</select></div>
                <div><label class="text-xs font-bold text-gray-500 uppercase">Detalle de la nota</label>
                <textarea id="note-text" class="swal2-textarea m-0 w-full h-32 text-sm" placeholder="Escribe los detalles..."></textarea></div>
            </div>
        `,
        showCancelButton: true, confirmButtonText: 'Guardar', confirmButtonColor: 'rgb(var(--color-brand))',
        preConfirm: () => ({ type: (document.getElementById('note-type') ).value, dentist: (document.getElementById('note-dentist') ).value, text: (document.getElementById('note-text') as HTMLTextAreaElement).value })
    });

    if (formValues) {
        if(!formValues.dentist || !formValues.text) return Swal.fire('Faltan datos', 'Selecciona doctor y escribe nota', 'warning');
        
        Swal.fire({ title: 'Guardando...', didOpen: () => Swal.showLoading() });
        const { error } = await supabase.from('clinical_records').insert({
            business_id: businessId, patient_id: patientId, dentist_id: formValues.dentist, record_type: formValues.type, description: formValues.text
        });

        if (error) Swal.fire('Error', error.message, 'error');
        else { await Swal.fire({ icon: 'success', title: 'Nota guardada', timer: 1000, showConfirmButton: false }); window.location.reload(); }
    }
  });

  // Funciones Auxiliares para Editar/Borrar
  async function editRecord(r: any) {
      const { value: text } = await Swal.fire({ input: 'textarea', inputValue: r.description, inputLabel: 'Editar Nota', showCancelButton: true, confirmButtonText: 'Actualizar', confirmButtonColor: 'rgb(var(--color-brand))', customClass: { input: 'h-32 text-sm' } });
      if (text) {
        Swal.fire({ title: 'Actualizando...', didOpen: () => Swal.showLoading() });
        const { error } = await supabase.from('clinical_records').update({ description: text }).eq('id', r.id);
        if (error) Swal.fire('Error', error.message, 'error'); else { window.location.reload(); }
      }
  }

  async function deleteRecord(id: string) {
      const result = await Swal.fire({ title: '¬øBorrar nota?', text: "No se puede deshacer.", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33' });
      if(result.isConfirmed) {
         Swal.fire({ title: 'Borrando...', didOpen: () => Swal.showLoading() });
         const { error } = await supabase.from('clinical_records').delete().eq('id', id);
         if (error) Swal.fire('Error', error.message, 'error'); else { window.location.reload(); }
      }
  }

  // ==========================================
  // STORAGE & MISC
  // ==========================================
  const fileInput = document.getElementById('file-upload') as HTMLInputElement;
  const uploadBtn = document.getElementById('upload-btn');
  uploadBtn?.addEventListener('click', () => fileInput.click());
  fileInput?.addEventListener('change', async (e: any) => {
      const file = e.target.files[0];
      if (!file) return;
      if (file.size > 5 * 1024 * 1024) return Swal.fire('Archivo muy grande', 'M√°ximo 5MB', 'warning');
      Swal.fire({ title: 'Subiendo...', didOpen: () => Swal.showLoading() });
      const filePath = `${businessId}/${patientId}/${Date.now()}.${file.name.split('.').pop()}`;
      const { error: uploadError } = await supabase.storage.from('clinical-files').upload(filePath, file);
      if (uploadError) return Swal.fire('Error al subir', uploadError.message, 'error');
      const { error: dbError } = await supabase.from('patient_attachments').insert({ business_id: businessId, patient_id: patientId, file_name: file.name, file_url: filePath, file_type: file.type });
      if (dbError) Swal.fire('Error al guardar', dbError.message, 'error'); else window.location.reload();
  });

  document.querySelectorAll('.file-card').forEach(card => {
      card.addEventListener('click', async (e) => {
          if ((e.target as HTMLElement).closest('.delete-file-btn')) return;
          const path = (card as HTMLElement).dataset.path;
          if (!path) return;
          const { data, error } = await supabase.storage.from('clinical-files').createSignedUrl(path, 60);
          if (error) Swal.fire('Error', 'No se pudo abrir', 'error'); else window.open(data.signedUrl, '_blank');
      });
  });

  document.querySelectorAll('.delete-file-btn').forEach(btn => {
      btn.addEventListener('click', async (e) => {
          e.stopPropagation();
          const id = (btn as HTMLElement).dataset.id;
          const path = (btn as HTMLElement).dataset.path;
          const result = await Swal.fire({ title: '¬øBorrar?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Borrar' });
          if (!result.isConfirmed) return;
          if (path) await supabase.storage.from('clinical-files').remove([path]);
          const { error } = await supabase.from('patient_attachments').delete().eq('id', id);
          if (error) Swal.fire('Error', error.message, 'error'); else window.location.reload();
      });
  });

  // Exportar Excel
  document.getElementById('export-history-btn')?.addEventListener('click', () => {
      let csv = "Fecha;Tipo;Doctor;Nota\n";
      records.forEach((r: any) => {
          const clean = (str: any) => (str || "").toString().replace(/"/g, '""').replace(/;/g, ',');
          csv += `${new Date(r.created_at).toLocaleDateString()};${clean(r.record_type)};${clean(r.dentists?.name)};"${clean(r.description)}"\n`;
      });
      const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });
      const url = window.URL.createObjectURL(blob); const a = document.createElement("a"); a.href = url; a.download = `historia_${patientId}.csv`; a.click();
  });

  // Editar Paciente
  const editPBtn = document.getElementById('edit-patient-btn');
  editPBtn?.addEventListener('click', async () => {
    const ds = (editPBtn as HTMLElement).dataset;
    const { value: formValues } = await Swal.fire({ title: 'Editar Informaci√≥n', html: `<div class="grid grid-cols-1 gap-3 text-left"><div><label class="text-xs font-bold text-gray-500">Nombre</label><input id="edit-name" class="swal2-input m-0 w-full" value="${ds.fullName || ''}"></div><div class="grid grid-cols-2 gap-3"><div><label class="text-xs font-bold text-gray-500">Doc</label><input id="edit-doc" class="swal2-input m-0 w-full" value="${ds.doc || ''}"></div><div><label class="text-xs font-bold text-gray-500">Nacimiento</label><input id="edit-birth" type="date" class="swal2-input m-0 w-full" value="${ds.birth || ''}"></div></div><div class="grid grid-cols-2 gap-3"><div><label class="text-xs font-bold text-gray-500">Tel√©fono</label><input id="edit-phone" class="swal2-input m-0 w-full" value="${ds.phone || ''}"></div><div><label class="text-xs font-bold text-gray-500">G√©nero</label><select id="edit-gender" class="swal2-input m-0 w-full"><option value="masculino" ${ds.gender === 'masculino'?'selected':''}>Masculino</option><option value="femenino" ${ds.gender === 'femenino'?'selected':''}>Femenino</option><option value="otro" ${ds.gender === 'otro'?'selected':''}>Otro</option></select></div></div><div><label class="text-xs font-bold text-gray-500">Email</label><input id="edit-email" class="swal2-input m-0 w-full" value="${ds.email || ''}"></div><div><label class="text-xs font-bold text-gray-500">Direcci√≥n</label><input id="edit-address" class="swal2-input m-0 w-full" value="${ds.address || ''}"></div><div><label class="text-xs font-bold text-red-500">Alergias</label><input id="edit-allergies" class="swal2-input m-0 w-full border-red-200" value="${ds.allergies || ''}"></div></div>`, showCancelButton: true, confirmButtonText: 'Guardar', confirmButtonColor: 'rgb(var(--color-brand))', preConfirm: () => ({ full_name: (document.getElementById('edit-name') as HTMLInputElement).value, document_id: (document.getElementById('edit-doc') as HTMLInputElement).value, birth_date: (document.getElementById('edit-birth') as HTMLInputElement).value || null, phone: (document.getElementById('edit-phone') as HTMLInputElement).value, gender: (document.getElementById('edit-gender') ).value, email: (document.getElementById('edit-email') as HTMLInputElement).value, address: (document.getElementById('edit-address') as HTMLInputElement).value, allergies: (document.getElementById('edit-allergies') as HTMLInputElement).value }) });
    if (formValues) { const { error } = await supabase.from('patients').update(formValues).eq('id', patientId); if (error) Swal.fire('Error', error.message, 'error'); else window.location.reload(); }
  });

  // Eliminar Paciente
  document.getElementById('delete-patient-btn')?.addEventListener('click', async () => {
      const result = await Swal.fire({ title: '‚ö†Ô∏è ¬øELIMINAR?', text: "Se borrar√° todo el historial.", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'S√≠, borrar' });
      if (result.isConfirmed) { const { error } = await supabase.from('patients').delete().eq('id', patientId); if (error) Swal.fire('Error', error.message, 'error'); else window.location.href = '/admin/pacientes'; }
  });

  
// üß¨ FUNCI√ìN DE SEGURIDAD: RESTAURAR DESDE BD (Cliente)
async function loadLastOdontogram() {
  if (!patientId) return;

  // Consultamos el √∫ltimo registro tipo 'odontogram'
  const { data, error } = await supabase
    .from('clinical_records')
    .select('data')
    .eq('patient_id', patientId)
    .eq('record_type', 'odontogram')
    .order('created_at', { ascending: false })
    .limit(1)
    .maybeSingle(); // Usamos maybeSingle para que no de error si es el primer paciente sin historia

  // Si encontramos datos, sobreescribimos el estado inicial
  if (!error && data?.data) {
    console.log("üîÑ Odontograma sincronizado desde historial reciente");
    mouthState = data.data; // Actualizamos la variable global
    
    // Forzamos el repintado
    updateVisuals();
    detectProblems();
  }
}


// ==========================================
// üöÄ BOOTSTRAPPER / CICLO DE VIDA CENTRAL
// ==========================================
// ==========================================
// üöÄ BOOTSTRAPPER / CICLO DE VIDA CENTRAL
// ==========================================
async function mountApplication() { // <--- Ahora es ASYNC
    // 1. Inicializar odontograma (Dibuja la estructura blanca vac√≠a)
    initOdontogram();

    // 2. üî• RECUPERACI√ìN DE ESTADO: 
    // Esperamos a consultar la BD para tener la "verdad" m√°s reciente
    await loadLastOdontogram(); 

    // üî• MEJORA B: Bloqueo visual global si hay plan aprobado
    if (clinicalEngineState.hasApprovedPlan) {
        document.body.classList.add('plan-locked');
    }

    // 3. Aplicar estado visual final (Pinta colores y capas)
    requestAnimationFrame(() => {
        updateVisuals(); 
        detectProblems(); // Calcula presupuesto
    });

    // 4. Renderizar resto de la UI
    renderTimeline();
    
    // Opcional: Si quieres que arranque siempre en el tab de historial o odontograma
    // switchTab('tab-odontogram'); 
    // üî• CORRECCI√ìN: Recuperar la √∫ltima pesta√±a visitada o usar default
    const lastTab = localStorage.getItem('activeTab') || 'tab-history';
    switchTab(lastTab);
}

// Esperar DOM listo
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', mountApplication);
} else {
    mountApplication();
}



</script>

<style>
  /* ==========================================
     ODONTOGRAMA PREMIUM STYLES
     ========================================== */
  
  #odontogram-canvas {
    overflow-x: auto;
    overflow-y: hidden;
    padding: 20px 10px;
    background-color: #f8fafc;
    border-radius: 12px;
    border: 1px solid #e2e8f0;
    scrollbar-width: thin;
    scrollbar-color: #cbd5e1 #f1f5f9;
  }
#odontogram-canvas {
  overflow-x: auto;
  overflow-y: hidden;
  padding: 20px;
  background-color: #f8fafc;
  border-radius: 12px;
  border: 1px solid #e2e8f0;
}

/* üî• CLAVE UX */
.odontogram-inner {
  display: flex;
  justify-content: center; /* Centra visualmente */
  min-width: fit-content;
}

/* SVG nunca se estira */
.odontogram-inner svg {
  flex-shrink: 0;
}

  
  
  #odontogram-canvas::-webkit-scrollbar { height: 8px; }
  #odontogram-canvas::-webkit-scrollbar-track { background: #f1f5f9; }
  #odontogram-canvas::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
  

  /* Grupo Diente */
  .tooth-group { cursor: pointer; transition: transform 0.1s; }
  .tooth-group:active { transform: scale(0.95); }
  
  .tooth-label { 
    font-size: 12px; 
    font-weight: 800; 
    fill: #64748b; 
    text-anchor: middle; 
    pointer-events: none; 
    user-select: none;
  }

  /* Superficies (El Diente Base) */
  .tooth-surface {
    fill: #ffffff; /* Blanco base */
    stroke: #94a3b8;
    stroke-width: 1px;
    transition: all 0.2s ease;
  }
  .tooth-surface:hover { fill: #e2e8f0; stroke: #64748b; }

  /* Estados de Color (Superficies) */
  .state-caries { fill: #ef4444 !important; stroke: #b91c1c !important; }
  .state-resina { fill: #3b82f6 !important; stroke: #1d4ed8 !important; }
  .state-sellante { fill: #22c55e !important; stroke: #15803d !important; }
  
  /* Capas / Overlays (Estructurales) */
  .layer-corona {
    transition: opacity 0.3s;
    /* Colores definidos inline en el JS para asegurar visibilidad */
  }
  
  .layer-endo {
    transition: opacity 0.3s;
  }

  .layer-ausente {
    transition: opacity 0.3s;
  }
  /* Cuando est√° ausente, el diente de fondo se aten√∫a */
  .has-ausente .tooth-surface { opacity: 0.1; } 

  .layer-implante {
    transition: opacity 0.3s;
  }

  /* Utilidades */
  .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
  @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
  .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
  .swal-opt:hover { background-color: #f3f4f6; }

  /* Bloqueo visual cuando el plan est√° aprobado */
body.plan-locked .tooth-group {
    cursor: not-allowed !important;
    opacity: 0.8;
}
body.plan-locked #save-odontogram-btn {
    display: none; /* Ocultar bot√≥n guardar si est√° bloqueado */
}
</style>