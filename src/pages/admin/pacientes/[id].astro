---
import AdminLayout from "../../../layouts/AdminLayout.astro";
import { supabase } from "../../../lib/supabase";

const { id } = Astro.params;

// 1. AUTH
const accessToken = Astro.cookies.get("sb-access-token")?.value;
const refreshToken = Astro.cookies.get("sb-refresh-token")?.value;

if (accessToken && refreshToken) {
  await supabase.auth.setSession({ access_token: accessToken, refresh_token: refreshToken });
} else {
  return Astro.redirect("/admin/login");
}

if (!id) return Astro.redirect("/admin/pacientes");

// 2. DATOS
const { data: patient, error: patientError } = await supabase.from("patients").select("*").eq("id", id).single();
if (patientError || !patient) return Astro.redirect("/404");

const { data: records } = await supabase.from("clinical_records").select(`*, dentists (name)`).eq("patient_id", id).order("created_at", { ascending: false });
const { data: appointments } = await supabase.from("appointments").select(`*, services (name), dentists (name)`).eq("patient_id", id).order("appointment_date", { ascending: false });
const { data: attachments } = await supabase.from("patient_attachments").select("*").eq("patient_id", id).order("created_at", { ascending: false });

const { data: servicesList } = await supabase.from("services").select("id, name").eq("business_id", patient.business_id).eq("is_active", true).order("name");
const { data: dentistsList } = await supabase.from("dentists").select("id, name").eq("business_id", patient.business_id).eq("is_active", true).order("name");
const { data: businessData } = await supabase
  .from("businesses")
  .select("name, primary_color, logo_url, address")
  .eq("id", patient.business_id)
  .single();

// Helpers
const getInitials = (name: string) => name ? name.split(" ").map((n) => n[0]).join("").substring(0, 2).toUpperCase() : "??";
const calculateAge = (birthDateString: string) => {
  if (!birthDateString) return null;
  const today = new Date();
  const birthDate = new Date(birthDateString);
  let age = today.getFullYear() - birthDate.getFullYear();
  const m = today.getMonth() - birthDate.getMonth();
  if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) age--;
  return age;
};
const age = calculateAge(patient.birth_date);
---

<AdminLayout title={`Historia Cl铆nica - ${patient.full_name}`}>
  
  <div class="max-w-7xl mx-auto pb-20">
    
    <!-- HEADER -->
    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 mb-6 flex flex-col md:flex-row items-start md:items-center justify-between gap-6 relative overflow-hidden">
        <div class="absolute top-0 right-0 w-32 h-32 bg-brand-50 rounded-bl-full -mr-10 -mt-10 opacity-50 pointer-events-none"></div>
        <div class="flex items-center gap-5 z-10">
            <div class="w-20 h-20 rounded-2xl bg-gradient-to-br from-brand-500 to-brand-700 text-white flex items-center justify-center text-2xl font-bold shadow-lg shadow-brand-200">{getInitials(patient.full_name)}</div>
            <div>
                <div class="flex items-center gap-2 mb-1">
                    <h1 class="text-2xl font-bold text-gray-900">{patient.full_name}</h1>
                    <span class="bg-gray-100 text-gray-600 text-xs px-2 py-0.5 rounded-full font-mono border border-gray-200">ID: {patient.document_id || 'N/A'}</span>
                </div>
                <div class="flex flex-wrap gap-4 text-sm text-gray-500">
                    <span class="flex items-center gap-1"><svg class="w-4 h-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>{age !== null ? `${age} a帽os` : 'Edad desconocida'}</span>
                    <span class="flex items-center gap-1"><svg class="w-4 h-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" /></svg>{patient.phone || 'Sin tel茅fono'}</span>
                </div>
                <!-- ALERGIAS -->
                {patient.allergies && (
                    <div class="mt-2 inline-flex items-center gap-1 px-2 py-1 bg-red-50 text-red-700 text-xs font-bold rounded border border-red-100 animate-pulse">
                        <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
                        ALERGIAS: {patient.allergies}
                    </div>
                )}
            </div>
        </div>
        <div class="flex flex-wrap gap-3 z-10 w-full md:w-auto">
             <a href={`https://wa.me/57${patient.phone?.replace(/\D/g, '')}`} target="_blank" class="flex-1 md:flex-none justify-center px-4 py-2 bg-green-50 text-green-700 border border-green-200 rounded-xl font-bold text-sm hover:bg-green-100 transition-colors flex items-center gap-2">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg> WhatsApp
             </a>
             <button id="edit-patient-btn" class="flex-1 md:flex-none px-4 py-2 border border-gray-200 text-gray-600 rounded-xl font-bold text-sm hover:bg-gray-50 transition-colors"
                data-full-name={patient.full_name} data-doc={patient.document_id} data-phone={patient.phone} data-email={patient.email} data-address={patient.address} data-birth={patient.birth_date} data-gender={patient.gender} data-allergies={patient.allergies || ''}>
                Editar Datos
             </button>
        </div>
    </div>

    <!-- GRID -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <!-- SIDEBAR -->
        <div class="space-y-6">
            <!-- Tabs -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-2">
                <nav class="flex lg:flex-col gap-1 overflow-x-auto whitespace-nowrap pb-2 lg:pb-0 scrollbar-hide">
                    <button class="tab-btn active flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-bold text-gray-600 hover:bg-gray-50 transition-all text-left w-full min-w-[150px] lg:min-w-0" data-target="tab-history">
                        <div class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center shrink-0"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg></div> Historia Cl铆nica
                    </button>
                    <button class="tab-btn flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-bold text-gray-600 hover:bg-gray-50 transition-all text-left w-full min-w-[150px] lg:min-w-0" data-target="tab-info">
                        <div class="w-8 h-8 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center shrink-0"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg></div> Informaci贸n
                    </button>
                    <button class="tab-btn flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-bold text-gray-600 hover:bg-gray-50 transition-all text-left w-full min-w-[150px] lg:min-w-0" data-target="tab-files">
                        <div class="w-8 h-8 rounded-full bg-orange-100 text-orange-600 flex items-center justify-center shrink-0"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" /></svg></div> Archivos
                    </button>
                </nav>
            </div>
            
            <!-- CITAS (Con Edici贸n y Borrado) -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
                <h3 class="text-sm font-bold text-gray-900 uppercase tracking-wider mb-4 border-b border-gray-100 pb-2">Pr贸ximas Citas</h3>
                <div class="space-y-3">
                    {appointments && appointments.filter(a => new Date(a.appointment_date) >= new Date()).length > 0 ? (
                        appointments.filter(a => new Date(a.appointment_date) >= new Date()).slice(0, 3).map(a => (
                            <div class="flex items-start gap-3 p-3 bg-gray-50 rounded-lg border border-gray-100 relative group">
                                <div class="bg-white border border-gray-200 rounded px-2 py-1 text-center min-w-[50px]">
                                    <span class="block text-xs font-bold text-gray-500 uppercase">
                                        {new Date(a.appointment_date + 'T00:00:00').toLocaleDateString('es-CO', {month: 'short'})}
                                    </span>
                                    <span class="block text-lg font-bold text-gray-900 leading-none">
                                        {new Date(a.appointment_date + 'T00:00:00').getDate()}
                                    </span>
                                </div>
                                <div>
                                    <p class="text-sm font-bold text-gray-900">{a.services?.name}</p>
                                    <p class="text-xs text-gray-500"> {a.appointment_time.slice(0,5)} - Dr. {a.dentists?.name?.split(' ')[0]}</p>
                                </div>
                                <!--  ACCIONES FLOTANTES (Solo hover) -->
                                <div class="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity bg-white/90 rounded-md shadow-sm p-0.5">
                                    <button class="text-blue-500 hover:bg-blue-50 p-1 rounded edit-appt-btn" 
                                        data-id={a.id} data-date={a.appointment_date} data-time={a.appointment_time} title="Editar">
                                        <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                                    </button>
                                    <button class="text-red-500 hover:bg-red-50 p-1 rounded delete-appt-btn" 
                                        data-id={a.id} title="Eliminar">
                                        <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                    </button>
                                </div>
                            </div>
                        ))
                    ) : (
                        <div class="text-center py-4">
                            <p class="text-sm text-gray-400">No hay citas futuras</p>
                            <button id="quick-book-btn" class="text-xs text-brand-600 font-bold hover:underline cursor-pointer">Agendar ahora</button>
                        </div>
                    )}
                </div>
            </div>

            <div class="pt-4"><button id="delete-patient-btn" class="w-full flex items-center justify-center gap-2 p-3 text-red-600 bg-red-50 hover:bg-red-100 border border-red-200 rounded-xl text-sm font-bold transition-colors"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg>Eliminar Paciente</button></div>
        </div>

        <!-- CONTENIDO CENTRAL -->
        <div class="lg:col-span-2">
            
            <div id="tab-history" class="tab-content block space-y-6">
                
                <!-- HEADER FILTROS -->
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 space-y-3">
                    <div class="flex justify-between items-center">
                        <div>
                            <h2 class="font-bold text-gray-800">Evoluciones M茅dicas</h2>
                            <button id="export-history-btn" class="text-xs text-brand-600 hover:underline flex items-center gap-1 mt-1">
                                <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg> 
                                Excel
                            </button>
                        </div>
                        <button id="add-evolution-btn" class="bg-brand-600 text-white px-4 py-2 rounded-lg font-bold text-sm shadow-md shadow-brand-200 hover:bg-brand-700 transition-all flex items-center gap-2"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>Agregar Nota</button>
                    </div>
                    
                    <!--  BUSCADOR Y FILTROS -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 pt-2 border-t border-gray-100">
                        <input id="search-notes" type="text" placeholder="Buscar palabras clave..." class="w-full text-xs border-gray-200 rounded-lg bg-gray-50 focus:bg-white focus:ring-brand-500">
                        <select id="filter-type" class="w-full text-xs border-gray-200 rounded-lg bg-gray-50 focus:bg-white focus:ring-brand-500">
                            <option value="all">Todos los Tipos</option>
                            <option value="Evoluci贸n">Evoluci贸n</option>
                            <option value="Anamnesis">Anamnesis</option>
                            <option value="Diagn贸stico">Diagn贸stico</option>
                            <option value="Procedimiento">Procedimiento</option>
                            <option value="Prescripci贸n">Prescripci贸n</option>
                        </select>
                        <select id="filter-doctor" class="w-full text-xs border-gray-200 rounded-lg bg-gray-50 focus:bg-white focus:ring-brand-500">
                            <option value="all">Todos los Doctores</option>
                        </select>
                    </div>
                </div>
                
                <!-- TIMELINE CONTAINER -->
                <div id="timeline-container" class="relative pl-8 border-l-2 border-gray-200 space-y-8 min-h-[200px]"></div>

                <!-- PAGINACIN TIMELINE -->
                <div id="timeline-pagination" class="flex justify-between items-center text-xs text-gray-500 pt-4 border-t border-gray-100 hidden">
                    <span id="timeline-info">Mostrando 0-0 de 0</span>
                    <div class="flex gap-2">
                        <button id="tl-prev" class="px-3 py-1 bg-white border rounded hover:bg-gray-50 disabled:opacity-50">Anterior</button>
                        <button id="tl-next" class="px-3 py-1 bg-white border rounded hover:bg-gray-50 disabled:opacity-50">Siguiente</button>
                    </div>
                </div>

            </div>

            <div id="tab-info" class="tab-content hidden bg-white rounded-xl shadow-sm border border-gray-100 p-8">
                <h3 class="text-lg font-bold text-gray-900 mb-6 border-b pb-2">Ficha del Paciente</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div><label class="block text-xs font-bold text-gray-400 uppercase">Nombre Completo</label><p class="text-gray-900 font-medium">{patient.full_name}</p></div>
                    <div><label class="block text-xs font-bold text-gray-400 uppercase">Documento</label><p class="text-gray-900 font-medium">{patient.document_id || '-'}</p></div>
                    <div><label class="block text-xs font-bold text-gray-400 uppercase">Fecha Nacimiento</label><p class="text-gray-900 font-medium">{patient.birth_date || '-'}</p></div>
                    <div><label class="block text-xs font-bold text-gray-400 uppercase">G茅nero</label><p class="text-gray-900 font-medium capitalize">{patient.gender || '-'}</p></div>
                    <div><label class="block text-xs font-bold text-gray-400 uppercase text-red-500">Alergias</label><p class="text-red-600 font-bold">{patient.allergies || 'Ninguna conocida'}</p></div>
                    <div class="md:col-span-2"><label class="block text-xs font-bold text-gray-400 uppercase">Direcci贸n</label><p class="text-gray-900 font-medium">{patient.address || '-'}</p></div>
                </div>
            </div>

            <div id="tab-files" class="tab-content hidden">
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-8 text-center">
                    <div class="w-16 h-16 bg-gray-50 rounded-full flex items-center justify-center mx-auto mb-4"><svg class="w-8 h-8 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" /></svg></div>
                    <h3 class="font-bold text-gray-900">Archivos y Radiograf铆as</h3>
                    <div class="bg-blue-50 border border-blue-100 rounded-lg p-3 my-4 text-left"><p class="text-xs text-blue-800 font-bold mb-1">癸 Informaci贸n:</p><ul class="text-xs text-blue-600 list-disc list-inside space-y-1"><li>Formatos permitidos: JPG, PNG, PDF.</li><li>Peso m谩ximo: 5MB.</li></ul></div>
                    <button onclick="Swal.fire('Pr贸ximamente', 'M贸dulo de carga en Fase 4', 'info')" class="bg-gray-800 text-white px-5 py-2 rounded-lg font-bold text-sm hover:bg-black transition-colors">Subir Archivo</button>
                </div>
            </div>

        </div>
    </div>
  </div>

  <!-- DATOS JSON -->
  <div 
    id="page-data" 
    data-patient-id={id} 
    data-business-id={patient.business_id}
    data-dentists={JSON.stringify(dentistsList)}
    data-services={JSON.stringify(servicesList)}
    data-records={JSON.stringify(records)}
    data-patient-info={JSON.stringify({name: patient.full_name, doc: patient.document_id, phone: patient.phone, email: patient.email})}
    data-branding={JSON.stringify({
        name: businessData?.name || "Cl铆nica Dental", 
        color: businessData?.primary_color || "#2563EB", 
        logo: businessData?.logo_url || "",
        address: businessData?.address || ""
    })}
  ></div>

</AdminLayout>

<script>
  import Swal from "sweetalert2";
  import { supabase } from "../../../lib/supabase";

  // DATOS GLOBALES
  const pageData = document.getElementById('page-data');
  const patientId = pageData?.dataset.patientId;
  const businessId = pageData?.dataset.businessId;
  const dentists = JSON.parse(pageData?.dataset.dentists || '[]');
  const services = JSON.parse(pageData?.dataset.services || '[]');
  const records = JSON.parse(pageData?.dataset.records || '[]');
  const patientInfo = JSON.parse(pageData?.dataset.patientInfo || '{}');

  // Filtro Doctores
  const doctorFilter = document.getElementById('filter-doctor') as HTMLSelectElement;
  dentists.forEach((d: any) => {
      const opt = document.createElement('option');
      opt.value = d.name; opt.textContent = d.name; doctorFilter.appendChild(opt);
  });

  // ==========================================
  // TIMELINE LOGIC
  // ==========================================
  const timelineContainer = document.getElementById('timeline-container');
  const searchNotes = document.getElementById('search-notes') as HTMLInputElement;
  const filterType = document.getElementById('filter-type') as HTMLSelectElement;
  const tlPagination = document.getElementById('timeline-pagination');
  
  let tlCurrentPage = 1;
  const tlItemsPerPage = 5;
  let filteredRecords = [...records];

  function renderTimeline() {
      if(!timelineContainer) return;
      timelineContainer.innerHTML = '';

      if (filteredRecords.length === 0) {
          timelineContainer.innerHTML = `<div class="text-center py-10 bg-gray-50 rounded-xl border-dashed border-2 border-gray-200"><p class="text-gray-400">No se encontraron notas.</p></div>`;
          if (tlPagination) tlPagination.style.display = 'none';
          return;
      }

      const start = (tlCurrentPage - 1) * tlItemsPerPage;
      const end = start + tlItemsPerPage;
      const pageSlice = filteredRecords.slice(start, end);

      pageSlice.forEach((r: any) => {
          const div = document.createElement('div');
          div.className = 'relative group';
          div.innerHTML = `
            <div class="absolute -left-[39px] top-1 w-5 h-5 rounded-full border-4 border-white bg-brand-500 shadow-sm"></div>
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5 hover:shadow-md transition-shadow relative group/card">
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <span class="inline-block px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wide bg-blue-50 text-blue-700 border border-blue-100 mb-1">${r.record_type}</span>
                        <h4 class="font-bold text-gray-900 text-sm">Atendido por: ${r.dentists?.name || 'Cl铆nica'}</h4>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-xs text-gray-400 font-mono">${new Date(r.created_at).toLocaleDateString('es-CO', {day: 'numeric', month: 'short', year: 'numeric'})}</span>
                        <div class="hidden group-hover/card:flex gap-1 ml-2">
                            <button class="text-gray-400 hover:text-brand-600 p-1 edit-record-btn" data-id="${r.id}" title="Editar"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg></button>
                            <button class="text-gray-400 hover:text-red-600 p-1 delete-record-btn" data-id="${r.id}" title="Borrar"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                        </div>
                    </div>
                </div>
                <div class="text-gray-600 text-sm leading-relaxed whitespace-pre-wrap note-content">${r.description}</div>
            </div>
          `;
          div.querySelector('.edit-record-btn')?.addEventListener('click', () => editRecord(r));
          div.querySelector('.delete-record-btn')?.addEventListener('click', () => deleteRecord(r.id));
          timelineContainer.appendChild(div);
      });

      if (tlPagination) {
          tlPagination.style.display = filteredRecords.length > tlItemsPerPage ? 'flex' : 'none';
          document.getElementById('timeline-info')!.textContent = `Mostrando ${start+1}-${Math.min(end, filteredRecords.length)} de ${filteredRecords.length}`;
          (document.getElementById('tl-prev') as HTMLButtonElement).disabled = tlCurrentPage === 1;
          (document.getElementById('tl-next') as HTMLButtonElement).disabled = end >= filteredRecords.length;
      }
  }

  function applyFilters() {
      const q = searchNotes.value.toLowerCase();
      const type = filterType.value;
      const doc = doctorFilter.value;
      filteredRecords = records.filter((r: any) => {
          return (r.description.toLowerCase().includes(q) || r.record_type.toLowerCase().includes(q)) && (type === 'all' || r.record_type === type) && (doc === 'all' || (r.dentists?.name === doc));
      });
      tlCurrentPage = 1;
      renderTimeline();
  }

  searchNotes?.addEventListener('keyup', applyFilters);
  filterType?.addEventListener('change', applyFilters);
  doctorFilter?.addEventListener('change', applyFilters);
  document.getElementById('tl-prev')?.addEventListener('click', () => { if(tlCurrentPage > 1) { tlCurrentPage--; renderTimeline(); }});
  document.getElementById('tl-next')?.addEventListener('click', () => { if((tlCurrentPage * tlItemsPerPage) < filteredRecords.length) { tlCurrentPage++; renderTimeline(); }});
  renderTimeline();

  // ==========================================
  //  GESTIN DE CITAS (EDITAR / ELIMINAR / CREAR)
  // ==========================================
  
  // 1. ELIMINAR CITA (DELETE)
  document.querySelectorAll('.delete-appt-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
          const id = (btn as HTMLElement).dataset.id;
          const result = await Swal.fire({ title: '驴Eliminar Cita?', text: "Esta acci贸n no se puede deshacer.", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'S铆, eliminar' });
          if(result.isConfirmed) {
              Swal.fire({ title: 'Eliminando...', didOpen: () => Swal.showLoading() });
              const { error } = await supabase.from('appointments').delete().eq('id', id);
              if (error) Swal.fire('Error', error.message, 'error');
              else { await Swal.fire({ icon: 'success', title: 'Cita eliminada', timer: 1000, showConfirmButton: false }); window.location.reload(); }
          }
      });
  });

  // 2. EDITAR CITA (EDIT)
  document.querySelectorAll('.edit-appt-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
          const ds = (btn as HTMLElement).dataset;
          const { value: formValues } = await Swal.fire({
              title: 'Reprogramar Cita',
              html: `<div class="flex flex-col gap-4 text-left"><div><label class="block text-sm">Nueva Fecha</label><input id="swal-date" type="date" class="w-full px-3 py-2 border rounded" value="${ds.date}"></div><div><label class="block text-sm">Nueva Hora</label><input id="swal-time" type="time" class="w-full px-3 py-2 border rounded" value="${ds.time}"></div></div>`,
              showCancelButton: true, confirmButtonText: 'Guardar', preConfirm: () => [(document.getElementById('swal-date') as HTMLInputElement).value, (document.getElementById('swal-time') as HTMLInputElement).value]
          });
          if (formValues) {
              const [newDate, newTime] = formValues;
              if (!newDate || !newTime) return;
              Swal.fire({ title: 'Actualizando...', didOpen: () => Swal.showLoading() });
              const { error } = await supabase.from("appointments").update({ appointment_date: newDate, appointment_time: newTime }).eq("id", ds.id);
              if (error) Swal.fire('Error', error.message, 'error');
              else { await Swal.fire({ icon: 'success', title: 'Actualizado', timer: 1000, showConfirmButton: false }); window.location.reload(); }
          }
      });
  });

  // 3. CREAR CITA (QUICK BOOK)
  document.getElementById('quick-book-btn')?.addEventListener('click', async () => {
      let dentistOptions = '<option value="">Cualquiera</option>';
      dentists.forEach((d: any) => dentistOptions += `<option value="${d.id}">${d.name}</option>`);
      let serviceOptions = '<option value="">Selecciona...</option>';
      services.forEach((s: any) => serviceOptions += `<option value="${s.id}">${s.name}</option>`);

      const { value: formValues } = await Swal.fire({
          title: `Cita para ${patientInfo.name}`,
          html: `<div class="flex flex-col gap-3 text-left"><div><label class="text-xs font-bold text-gray-500 uppercase">Servicio *</label><select id="qb-service" class="swal2-input m-0 w-full text-sm">${serviceOptions}</select></div><div class="grid grid-cols-2 gap-3"><div><label class="text-xs font-bold text-gray-500 uppercase">Fecha *</label><input id="qb-date" type="date" class="swal2-input m-0 w-full text-sm"></div><div><label class="text-xs font-bold text-gray-500 uppercase">Hora *</label><input id="qb-time" type="time" class="swal2-input m-0 w-full text-sm"></div></div><div><label class="text-xs font-bold text-gray-500 uppercase">Doctor</label><select id="qb-dentist" class="swal2-input m-0 w-full text-sm">${dentistOptions}</select></div></div>`,
          showCancelButton: true, confirmButtonText: 'Agendar', confirmButtonColor: 'rgb(var(--color-brand))',
          preConfirm: () => ({ service: (document.getElementById('qb-service') as HTMLSelectElement).value, date: (document.getElementById('qb-date') as HTMLInputElement).value, time: (document.getElementById('qb-time') as HTMLInputElement).value, dentist: (document.getElementById('qb-dentist') as HTMLSelectElement).value })
      });

      if (formValues) {
          Swal.fire({ title: 'Agendando...', didOpen: () => Swal.showLoading() });
          
          try {
              // Buscar nombres para el email
              const serviceName = services.find((s:any) => s.id === formValues.service)?.name || "Servicio";
              const dentistName = dentists.find((d:any) => d.id === formValues.dentist)?.name || "Asignado";
              
              //  LEER DATOS DE MARCA
              const branding = JSON.parse(pageData?.dataset.branding || '{}');

              const response = await fetch("/api/appointments/create", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                      business_id: businessId,
                      service_id: formValues.service,
                      dentist_id: formValues.dentist || null,
                      customer_name: patientInfo.name,
                      customer_email: patientInfo.email,
                      customer_phone: patientInfo.phone,
                      patient_doc: patientInfo.doc,
                      appointment_date: formValues.date,
                      appointment_time: formValues.time,
                      status: "confirmed",
                      is_first_visit: false,
                      marketing_source: "Admin Panel (Ficha)",
                      
                      //  AGREGAMOS LOS DATOS FALTANTES:
                      business_name: branding.name,
                      brand_color: branding.color,
                      logo_url: branding.logo,
                      business_address: branding.address,
                      
                      service_name: serviceName,
                      dentist_name: dentistName
                  })
              });
              
              const result = await response.json();
              if(!response.ok) throw new Error(result.error);

              await Swal.fire({ icon: 'success', title: 'Cita Agendada', timer: 1500, showConfirmButton: false });
              window.location.reload();

          } catch (e: any) {
              Swal.fire('Error', e.message, 'error');
          }
      }
  });

  // ==========================================
  // FUNCIONES CRUD NOTAS
  // ==========================================
  async function editRecord(r: any) {
      const { value: text } = await Swal.fire({ input: 'textarea', inputValue: r.description, inputLabel: 'Editar Nota', showCancelButton: true, confirmButtonText: 'Actualizar', confirmButtonColor: 'rgb(var(--color-brand))', customClass: { input: 'h-32 text-sm' } });
      if (text) {
        Swal.fire({ title: 'Actualizando...', didOpen: () => Swal.showLoading() });
        const { error } = await supabase.from('clinical_records').update({ description: text }).eq('id', r.id);
        if (error) Swal.fire('Error', error.message, 'error');
        else { const idx = records.findIndex((rec:any) => rec.id === r.id); if(idx !== -1) records[idx].description = text; applyFilters(); Swal.close(); }
      }
  }
  async function deleteRecord(id: string) {
      const result = await Swal.fire({ title: '驴Borrar nota?', text: "No se puede deshacer.", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33' });
      if(result.isConfirmed) {
         Swal.fire({ title: 'Borrando...', didOpen: () => Swal.showLoading() });
         const { error } = await supabase.from('clinical_records').delete().eq('id', id);
         if (error) Swal.fire('Error', error.message, 'error');
         else { const idx = records.findIndex((rec:any) => rec.id === id); if(idx !== -1) records.splice(idx, 1); applyFilters(); Swal.close(); }
      }
  }

  // CREAR NOTA
  document.getElementById('add-evolution-btn')?.addEventListener('click', async () => {
    let dentistOptions = '<option value="">-- Seleccionar --</option>';
    dentists.forEach((d: any) => dentistOptions += `<option value="${d.id}">${d.name}</option>`);
    const { value: formValues } = await Swal.fire({ title: 'Nueva Nota', html: `<div class="flex flex-col gap-3 text-left"><div><label class="text-xs font-bold text-gray-500 uppercase">Tipo</label><select id="note-type" class="swal2-input m-0 w-full text-sm"><option value="Evoluci贸n">Evoluci贸n</option><option value="Anamnesis">Anamnesis</option><option value="Diagn贸stico">Diagn贸stico</option><option value="Procedimiento">Procedimiento</option><option value="Prescripci贸n">Receta</option></select></div><div><label class="text-xs font-bold text-gray-500 uppercase">Doctor</label><select id="note-dentist" class="swal2-input m-0 w-full text-sm">${dentistOptions}</select></div><div><label class="text-xs font-bold text-gray-500 uppercase">Detalle</label><textarea id="note-text" class="swal2-textarea m-0 w-full h-32 text-sm" placeholder="Escribe..."></textarea></div></div>`, showCancelButton: true, confirmButtonText: 'Guardar', confirmButtonColor: 'rgb(var(--color-brand))', preConfirm: () => ({ type: (document.getElementById('note-type') as HTMLSelectElement).value, dentist: (document.getElementById('note-dentist') as HTMLSelectElement).value, text: (document.getElementById('note-text') as HTMLTextAreaElement).value }) });
    if (formValues) {
        if(!formValues.dentist || !formValues.text) return Swal.fire('Error', 'Faltan datos', 'warning');
        Swal.fire({ title: 'Guardando...', didOpen: () => Swal.showLoading() });
        const { data, error } = await supabase.from('clinical_records').insert({ business_id: businessId, patient_id: patientId, dentist_id: formValues.dentist, record_type: formValues.type, description: formValues.text }).select(`*, dentists(name)`).single();
        if (error) Swal.fire('Error', error.message, 'error');
        else { records.unshift(data); applyFilters(); Swal.fire({ icon: 'success', title: 'Nota guardada', timer: 1000, showConfirmButton: false }); }
    }
  });

  // TABS
  const tabBtns = document.querySelectorAll('.tab-btn');
  const tabContents = document.querySelectorAll('.tab-content');
  tabBtns.forEach(btn => {
    btn.addEventListener('click', () => {
        tabBtns.forEach(b => { b.classList.remove('bg-brand-50', 'text-brand-700', 'border-l-4', 'border-brand-600'); b.classList.add('text-gray-600'); });
        tabContents.forEach(c => c.classList.add('hidden'));
        const targetId = (btn as HTMLElement).dataset.target;
        document.getElementById(targetId || '')?.classList.remove('hidden');
        btn.classList.remove('text-gray-600');
        btn.classList.add('bg-brand-50', 'text-brand-700', 'border-l-4', 'border-brand-600');
    });
  });
  (tabBtns[0] as HTMLElement).click();

  // EXPORT, EDIT PATIENT, DELETE PATIENT
  document.getElementById('export-history-btn')?.addEventListener('click', () => {
      let csv = "Fecha;Tipo;Doctor;Nota\n";
      records.forEach((r: any) => {
          const clean = (str: any) => (str || "").toString().replace(/"/g, '""').replace(/;/g, ',');
          csv += `${new Date(r.created_at).toLocaleDateString()};${clean(r.record_type)};${clean(r.dentists?.name)};"${clean(r.description)}"\n`;
      });
      const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });
      const url = window.URL.createObjectURL(blob); const a = document.createElement("a"); a.href = url; a.download = `historia_${patientId}.csv`; a.click();
  });

  const editBtn = document.getElementById('edit-patient-btn');
  editBtn?.addEventListener('click', async () => {
    const ds = (editBtn as HTMLElement).dataset;
    const { value: formValues } = await Swal.fire({ title: 'Editar Informaci贸n', html: `<div class="grid grid-cols-1 gap-3 text-left"><div><label class="text-xs font-bold text-gray-500">Nombre</label><input id="edit-name" class="swal2-input m-0 w-full" value="${ds.fullName || ''}"></div><div class="grid grid-cols-2 gap-3"><div><label class="text-xs font-bold text-gray-500">Doc</label><input id="edit-doc" class="swal2-input m-0 w-full" value="${ds.doc || ''}"></div><div><label class="text-xs font-bold text-gray-500">Nacimiento</label><input id="edit-birth" type="date" class="swal2-input m-0 w-full" value="${ds.birth || ''}"></div></div><div class="grid grid-cols-2 gap-3"><div><label class="text-xs font-bold text-gray-500">Tel茅fono</label><input id="edit-phone" class="swal2-input m-0 w-full" value="${ds.phone || ''}"></div><div><label class="text-xs font-bold text-gray-500">G茅nero</label><select id="edit-gender" class="swal2-input m-0 w-full"><option value="masculino" ${ds.gender === 'masculino'?'selected':''}>Masculino</option><option value="femenino" ${ds.gender === 'femenino'?'selected':''}>Femenino</option><option value="otro" ${ds.gender === 'otro'?'selected':''}>Otro</option></select></div></div><div><label class="text-xs font-bold text-gray-500">Email</label><input id="edit-email" class="swal2-input m-0 w-full" value="${ds.email || ''}"></div><div><label class="text-xs font-bold text-gray-500">Direcci贸n</label><input id="edit-address" class="swal2-input m-0 w-full" value="${ds.address || ''}"></div><div><label class="text-xs font-bold text-red-500">Alergias</label><input id="edit-allergies" class="swal2-input m-0 w-full border-red-200" value="${ds.allergies || ''}"></div></div>`, showCancelButton: true, confirmButtonText: 'Guardar', confirmButtonColor: 'rgb(var(--color-brand))', preConfirm: () => ({ full_name: (document.getElementById('edit-name') as HTMLInputElement).value, document_id: (document.getElementById('edit-doc') as HTMLInputElement).value, birth_date: (document.getElementById('edit-birth') as HTMLInputElement).value || null, phone: (document.getElementById('edit-phone') as HTMLInputElement).value, gender: (document.getElementById('edit-gender') as HTMLSelectElement).value, email: (document.getElementById('edit-email') as HTMLInputElement).value, address: (document.getElementById('edit-address') as HTMLInputElement).value, allergies: (document.getElementById('edit-allergies') as HTMLInputElement).value }) });
    if (formValues) { const { error } = await supabase.from('patients').update(formValues).eq('id', patientId); if (error) Swal.fire('Error', error.message, 'error'); else window.location.reload(); }
  });

  document.getElementById('delete-patient-btn')?.addEventListener('click', async () => {
      const result = await Swal.fire({ title: '锔 驴ELIMINAR?', text: "Se borrar谩 todo el historial.", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'S铆, borrar' });
      if (result.isConfirmed) { const { error } = await supabase.from('patients').delete().eq('id', patientId); if (error) Swal.fire('Error', error.message, 'error'); else window.location.href = '/admin/pacientes'; }
  });
</script>

<style>
  .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
  .scrollbar-hide::-webkit-scrollbar { display: none; }
  .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
</style>