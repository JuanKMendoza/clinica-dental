---
// src/components/patient/PaymentsPanel.astro
import { formatCOP } from "../../utils/money";

interface Props {
  patientId: string;
  businessId: string;
  payments: any[];
  treatmentPlans: any[];
  brandColor: string;
  patient: any;
  businessData: any;
}

const { 
  patientId, 
  businessId, 
  payments = [], 
  treatmentPlans = [], 
  brandColor, 
  patient = {},     
  businessData = {} 
} = Astro.props;

// ==========================================
// 1. C√ÅLCULOS FINANCIEROS (SERVER SIDE)
// ==========================================

// Costo Total (Solo lo aprobado/completado cuenta como deuda)
const totalPlanCost = treatmentPlans
  .filter((t: any) => ['approved', 'completed'].includes(t.status))
  .reduce((sum: number, t: any) => sum + Number(t.estimated_cost), 0);

// Total Pagado (Suma algebraica: los pagos suman, los reembolsos restan porque se guardan como negativos)
const totalPaid = payments.reduce((sum: number, p: any) => sum + Number(p.amount), 0);

// üî• CORRECCI√ìN: Definimos balanceDue expl√≠citamente para que el HTML no falle
const balanceDue = totalPlanCost - totalPaid;

// L√≥gica de Visualizaci√≥n (UX Amigable)
const isCredit = balanceDue < 0; // ¬øTiene saldo a favor?
const balanceAbs = Math.abs(balanceDue); // Valor absoluto (sin el menos) para mostrar bonito

// Colores y Textos din√°micos
const balanceColorClass = isCredit ? 'text-blue-600' : (balanceDue > 0 ? 'text-red-600' : 'text-emerald-600');
const balanceLabel = isCredit ? 'Saldo a Favor del Paciente' : (balanceDue > 0 ? 'Pendiente por Pagar' : 'Paz y Salvo');
const balanceBg = isCredit ? 'bg-blue-500' : (balanceDue > 0 ? 'bg-red-500' : 'bg-emerald-500');

// ==========================================
// 2. L√ìGICA DEL "LIBRO MAYOR" (LEDGER)
// ==========================================
const transactions = [
    // A. CARGOS (Tratamientos)
    ...treatmentPlans
        .filter((t: any) => ['approved', 'completed'].includes(t.status))
        .map((t: any) => ({
            date: new Date(t.updated_at || t.created_at),
            type: 'CARGO',
            description: `${t.treatment_type} (Diente ${t.tooth_number || 'General'})`,
            charge: Number(t.estimated_cost),
            payment: 0,
            ref: '-',
            notes: '-' 
        })),
    
    // B. ABONOS (Pagos y Reembolsos)
    ...payments.map((p: any) => ({
        date: new Date(p.created_at),
        type: Number(p.amount) >= 0 ? 'PAGO' : 'REEMBOLSO', // Diferenciar visualmente
        description: Number(p.amount) >= 0 ? `Abono - ${p.payment_method}` : `Devoluci√≥n - ${p.payment_method}`,
        charge: 0,
        // Si es negativo (reembolso), matem√°ticamente resta al total pagado, 
        // pero en el ledger lo mostramos en la columna "Abono" con signo negativo para claridad contable
        payment: Number(p.amount),
        ref: p.reference || '',
        notes: p.notes || '' 
    }))
].sort((a, b) => a.date.getTime() - b.date.getTime());

// Calcular saldo acumulado l√≠nea por l√≠nea
let runningBalance = 0; 
const initialBalance = 0; 
runningBalance = initialBalance;

const ledger = transactions.map(t => {
    // F√≥rmula: Saldo = Saldo Anterior + Cargo - Abono
    runningBalance = runningBalance + t.charge - t.payment;
    return { ...t, balance: runningBalance };
});
---

<div class="space-y-6">
    
    <!-- A. VISTA DE PANTALLA (DASHBOARD FINANCIERO) -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 screen-only">
    
    <!-- Tarjeta 1: Costo Total -->
    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center">
        <p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Valor Tratamiento</p>
        <p id="display-total-cost" class="text-3xl font-extrabold text-gray-900">{formatCOP(totalPlanCost)}</p>
        <p class="text-xs text-gray-400 mt-2">Cargos generados</p>
    </div>

    <!-- Tarjeta 2: Total Pagado -->
    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center">
        <p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Total Abonado</p>
        <p id="display-total-paid" class="text-3xl font-extrabold text-emerald-600">{formatCOP(totalPaid)}</p>
        <p id="display-payments-count" class="text-xs text-gray-400 mt-2">{payments.length} movimientos</p>
    </div>

    <!-- Tarjeta 3: Estado de Cuenta (DIN√ÅMICO) -->
    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center relative overflow-hidden group">
        <div id="balance-bar" class={`absolute top-0 left-0 w-1 h-full ${balanceBg}`}></div>
        
        <p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Estado de Cuenta</p>
        
        <p id="display-balance" class={`text-3xl font-extrabold ${balanceColorClass}`}>
            {formatCOP(balanceAbs)}
        </p>
        
        <p id="balance-label" class="text-xs text-gray-500 mt-2 font-bold uppercase">{balanceLabel}</p>

        {isCredit && (
            <button 
                id="btn-refund" 
                class="mt-3 px-3 py-1.5 bg-blue-50 text-blue-700 text-xs font-bold rounded-lg border border-blue-100 hover:bg-blue-100 transition-colors flex items-center gap-1 cursor-pointer"
                data-amount={balanceAbs}
            >
                <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" /></svg>
                Reembolsar Excedente
            </button>
        )}
    </div>
</div>

    <!-- B. BOTONES DE ACCI√ìN -->
    <div class="flex justify-end gap-3 screen-only">
        <button onclick="window.print()" 
            class="px-4 py-3 bg-white text-gray-700 border border-gray-300 rounded-xl font-bold shadow-sm hover:bg-gray-50 transition-all flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" /></svg>
            Imprimir Estado de Cuenta
        </button>

        <button id="btn-register-payment" 
            class="px-6 py-3 text-white rounded-xl font-bold transition-all flex items-center gap-2 hover:opacity-90 hover:scale-[1.02] shadow-lg"
            style={`background-color: ${brandColor}; box-shadow: 0 10px 15px -3px ${brandColor}40;`} 
            data-patient-id={patientId}
            data-business-id={businessId}
            data-balance={balanceDue} 
        >
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            Registrar Abono
        </button>
    </div>

    <!-- D. BARRA DE FILTROS -->
<div class="bg-gray-50 p-4 rounded-xl border border-gray-200 space-y-3 screen-only">
    <!-- Primera fila -->
    <div class="flex flex-wrap gap-4 items-end">
        <div class="flex-1 min-w-[200px]">
            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Buscar (Descripci√≥n/Notas)</label>
            <input type="text" id="filter-desc" placeholder="Ej: Resina, Abono..." class="w-full text-sm border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
        </div>
        <div class="w-40">
            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Referencia</label>
            <input type="text" id="filter-ref" placeholder="Ej: 1234" class="w-full text-sm border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
        </div>
    </div>
    
    <!-- Segunda fila: Rango de fechas -->
    <div class="flex flex-wrap gap-4 items-end">
        <div class="w-48">
            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Desde</label>
            <input type="date" id="filter-date-from" class="w-full text-sm border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
        </div>
        <div class="w-48">
            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Hasta</label>
            <input type="date" id="filter-date-to" class="w-full text-sm border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
        </div>
        <button id="btn-apply-filters" class="px-4 py-2 bg-emerald-600 text-white rounded-lg text-sm font-bold hover:bg-emerald-700 transition-colors flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" /></svg>
            Aplicar
        </button>
        <button id="btn-clear-filters" class="px-4 py-2 bg-white border border-gray-300 text-gray-600 rounded-lg text-sm font-bold hover:bg-gray-100 transition-colors">
            Limpiar
        </button>
    </div>
    
    <!-- Indicador de filtros activos -->
    <div id="filter-indicator" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-3 flex items-center justify-between">
        <div class="flex items-center gap-2 text-sm text-blue-700">
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            <span id="filter-summary">Filtros activos</span>
        </div>
    </div>
</div>

    <!-- C. TABLA HIST√ìRICA -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden screen-only">
        <div class="overflow-x-auto">
            <table class="w-full text-sm text-left">
                <thead class="text-xs text-gray-500 uppercase bg-gray-50">
                    <tr>
                        <th class="px-6 py-3">Fecha</th>
                        <th class="px-6 py-3 w-1/3">Descripci√≥n</th>
                        <th class="px-6 py-3">Referencia</th>
                        <th class="px-6 py-3">Notas</th>
                        <th class="px-6 py-3 text-right text-red-600">Cargo</th>
                        <th class="px-6 py-3 text-right text-emerald-600">Abono</th>
                        <th class="px-6 py-3 text-right">Saldo</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    {ledger.length > 0 ? (
                        ledger.map((t) => (
                            <tr class="hover:bg-gray-50 transition-colors transaction-row" 
                                data-desc={(t.description + ' ' + t.notes).toLowerCase()} 
                                data-ref={String(t.ref).toLowerCase()}
                                data-date={t.date.toISOString().split('T')[0]}
                                data-charge={t.charge}
                                data-payment={t.payment}
                                data-balance={t.balance}
                            >
                                <td class="px-6 py-4 font-mono text-gray-600 text-xs whitespace-nowrap">
                                    {t.date.toLocaleDateString('es-CO')}
                                </td>
                                <td class="px-6 py-4 font-medium text-gray-800">
                                    {t.description}
                                </td>
                                <td class="px-6 py-4 text-gray-500 font-mono text-xs">
                                    {t.ref !== '-' ? t.ref : ''}
                                </td>
                                <td class="px-6 py-4 text-gray-500 italic text-xs max-w-[150px] truncate" title={t.notes}>
                                    {t.notes}
                                </td>
                                <td class="px-6 py-4 text-right text-red-600 font-medium whitespace-nowrap">
                                    {t.charge > 0 ? formatCOP(t.charge) : '-'}
                                </td>
                                <td class="px-6 py-4 text-right text-emerald-600 font-bold whitespace-nowrap">
                                    {/* Muestra valor absoluto para no confundir con signos negativos en la tabla */}
                                    {Math.abs(t.payment) > 0 ? formatCOP(Math.abs(t.payment)) : '-'}
                                </td>
                                <td class="px-6 py-4 text-right font-bold text-gray-700 bg-gray-50/50 whitespace-nowrap">
                                    {formatCOP(t.balance)}
                                </td>
                            </tr>
                        ))
                    ) : (
                        <tr><td colspan="7" class="px-6 py-10 text-center text-gray-400 italic">Sin movimientos registrados.</td></tr>
                    )}
                </tbody>
            </table>
        </div>
    </div>


    <!-- ================================================================= -->
    <!-- üñ®Ô∏è DISE√ëO DE IMPRESI√ìN (ESTADO DE CUENTA PROFESIONAL) -->
    <!-- ================================================================= -->
    <div id="print-statement" class="hidden">
        
        <!-- HEADER -->
        <div class="flex justify-between items-start mb-8 border-b-2 border-brand-800 pb-6">
            <div>
                <h1 class="text-3xl font-bold text-brand-900 uppercase tracking-tight">CUENTA DE COBRO</h1>
                <p class="text-sm text-gray-500 mt-1 uppercase font-bold tracking-widest">{businessData?.name || 'Cl√≠nica Dental'}</p>
            </div>
            <div class="text-right">
                <p class="text-sm text-gray-400 uppercase">Fecha de Emisi√≥n</p>
                <p class="text-lg font-bold">{new Date().toLocaleDateString('es-CO')}</p>
            </div>
        </div>

        <!-- INFO -->
        <div class="grid grid-cols-2 gap-12 mb-10">
            <div>
                <!--<p class="text-xs font-bold text-gray-400 uppercase mb-2">De:</p>-->
                <p class="font-bold text-lg">{businessData?.name || 'Cl√≠nica'}</p>
                <p class="text-sm text-gray-600">{businessData?.address || 'Direcci√≥n no registrada'}</p>
            </div>
            <div>
                <p class="text-xs font-bold text-gray-400 uppercase mb-2">Cliente:</p>
                <p class="font-bold text-lg">{patient?.full_name || 'Paciente'}</p>
                <p class="text-sm text-gray-600">ID: {patient?.document_id || 'N/A'}</p>
            </div>
        </div>

        <!-- RESUMEN EJECUTIVO -->
        <div class="flex justify-end mb-8">
            <table class="w-1/2 border-collapse">
                <tr class="bg-brand-900 text-white">
                    <td class="p-3 text-sm font-bold uppercase">Saldo Adeudado</td>
                    <td class="p-3 text-right font-bold text-lg">{formatCOP(balanceDue)}</td>
                </tr>
                <tr class="bg-gray-100">
                    <td class="p-3 text-xs font-bold text-gray-500 uppercase">Monto total plan</td>
                    <td class="p-3 text-right font-medium">{formatCOP(totalPlanCost)}</td>
                </tr>
            </table>
        </div>

        <!-- TABLA DE ACTIVIDAD -->
        <div class="mb-10">
            <h3 class="bg-brand-900 text-white px-4 py-2 text-sm font-bold uppercase tracking-wider mb-0">Actividad de la Cuenta</h3>
            <table class="w-full text-sm border border-gray-300">
                <thead>
                    <tr class="bg-gray-100 text-gray-600">
                        <th class="p-3 text-left border-r border-gray-300">Fecha</th>
                        <th class="p-3 text-left border-r border-gray-300 w-1/2">Descripci√≥n</th>
                        <th class="p-3 text-right border-r border-gray-300">Cargo</th>
                        <th class="p-3 text-right border-r border-gray-300">Abono</th>
                        <th class="p-3 text-right">Balance</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    {ledger.map(t => (
                        <tr class="even:bg-gray-50 print-row" 
                                data-date={t.date.toISOString().split('T')[0]}
                                data-charge={t.charge}
                                data-payment={t.payment}
                                data-balance={t.balance}
                            >
                            <td class="p-3 border-r border-gray-200 font-mono text-xs">{t.date.toLocaleDateString('es-CO')}</td>
                            <td class="p-3 border-r border-gray-200">{t.description}</td>
                            <td class="p-3 border-r border-gray-200 text-right">{t.charge > 0 ? formatCOP(t.charge) : '-'}</td>
                            <td class="p-3 border-r border-gray-200 text-right">{Math.abs(t.payment) > 0 ? formatCOP(Math.abs(t.payment)) : '-'}</td>
                            <td class="p-3 text-right font-bold bg-gray-50/30">{formatCOP(t.balance)}</td>
                        </tr>
                    ))}
                    
                    <tr class="bg-brand-900 text-white font-bold">
                        <td colspan="4" class="p-3 text-right uppercase text-xs">Saldo Total a Pagar</td>
                        <td class="p-3 text-right">{formatCOP(balanceDue)}</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    import Swal from "sweetalert2";
    import { supabase } from "../../lib/supabase";

    // ==========================================
    // HELPERS
    // ==========================================
    const formatCOP = (num: number) => `$${Number(num).toLocaleString('es-CO', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;

    // ==========================================
    // 1. REGISTRO DE PAGO
    // ==========================================
    const btn = document.getElementById('btn-register-payment');
    btn?.addEventListener('click', async () => {
        const { patientId, businessId, balance } = btn.dataset;

        const { value: formValues } = await Swal.fire({
            title: 'üíµ Registrar Ingreso',
            html: `
                <div class="text-left space-y-3">
                    <div class="bg-gray-100 p-2 rounded text-center text-sm mb-4">
                        Saldo Pendiente: <span class="font-bold text-red-600">${formatCOP(Number(balance))}</span>
                    </div>
                    <div><label class="text-xs font-bold text-gray-500 uppercase">Monto *</label><input id="pay-amount" type="number" class="swal2-input m-0 w-full" placeholder="Ej: 50000"></div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="text-xs font-bold text-gray-500 uppercase">M√©todo *</label><select id="pay-method" class="swal2-input m-0 w-full text-sm"><option value="Efectivo">Efectivo</option><option value="Transferencia">Transferencia</option><option value="Tarjeta">Tarjeta</option><option value="Qr">QR / Nequi</option></select></div>
                        <div><label class="text-xs font-bold text-gray-500 uppercase">Ref</label><input id="pay-ref" type="text" class="swal2-input m-0 w-full text-sm" placeholder="#123"></div>
                    </div>
                    <div><label class="text-xs font-bold text-gray-500 uppercase">Notas</label><textarea id="pay-note" class="swal2-textarea m-0 w-full h-20 text-sm" placeholder="Opcional..."></textarea></div>
                </div>
            `,
            showCancelButton: true, confirmButtonText: 'Registrar', confirmButtonColor: '#059669',
            preConfirm: () => {
                const amount = (document.getElementById('pay-amount') as HTMLInputElement).value;
                if (!amount || Number(amount) <= 0) return Swal.showValidationMessage('Monto inv√°lido');
                return {
                    amount,
                    method: (document.getElementById('pay-method') as HTMLSelectElement).value,
                    ref: (document.getElementById('pay-ref') as HTMLInputElement).value,
                    notes: (document.getElementById('pay-note') as HTMLTextAreaElement).value
                };
            }
        });

        if (formValues) {
            Swal.fire({ title: 'Guardando...', didOpen: () => Swal.showLoading() });
            const { error } = await supabase.from('payments').insert({
                business_id: businessId, patient_id: patientId, amount: formValues.amount,
                payment_method: formValues.method, reference: formValues.ref, notes: formValues.notes,
                registered_by: (await supabase.auth.getUser()).data.user?.id
            });
            if (!error) { 
                await Swal.fire({ icon: 'success', title: 'Registrado', timer: 1500, showConfirmButton: false }); 
                window.location.reload(); 
            } else {
                Swal.fire('Error', error.message, 'error');
            }
        }
    });

    // ==========================================
    // 2. L√ìGICA DE REEMBOLSO
    // ==========================================
    const btnRefund = document.getElementById('btn-refund');
    
    btnRefund?.addEventListener('click', async () => {
        const mainBtn = document.getElementById('btn-register-payment');
        const { patientId, businessId } = mainBtn!.dataset;
        const amount = btnRefund.dataset.amount; 

        const { value: note } = await Swal.fire({
            title: '¬øRealizar Devoluci√≥n?',
            html: `
                <div class="text-left">
                    <p class="text-sm text-gray-600 mb-4">
                        Se registrar√° una salida de dinero por 
                        <b class="text-red-600">${formatCOP(Number(amount))}</b> 
                        para dejar la cuenta en cero.
                    </p>
                    <label class="text-xs font-bold text-gray-500 uppercase">Motivo (Obligatorio)</label>
                    <textarea id="refund-note" class="swal2-textarea m-0 w-full h-24 text-sm" 
                    placeholder="Ej: Devoluci√≥n por tratamiento cancelado..."></textarea>
                </div>
            `,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'S√≠, Devolver Dinero',
            confirmButtonColor: '#2563EB',
            preConfirm: () => {
                const val = (document.getElementById('refund-note') as HTMLTextAreaElement).value;
                if (!val) {
                    Swal.showValidationMessage('Debes escribir un motivo para la devoluci√≥n');
                }
                return val;
            }
        });

        if (note) {
            Swal.fire({ title: 'Procesando...', didOpen: () => Swal.showLoading() });

            try {
                const { error } = await supabase.from('payments').insert({
                    business_id: businessId,
                    patient_id: patientId, 
                    amount: -Math.abs(Number(amount)),
                    payment_method: 'Devoluci√≥n',
                    reference: 'REFUND',
                    notes: note,
                    registered_by: (await supabase.auth.getUser()).data.user?.id
                });

                if (error) throw error;

                await Swal.fire({ icon: 'success', title: 'Devoluci√≥n Registrada', timer: 1500, showConfirmButton: false });
                window.location.reload();

            } catch (err) {
                console.error(err);
                Swal.fire('Error', 'No se pudo registrar la devoluci√≥n', 'error');
            }
        }
    });

    // ==========================================
    // 3. SISTEMA DE FILTROS CON ESTADO DIN√ÅMICO
    // ==========================================
    const filterDescInput = document.getElementById('filter-desc') as HTMLInputElement;
    const filterRefInput = document.getElementById('filter-ref') as HTMLInputElement;
    const filterDateFrom = document.getElementById('filter-date-from') as HTMLInputElement;
    const filterDateTo = document.getElementById('filter-date-to') as HTMLInputElement;
    const btnApply = document.getElementById('btn-apply-filters');
    const btnClear = document.getElementById('btn-clear-filters');
    const filterIndicator = document.getElementById('filter-indicator');
    const filterSummary = document.getElementById('filter-summary');

    function updateDynamicState() {
        const visibleRows = Array.from(document.querySelectorAll('.transaction-row')).filter(
            (row: Element) => (row as HTMLElement).style.display !== 'none'
        );

        let totalCharge = 0;
        let totalPayment = 0;
        let finalBalance = 0;

        visibleRows.forEach((row: Element) => {
            const r = row as HTMLElement;
            totalCharge += Number(r.dataset.charge) || 0;
            totalPayment += Number(r.dataset.payment) || 0;
        });

        // El balance final es el saldo de la √∫ltima fila visible
        if (visibleRows.length > 0) {
            const lastRow = visibleRows[visibleRows.length - 1] as HTMLElement;
            finalBalance = Number(lastRow.dataset.balance) || 0;
        }

        // Actualizar tarjetas
        const displayCost = document.getElementById('display-total-cost');
        const displayPaid = document.getElementById('display-total-paid');
        const displayBalance = document.getElementById('display-balance');
        const displayCount = document.getElementById('display-payments-count');
        const balanceLabel = document.getElementById('balance-label');
        const balanceBar = document.getElementById('balance-bar');

        if (displayCost) displayCost.textContent = formatCOP(totalCharge);
        if (displayPaid) displayPaid.textContent = formatCOP(Math.abs(totalPayment));
        if (displayCount) displayCount.textContent = `${visibleRows.length} movimientos`;
        if (displayBalance) {
            const absBalance = Math.abs(finalBalance);
            displayBalance.textContent = formatCOP(absBalance);
            
            // Actualizar color din√°micamente
            displayBalance.className = 'text-3xl font-extrabold ' + 
                (finalBalance < 0 ? 'text-blue-600' : (finalBalance > 0 ? 'text-red-600' : 'text-emerald-600'));
        }

        if (balanceLabel) {
            balanceLabel.textContent = finalBalance < 0 ? 'Saldo a Favor del Paciente' : 
                                       (finalBalance > 0 ? 'Pendiente por Pagar' : 'Paz y Salvo');
        }

        if (balanceBar) {
            balanceBar.className = 'absolute top-0 left-0 w-1 h-full ' + 
                (finalBalance < 0 ? 'bg-blue-500' : (finalBalance > 0 ? 'bg-red-500' : 'bg-emerald-500'));
        }
    }

    function filterTransactions() {
        const rows = document.querySelectorAll('.transaction-row');
        const descTerm = (filterDescInput?.value || '').toLowerCase();
        const refTerm = (filterRefInput?.value || '').toLowerCase();
        const dateFrom = filterDateFrom?.value || '';
        const dateTo = filterDateTo?.value || '';

        let visibleCount = 0;
        let activeFilters: string[] = [];

        rows.forEach((row) => {
            const r = row as HTMLElement;
            const rowDesc = r.dataset.desc || '';
            const rowRef = r.dataset.ref || '';
            const rowDate = r.dataset.date || '';

            const matchDesc = descTerm === '' || rowDesc.includes(descTerm);
            const matchRef = refTerm === '' || rowRef.includes(refTerm);
            
            // Validar rango de fechas
            let matchDateRange = true;
            if (dateFrom && rowDate < dateFrom) matchDateRange = false;
            if (dateTo && rowDate > dateTo) matchDateRange = false;

            const isVisible = matchDesc && matchRef && matchDateRange;
            r.style.display = isVisible ? '' : 'none';
            
            if (isVisible) visibleCount++;
        });

        // Construir resumen de filtros
        if (descTerm) activeFilters.push(`B√∫squeda: "${descTerm}"`);
        if (refTerm) activeFilters.push(`Ref: "${refTerm}"`);
        if (dateFrom && dateTo) {
            activeFilters.push(`Del ${new Date(dateFrom).toLocaleDateString('es-CO')} al ${new Date(dateTo).toLocaleDateString('es-CO')}`);
        } else if (dateFrom) {
            activeFilters.push(`Desde ${new Date(dateFrom).toLocaleDateString('es-CO')}`);
        } else if (dateTo) {
            activeFilters.push(`Hasta ${new Date(dateTo).toLocaleDateString('es-CO')}`);
        }

        // Mostrar/ocultar indicador
        if (activeFilters.length > 0 && filterIndicator && filterSummary) {
            filterIndicator.classList.remove('hidden');
            filterSummary.textContent = `Mostrando ${visibleCount} de ${rows.length} movimientos: ${activeFilters.join(' ‚Ä¢ ')}`;
        } else if (filterIndicator) {
            filterIndicator.classList.add('hidden');
        }

        // Actualizar estado din√°mico
        updateDynamicState();
    }

    // Event Listeners de filtros
    btnApply?.addEventListener('click', filterTransactions);
    
    filterDescInput?.addEventListener('input', filterTransactions);
    filterRefInput?.addEventListener('input', filterTransactions);

    btnClear?.addEventListener('click', () => {
        if (filterDescInput) filterDescInput.value = '';
        if (filterRefInput) filterRefInput.value = '';
        if (filterDateFrom) filterDateFrom.value = '';
        if (filterDateTo) filterDateTo.value = '';
        filterTransactions();
    });

// ==========================================
// 4. IMPRESI√ìN CON FILTROS ACTIVOS (100% CORREGIDO)
// ==========================================
const printBtn = document.querySelector('button[onclick="window.print()"]');
printBtn?.removeAttribute('onclick'); 
printBtn?.addEventListener('click', async (e) => {
    e.preventDefault();

    // 1. Obtener filas visibles ACTUALES
    const visibleRows = Array.from(document.querySelectorAll('.transaction-row')).filter(
        (row: Element) => (row as HTMLElement).style.display !== 'none'
    );

    if (visibleRows.length === 0) {
        Swal.fire('Sin datos', 'No hay movimientos para imprimir con los filtros actuales', 'info');
        return;
    }

    // Mostrar loading
    Swal.fire({
        title: 'Preparando documento...',
        html: 'Generando PDF con todos los movimientos',
        allowOutsideClick: false,
        didOpen: () => Swal.showLoading()
    });

    // 2. Recalcular totales din√°micamente
    let runningBalance = 0;
    let totalCharge = 0;
    let totalPayment = 0;

    const ledgerRows: any[] = [];

    visibleRows.forEach((row: Element) => {
        const r = row as HTMLElement;
        const charge = Number(r.dataset.charge) || 0;
        const payment = Number(r.dataset.payment) || 0;
        
        runningBalance = runningBalance + charge - payment;
        totalCharge += charge;
        totalPayment += payment;

        const cells = r.querySelectorAll('td');
        const date = cells[0]?.textContent?.trim() || '';
        const description = cells[1]?.textContent?.trim() || '';

        ledgerRows.push({
            date,
            description,
            charge,
            payment,
            balance: runningBalance
        });
    });

    const finalBalance = runningBalance;

    // 3. Obtener datos del paciente (mejorado)
    const mainBtn = document.getElementById('btn-register-payment');
    const patientNameEl = document.querySelector('h1.text-2xl.font-bold.text-gray-900');
    const patientDocEl = document.querySelector('.font-mono.text-xs.px-2.py-0\\.5');
    
    const patientName = patientNameEl?.textContent?.trim() || 'Paciente';
    const patientDoc = patientDocEl?.textContent?.replace('ID:', '').trim() || 'N/A';
    
    const content = document.getElementById('print-statement');
    const businessName = content?.querySelector('.text-3xl')?.nextElementSibling?.textContent || 'Cl√≠nica Dental Sonrisas';
    const businessAddress = content?.querySelector('.grid-cols-2 .font-bold + .text-sm')?.textContent || 'Calle 10 #15-20, Ibagu√©, Tolima';

    // 4. Construir HTML con page-breaks optimizados
    const printHTML = `
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>Estado de Cuenta - ${patientName}</title>
            <script src="https://cdn.tailwindcss.com"><\/script>
            <style>
                * { 
                    margin: 0; 
                    padding: 0; 
                    box-sizing: border-box; 
                }
                
                body { 
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
                    padding: 40px; 
                    margin: 0;
                    background: white;
                }

                /* CR√çTICO: Configuraci√≥n de p√°gina */
                @page {
                    size: letter;
                    margin: 0.5in;
                }

                /* Prevenir cortes en elementos cr√≠ticos */
                .no-break {
                    page-break-inside: avoid !important;
                    break-inside: avoid !important;
                }

                table {
                    width: 100%;
                    border-collapse: collapse;
                    page-break-inside: auto;
                }

                thead {
                    display: table-header-group; /* Repetir header en cada p√°gina */
                }

                tbody {
                    display: table-row-group;
                }

                tr {
                    page-break-inside: avoid !important;
                    break-inside: avoid !important;
                }

                /* Estilos de impresi√≥n */
                @media print {
                    body { 
                        -webkit-print-color-adjust: exact !important; 
                        print-color-adjust: exact !important;
                        background: white !important;
                    }
                    
                    .bg-brand-900 { 
                        background-color: #1e3a8a !important; 
                        color: white !important; 
                    }
                    
                    .text-red-600 { color: #dc2626 !important; }
                    .text-emerald-600 { color: #059669 !important; }
                    .bg-gray-100 { background-color: #f3f4f6 !important; }
                    .bg-gray-50 { background-color: #f9fafb !important; }
                    
                    th, td { 
                        border: 1px solid #d1d5db !important; 
                        padding: 10px !important;
                    }

                    /* Forzar breaks correctos */
                    .header-section {
                        page-break-after: avoid !important;
                    }

                    .summary-section {
                        page-break-before: avoid !important;
                        page-break-after: avoid !important;
                    }

                    .footer-note {
                        page-break-before: avoid !important;
                        margin-top: 20px !important;
                    }
                }

                @media screen {
                    body { 
                        background: #f5f5f5; 
                    }
                    .print-container {
                        max-width: 8.5in;
                        margin: 0 auto;
                        background: white;
                        padding: 40px;
                        box-shadow: 0 0 10px rgba(0,0,0,0.1);
                    }
                }
            </style>
        </head>
        <body>
            <div class="print-container">
                
                <!-- HEADER -->
                <div class="header-section no-break" style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 32px; border-bottom: 2px solid #1e3a8a; padding-bottom: 24px;">
                    <div>
                        <h1 style="font-size: 28px; font-weight: bold; color: #1e3a8a; text-transform: uppercase; letter-spacing: -0.025em; margin: 0;">CUENTA DE COBRO</h1>
                        <p style="font-size: 13px; color: #6b7280; margin-top: 4px; text-transform: uppercase; font-weight: bold; letter-spacing: 0.05em;">${businessName}</p>
                    </div>
                    <div style="text-align: right;">
                        <p style="font-size: 12px; color: #9ca3af; text-transform: uppercase; margin: 0;">Fecha de Emisi√≥n</p>
                        <p style="font-size: 16px; font-weight: bold; margin: 4px 0 0 0;">${new Date().toLocaleDateString('es-CO')}</p>
                    </div>
                </div>

                <!-- INFO -->
                <div class="no-break" style="display: grid; grid-template-columns: 1fr 1fr; gap: 48px; margin-bottom: 32px;">
                    <div>
                        <p style="font-weight: bold; font-size: 16px; margin: 0 0 4px 0;">${businessName}</p>
                        <p style="font-size: 13px; color: #4b5563; margin: 0;">${businessAddress}</p>
                    </div>
                    <div>
                        <p style="font-size: 11px; font-weight: bold; color: #9ca3af; text-transform: uppercase; margin: 0 0 8px 0;">Cliente:</p>
                        <p style="font-weight: bold; font-size: 16px; margin: 0 0 4px 0;">${patientName}</p>
                        <p style="font-size: 13px; color: #4b5563; margin: 0;">ID: ${patientDoc}</p>
                    </div>
                </div>

                <!-- RESUMEN EJECUTIVO -->
                <div class="summary-section no-break" style="display: flex; justify-content: flex-end; margin-bottom: 32px;">
                    <table style="width: 50%; border-collapse: collapse;">
                        <tr style="background-color: #1e3a8a; color: white;">
                            <td style="padding: 12px; font-size: 13px; font-weight: bold; text-transform: uppercase; border: 1px solid #1e3a8a;">Saldo Adeudado</td>
                            <td style="padding: 12px; text-align: right; font-weight: bold; font-size: 16px; border: 1px solid #1e3a8a;">${formatCOP(finalBalance)}</td>
                        </tr>
                        <tr style="background-color: #f3f4f6;">
                            <td style="padding: 12px; font-size: 11px; font-weight: bold; color: #6b7280; text-transform: uppercase; border: 1px solid #d1d5db;">Monto total plan</td>
                            <td style="padding: 12px; text-align: right; font-weight: 500; font-size: 13px; border: 1px solid #d1d5db;">${formatCOP(totalCharge)}</td>
                        </tr>
                    </table>
                </div>

                <!-- TABLA DE ACTIVIDAD -->
                <div style="margin-bottom: 24px;">
                    <h3 style="background-color: #1e3a8a; color: white; padding: 10px 16px; font-size: 13px; font-weight: bold; text-transform: uppercase; letter-spacing: 0.05em; margin: 0 0 0 0;">Actividad de la Cuenta</h3>
                    <table style="width: 100%; font-size: 13px; border: 1px solid #d1d5db;">
                        <thead>
                            <tr style="background-color: #f3f4f6; color: #4b5563;">
                                <th style="padding: 10px; text-align: left; border: 1px solid #d1d5db; font-weight: 600;">Fecha</th>
                                <th style="padding: 10px; text-align: left; border: 1px solid #d1d5db; width: 40%; font-weight: 600;">Descripci√≥n</th>
                                <th style="padding: 10px; text-align: right; border: 1px solid #d1d5db; font-weight: 600;">Cargo</th>
                                <th style="padding: 10px; text-align: right; border: 1px solid #d1d5db; font-weight: 600;">Abono</th>
                                <th style="padding: 10px; text-align: right; border: 1px solid #d1d5db; font-weight: 600;">Balance</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${ledgerRows.map((t, index) => `
                                <tr style="${index % 2 === 1 ? 'background-color: #f9fafb;' : 'background-color: white;'}">
                                    <td style="padding: 10px; border: 1px solid #e5e7eb; font-family: monospace; font-size: 11px; white-space: nowrap;">${t.date}</td>
                                    <td style="padding: 10px; border: 1px solid #e5e7eb; font-size: 12px;">${t.description}</td>
                                    <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: right; font-size: 12px; white-space: nowrap;">${t.charge > 0 ? formatCOP(t.charge) : '-'}</td>
                                    <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: right; font-size: 12px; white-space: nowrap;">${Math.abs(t.payment) > 0 ? formatCOP(Math.abs(t.payment)) : '-'}</td>
                                    <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: right; font-weight: 600; background-color: rgba(249, 250, 251, 0.5); font-size: 12px; white-space: nowrap;">${formatCOP(t.balance)}</td>
                                </tr>
                            `).join('')}
                            
                            <tr style="background-color: #1e3a8a; color: white; font-weight: bold;">
                                <td colspan="4" style="padding: 12px; text-align: right; text-transform: uppercase; font-size: 12px; border: 1px solid #1e3a8a;">Saldo Total a Pagar</td>
                                <td style="padding: 12px; text-align: right; font-size: 14px; border: 1px solid #1e3a8a;">${formatCOP(finalBalance)}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                ${visibleRows.length < document.querySelectorAll('.transaction-row').length ? `
                    <div class="footer-note no-break" style="background-color: #fef3c7; border: 2px solid #fbbf24; border-radius: 8px; padding: 12px; margin-top: 24px; font-size: 11px; color: #92400e;">
                        <strong>‚ö†Ô∏è Nota:</strong> Este reporte muestra <strong>${visibleRows.length}</strong> de <strong>${document.querySelectorAll('.transaction-row').length}</strong> movimientos totales (filtros aplicados).
                    </div>
                ` : ''}
            </div>
        </body>
        </html>
    `;

    // 5. Crear iframe optimizado
    const iframe = document.createElement('iframe');
    iframe.style.cssText = 'position: fixed; right: 0; bottom: 0; width: 0; height: 0; border: 0; opacity: 0;';
    document.body.appendChild(iframe);

    const iframeDoc = iframe.contentWindow?.document;
    if (!iframeDoc) {
        Swal.fire('Error', 'No se pudo generar el documento', 'error');
        return;
    }

    // 6. Escribir contenido y esperar carga COMPLETA
    iframeDoc.open();
    iframeDoc.write(printHTML);
    iframeDoc.close();

    // üî• CR√çTICO: Esperar a que TODO se cargue
    await new Promise<void>((resolve) => {
        if (iframe.contentWindow) {
            // Esperar evento load del iframe
            iframe.contentWindow.addEventListener('load', () => {
                // Esperar un frame adicional para que Tailwind compile
                requestAnimationFrame(() => {
                    setTimeout(() => resolve(), 300);
                });
            });

            // Fallback si no dispara load
            setTimeout(() => resolve(), 2000);
        } else {
            resolve();
        }
    });

    // 7. Cerrar loading
    Swal.close();

    // 8. Enfocar iframe y abrir di√°logo de impresi√≥n
    try {
        iframe.contentWindow?.focus();
        iframe.contentWindow?.print();

        // 9. Cleanup despu√©s de un tiempo prudente
        setTimeout(() => {
            if (document.body.contains(iframe)) {
                document.body.removeChild(iframe);
            }
        }, 2000);

    } catch (error) {
        console.error('Error al imprimir:', error);
        Swal.fire('Error', 'No se pudo abrir el di√°logo de impresi√≥n', 'error');
        if (document.body.contains(iframe)) {
            document.body.removeChild(iframe);
        }
    }
});

    // Inicializar estado al cargar
    updateDynamicState();
</script>

<style>
  /* No styles needed here */
</style>